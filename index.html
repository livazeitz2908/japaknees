<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>QuizCards – Komplett (Single‑File, inline CSS & JS)</title>
  <audio id="ding" preload="auto" playsinline></audio>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>

#chatRecordBtn {
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  touch-action: none;
}
#chatRecordBtn {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}
.write-pad { gap:.5rem; display:grid; }
.write-pad-controls { display:flex; gap:.5rem; align-items:center; }
.write-pad-stage {
  position: relative;
  width: 100%;
  max-width: 1000px;
  aspect-ratio: 4/2;
  border: 1px solid #444;
  border-radius: 12px;
  overflow: hidden;
}
.write-pad-stage canvas, .write-pad-stage #writeHint {
  position:absolute; inset:0; width:100%; height:100%;
}
.write-pad-stage #writeHint {
  display: grid;
  place-items: center;
  color: #666;

  /* Dynamisch mit Pad-Breite skalieren, 
     aber auf sinnvolle Grenzen beschränken */
  font-size: clamp(48px, 20cqw, 140px);

  pointer-events: none;
  user-select: none;
  line-height: 1;
}
#writeCanvas { touch-action:none; /* wichtig für iOS */ }
.write-pad button { background:#2a2a2a; border:1px solid #444; border-radius:8px; padding:.4rem .6rem; }
.write-pad button:active { transform: translateY(1px); }

/* Zwei Spalten: links Pad, rechts Prompt – bricht erst sehr spät um */
.write-layout{
  display:grid;
  grid-template-columns: minmax(420px, 1fr) minmax(320px, 440px);
  gap: 20px;
  align-items: start;
}

/* Falls globale Styles .card o.ä. absolut positionieren: neutralisieren */
#write-prompt{ position: static !important; }

/* Optional: Toolbar in einer Reihe halten (Buttons etc.) */
.write-toolbar{
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  flex-wrap: nowrap;        /* kein Zeilenumbruch */
  min-width: 0;
}

/* Nur auf sehr kleinen Screens unter 720px umbrochen */
@media (max-width: 720px){
  .write-layout{ grid-template-columns: 1fr; }
  .write-toolbar{ flex-wrap: wrap; }
}

/* hübsch, aber optional: rechte Box soll Inhalte zeigen, auch wenn leer */
#write-prompt #wp-big:empty::after{
  content: "—";
  opacity: .25;
}


:root {
  --gap: .75rem;
  --bg-dark: #1e1e1e; /* dunkles Grau */
  --bg-light: #2a2a2a; /* leicht helleres Grau */
  --lavender: #c8a8e8; /* sanfter, hellerer Lavendel */
  --white: #f5f5f5;
  --nav-offset-mobile: 64px; /* Höhe der Mobile-Navbar für Body-Offset */
}

/* Fluid Typo für bessere Lesbarkeit auf Phones */
html { font-size: clamp(15px, 1.6vw + 0.5rem, 18px); }

* { box-sizing: border-box; }

body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  margin: 0;
  padding: 1.5rem;
  padding-left: calc(1.5rem + env(safe-area-inset-left));
  padding-right: calc(1.5rem + env(safe-area-inset-right));
  padding-top: calc(1.25rem + env(safe-area-inset-top));
  padding-bottom: calc(1.25rem + env(safe-area-inset-bottom));
  line-height: 1.5;
  background: var(--bg-dark);
  color: var(--white);
}

nav {
  display: flex;
  flex-wrap: wrap;
  gap: var(--gap);
  align-items: center;
  margin-bottom: 1rem;
}

button,
.import-label {
  padding: .5rem .8rem;
  background: var(--bg-light);
  border: none;
  border-radius: .5rem;
  cursor: pointer;
  color: var(--white);
}
button:hover,
.import-label:hover { background: #3a3a3a; }

button.primary {
  background: var(--lavender);
  color: var(--bg-dark);
}
button.primary:hover { filter: brightness(1.1); }

.import-label { display: inline-flex; align-items: center; gap: .25rem; }

#search {
  padding: .5rem .6rem;
  border: none;
  border-radius: .5rem;
  min-width: 220px;
  background: var(--bg-light);
  color: var(--white);
}

#app { min-height: 60vh; }

.card {
  padding: 1rem;
  border-radius: .6rem;
  margin: .5rem 0;
  background: var(--bg-light);
  color: var(--white);
}
.card h3 { margin: 0 0 .5rem; color: var(--lavender); }

input,
textarea {
  width: 100%;
  padding: .6rem .7rem;
  border: none;
  border-radius: .5rem;
  background: var(--bg-light);
  color: var(--white);
}

label {
  display: block;
  margin: .25rem 0;
  font-size: .9rem;
  color: var(--lavender);
}

form { display: grid; gap: .5rem; margin: .5rem 0 1rem; }

footer { margin-top: 2rem; color: #aaa; }

.actions { display: flex; gap: .5rem; flex-wrap: wrap; }

.grid {
  display: grid;
  gap: .75rem;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}

.badge {
  display: inline-block;
  font-size: .8rem;
  padding: .1rem .5rem;
  border-radius: .5rem;
  background: #3a3a3a;
  color: var(--lavender);
}

hr { border: 0; border-top: 1px solid #444; margin: 1rem 0; }

.match-board { display: grid; grid-template-columns: repeat(2, 1fr); gap: .75rem; }
.match-col { display: grid; gap: .5rem; }

.match-item {
  padding: .6rem .7rem;
  border-radius: .6rem;
  background: var(--bg-light);
  cursor: pointer;
  text-align: left;
  color: var(--white);
}
.match-item.selected { outline: 2px solid var(--lavender); background: #4b3b63; }

.timer { font-variant-numeric: tabular-nums; font-weight: 600; color: var(--lavender); }

.spell-input {
  width: 100%;
  padding: .6rem;
  border: none;
  border-radius: .5rem;
  background: var(--bg-light);
  color: var(--white);
}

.hint { color: #aaa; font-size: .9rem; }

button.danger { background: #5a2a2a; color: #ffcccc; border: none; }
button.danger:hover { filter: brightness(1.05); }

/* Glass-Effect & mittiger weicher Lavendel-Schatten */
.card,
.match-item,
.badge {
  background: rgba(42, 42, 42, 0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: 0 0 20px rgba(200, 168, 232, 0.18);
  border: none;
  transition: box-shadow 0.3s ease, transform 0.3s ease;
}
.card:hover,
.match-item:hover { box-shadow: 0 0 28px rgba(200, 168, 232, 0.25); transform: translateY(-2px); }

/* ===== Responsive Portrait Phones ===== */
@media (max-width: 400px) {
  body { padding: 1rem; padding-top: calc(1rem + env(safe-area-inset-top)); }
  nav { gap: .5rem; }
  .grid { grid-template-columns: 1fr; gap: .6rem; }
  .match-board { grid-template-columns: 1fr; }
  button, .import-label, input, textarea, #search { width: 100%; }
  .card { padding: .9rem; }
  .card, .match-item, .badge { box-shadow: 0 0 16px rgba(200,168,232,0.16); }
  .card:hover, .match-item:hover { box-shadow: 0 0 22px rgba(200,168,232,0.22); transform: translateY(-1px); }
}

@media (min-width: 401px) and (max-width: 430px) {
  .grid { grid-template-columns: 1fr; }
  .match-board { grid-template-columns: 1fr; }
  button, .import-label { min-height: 44px; }
}

@media (min-width: 431px) and (max-width: 480px) {
  .grid { grid-template-columns: repeat(2, minmax(200px, 1fr)); }
  .match-board { grid-template-columns: repeat(2, 1fr); }
}


/* Burger-Button – Standard: versteckt, nur auf Mobile sichtbar */
.nav-toggle {
  display: none;
  position: fixed;
  z-index: 1100;
  top: calc(8px + env(safe-area-inset-top));
  left: calc(10px + env(safe-area-inset-left));
  padding: .45rem .8rem;
  border-radius: .75rem;
  background: rgba(42,42,42,0.95);
  border: 1px solid #444;
  color: var(--white);
  font-size: .95rem;
  gap: .35rem;
  align-items: center;
}
    
/* ===== Mobile Navbar: fixed + centered + compact ===== */
@media (max-width: 600px) {

  /* Etwas Platz nach oben, weil die Navigation nun einklappbar ist */
  body {
    padding-top: calc(3.2rem + env(safe-area-inset-top));
  }

  /* Burger-Button jetzt sichtbar */
  .nav-toggle {
    display: inline-flex;
  }

  /* Navigation als ausklappbares Panel */
  nav {
    position: fixed;
    top: calc(3rem + env(safe-area-inset-top));
    left: 0;
    right: 0;
    z-index: 1000;

    background: rgba(42, 42, 42, 0.98);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);

    padding: .6rem calc(10px + env(safe-area-inset-right));
    padding-left: calc(10px + env(safe-area-inset-left));
    border-radius: 0 0 .75rem .75rem;
    border-bottom: 1px solid #333;
    box-shadow: 0 8px 20px rgba(0,0,0,.6);

    display: flex;
    flex-wrap: wrap;
    gap: .4rem;
    justify-content: flex-start;

    /* Burger-Effekt */
    max-height: 0;
    overflow: hidden;
    transition: max-height .25s ease;
  }

  /* Wenn body die Klasse nav-open hat → Menü ist aufgeklappt */
  body.nav-open nav {
    max-height: 280px; /* ggf. nach Geschmack anpassen */
  }

  nav button,
  nav .import-label,
  nav #search {
    font-size: 0.95em;
    padding: .45rem .6rem;
    min-height: 40px;
    width: auto;
    text-align: center;
    justify-content: center;
  }
}


/* Touch-Optimierungen */
@media (hover: none) {
  .card:hover, .match-item:hover { transform: none; }
  nav *:hover { filter: none; }
}

/* Reduzierte Bewegung */
@media (prefers-reduced-motion: reduce) {
  * { transition: none !important; }
}

button.mini{ padding:.2rem .4rem; font-size:.9em; }


/* === Android/Tablet generelle Fixes === */

/* 2.1: Verhindert Font-Boost/Zoom auf Inputs (wir halten >=16px ohnehin ein) */
input, textarea, button { font-size: 1rem; }

/* 2.2: Finger-Zieltgröße: mind. ~48dp */
button, .import-label, input, textarea {
  min-height: 48px;
}

/* 2.3: Tap-Highlight neutralisieren & schnelleres Tap-Verhalten */
* { -webkit-tap-highlight-color: transparent; }
button, a, .match-item { touch-action: manipulation; }

/* 2.4: Dynamische Viewport-Höhe bei Android-URL-Bar (statt 100vh) */
html, body { min-height: 100dvh; }

/* 2.5: Tablet-Layout (600–1024px): mehr Platz nutzen, größere Grids */
@media (min-width: 600px) and (max-width: 1024px) {
  .grid { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
  .match-board { grid-template-columns: repeat(2, 1fr); }
  nav { justify-content: flex-start; }
}

/* 2.6: Großes Tablet/Small Desktop (>1024px): luftiger */
@media (min-width: 1025px) {
  .grid { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
}

/* 2.7: Progressbar (falls für Levels genutzt) */
.progress { height: 10px; background: #3a3a3a; border-radius: 999px; overflow: hidden; margin-top: .35rem; }
.progress > div { height: 100%; width: 0%; background: var(--lavender); transition: width .3s ease; }

/* 2.8: Tablet-optimierte Navbar-Paddings */
@media (min-width: 600px) and (max-width: 1024px) {
  nav button, nav .import-label, nav #search {
    padding: .6rem .8rem;
    min-height: 44px;
  }
}

/* iOS: 100vh → Adressleisten-Probleme, daher 100svh */
:root { --app-h: 100svh; }
.app, body, html { height: var(--app-h); min-height: var(--app-h); }
button, a { touch-action: manipulation; } /* kein 300ms-Delay */

.level-card h3 { margin-bottom: .25rem; }

.msg.trans {
  align-self: center;
  max-width: 520px;
  font-size: .95rem;
  line-height: 1.45;
  background: rgba(42,42,42,.7);
  border-left: 4px solid var(--lavender);
  padding: .6rem .8rem;
  border-radius: .6rem;
  margin: .35rem 0 .5rem;
  color: var(--white);
}
.msg.trans .tline { display:block; opacity:.95; }
.msg.trans .tline + .tline { margin-top:.25rem; opacity:.85; }
.chat .opt[disabled] { opacity:.6; pointer-events:none; }

#writeCanvas {
  display: block;
  width: 100%;
  height: 100%;
  background: #111;
  cursor: crosshair;
  touch-action: none;
}

/* --- Aufnahme-Button Grundstil (bestehenden Stil überschreibt das nicht, erweitert nur) --- */
#speakBtn {
  transition: all 0.15s ease;
  position: relative;
  overflow: hidden;
}

/* --- Aktiv-Zustand beim Aufnehmen --- */
#speakBtn.recording {
  background: #d92c2c !important; /* kräftiges Rot */
  color: white !important;
  border-color: #ffb3b3 !important;
  box-shadow: 0 0 12px rgba(255, 80, 80, 0.8);

  /* kleiner „Pulse“-Effekt */
  animation: micPulse 1.1s infinite ease-in-out;
}

/* --- Pulse-Animation --- */
@keyframes micPulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.07); }
  100% { transform: scale(1); }
}

/* Mikrofon-Icon färben, falls du eins nutzt */
#speakBtn.recording .mic-icon {
  filter: brightness(200%);
}

#chatRecordBtn.recording {
  background: #c62828 !important;
  color: #fff !important;
  transform: scale(0.94);
  box-shadow: 0 0 10px rgba(255, 60, 60, 0.5);
  transition: all .12s ease-out;
}


    
  </style>

  
  <!-- SheetJS for optional XLSX/CSV import -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <meta name="theme-color" content="#1e1e1e" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="color-scheme" content="dark light">
</head>
<body>
  <!-- Burger-Button nur für kleine Screens sichtbar -->
  <button id="navToggle" class="nav-toggle" type="button" aria-label="Navigation öffnen/schließen">
    ☰ Menü
  </button>

  <nav>
    <button data-route="home">Start</button>
    <button data-route="new-set">Neues Set</button>
    <button data-route="stats">Statistik</button>
    <button data-route="stories">Lesegeschichten</button>
    <button data-route="levels">Level-Modus</button>
    <button data-route="chats">Chats</button>
    <button data-route="write">Schreibübung</button>
    <button data-route="grammar">Grammatik</button>
    <button id="exportBtn">Export</button>
    <label class="import-label">
      Import
      <input type="file" id="importFile" accept="application/json,.csv,.xlsx,.xls" hidden />
    </label>
    <button id="resetBtn" class="danger" title="Alle lokalen Daten löschen und Seeds neu anlegen">Zurücksetzen</button>
    <input id="search" placeholder="Sets suchen..." />
  </nav>

  <main id="app"></main>

  <footer>
    <small>QuizCards • Lern-/Quiz-/Match-/Buchstabieren • Seed‑Merge • Genki‑Import (3rd Ed)</small>
  </footer>

  <script>


// --- Polyfill: String.prototype.replaceAll (very old WebViews) ---
if (!String.prototype.replaceAll){
  // naive fallback
  String.prototype.replaceAll = function(find, replace){
    return this.split(find).join(replace);
  };
}

// --- Polyfill: crypto.randomUUID (für ältere Browser/offline) ---
(function(){
  try {
    if (!globalThis.crypto) globalThis.crypto = {};
    if (typeof globalThis.crypto.randomUUID !== 'function') {
      globalThis.crypto.randomUUID = function(){
        // einfacher, ausreichend eindeutiger Fallback
        const s4 = () => Math.floor((1+Math.random())*0x10000).toString(16).slice(1);
        return 'id-' + Date.now().toString(36) + '-' +
          s4()+s4() + '-' + s4() + '-' + s4() + '-' + s4()+s4()+s4();
      };
    }
  } catch(e) {}
})();

// QuizCards – Komplett: Seeds + Learn/Quiz/Match + Buchstabieren + Genki‑Import
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

// -------- Routing --------
const state = { route: "home", sets: [], search: "" };

// Navigation-Buttons (Routen) + Burger-Menü
$$("nav [data-route]").forEach(b => b.addEventListener("click", () => {
  goto(b.dataset.route);
  // Auf Mobile das Menü nach Klick wieder zuklappen
  document.body.classList.remove("nav-open");
}));

// Burger-Button für Mobile
const navToggle = $("#navToggle");
if (navToggle) {
  navToggle.addEventListener("click", () => {
    document.body.classList.toggle("nav-open");
  });
}

// Suche
$("#search").addEventListener("input", (e) => {
  state.search = e.target.value.toLowerCase();
  render();
});

function goto(route){
  state.route = route;
  render();
}


// -------- Storage (Migration + Merge) --------
const STORAGE_KEY_V2 = "quizcards_sets_v2";
const STORAGE_KEY_V1 = "quizcards_sets";

// ===== Level-System =====
const LEVELS_KEY   = "quizcards_levels_v1";
const PROGRESS_KEY = "quizcards_progress_v1";
// --- Safe localStorage helpers (avoid SecurityError in restricted contexts) ---
function lsGet(key){
  try { return localStorage.getItem(key); } catch(e){ return null; }
}
function lsSet(key, val){
  try { localStorage.setItem(key, val); return true; } catch(e){ return false; }
}

const GRAMMAR_KEY = "quizcards_grammar_v1";
function loadGrammar(){
  try { return JSON.parse(localStorage.getItem(GRAMMAR_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveGrammar(arr){
  try { localStorage.setItem(GRAMMAR_KEY, JSON.stringify(arr || [])); } catch(e){}
}

// ===== Zusatz-Übungen für Genki 0 / 1 / 2 =====

// Genki 0: ids aus Genki_0_Grammatik.json
// g0-01-desu, g0-02-ka, g0-03-no, g0-04-kore-sore-are, g0-05-koko-soko-asoko

const GRAMMAR_EXERCISES_GENKI_0 = {
  "g0-01-desu": [
    {
      type: "fill",
      prompt_ja: "わたしはがくせい＿＿。",
      prompt_de: "Setze die höfliche Form von „sein“ ein.",
      solution: "です",
      explanation_de: "Kopula ～です."
    },
    {
      type: "fill",
      prompt_ja: "メアリーさんはせんせい＿＿か。",
      prompt_de: "Mache daraus eine höfliche Frage.",
      solution: "です",
      explanation_de: "A は B ですか."
    },
    {
      type: "mc",
      prompt_ja: "„Ich bin Student.“ auf Japanisch:",
      prompt_de: "Wähle den richtigen Satz.",
      options_ja: ["わたしはがくせいです。", "わたしががくせい。", "わたしはがくせいか。"],
      correctIndex: 0,
      explanation_de: "Höflicher Aussagesatz endet auf です。"
    },
    {
      type: "mc",
      prompt_ja: "わたしはにほんじん＿＿ありません。",
      prompt_de: "Welche Form macht die Negation korrekt?",
      options_ja: ["は", "が", "では", "を"],
      correctIndex: 2,
      explanation_de: "Negation: A は B ではありません。"
    }
  ],
  "g0-02-ka": [
    {
      type: "fill",
      prompt_ja: "これはペンです＿＿。",
      prompt_de: "Mache daraus eine Frage.",
      solution: "か",
      explanation_de: "Fragepartikel か steht am Satzende."
    },
    {
      type: "fill",
      prompt_ja: "せんこうはなんです＿＿。",
      prompt_de: "Frage nach dem Hauptfach formulieren.",
      solution: "か",
      explanation_de: "～は なんですか。"
    },
    {
      type: "mc",
      prompt_ja: "Welcher Satz ist korrekt?",
      prompt_de: "Frage: „Was ist das?“",
      options_ja: [
        "これはなんです。",
        "これはなんですか。",
        "これはなんか。"
      ],
      correctIndex: 1,
      explanation_de: "Höfliche Frage: ～ですか。"
    },
    {
      type: "mc",
      prompt_ja: "どれが eine vollständige Frage ist?",
      prompt_de: "Wähle einen vollständigen Fragesatz.",
      options_ja: [
        "にほんごはむずかしいです。",
        "にほんごはなんです。",
        "にほんごはむずかしいですか。"
      ],
      correctIndex: 2
    }
  ],
  "g0-03-no": [
    {
      type: "fill",
      prompt_ja: "たけしさん＿＿ほんです。",
      prompt_de: "Setze die Partikel für Besitz ein.",
      solution: "の",
      explanation_de: "A の B = B von A."
    },
    {
      type: "fill",
      prompt_ja: "メアリーさん＿＿せんこうはにほんごです。",
      prompt_de: "Ausdrücken: „Marys Hauptfach ist Japanisch.“",
      solution: "の"
    },
    {
      type: "mc",
      prompt_ja: "これはだれ＿＿ペンですか。",
      prompt_de: "Welche Partikel drückt Besitz aus?",
      options_ja: ["は", "の", "が", "を"],
      correctIndex: 1
    },
    {
      type: "mc",
      prompt_ja: "にほん＿＿アニメがすきです。",
      prompt_de: "Wie sagst du „japanischer Anime“?",
      options_ja: ["は", "に", "の", "を"],
      correctIndex: 2,
      explanation_de: "日本のアニメ = Anime aus Japan."
    }
  ],
  "g0-04-kore-sore-are": [
    {
      type: "fill",
      prompt_ja: "（beim Sprecher）＿＿はほんです。",
      prompt_de: "„Das hier ist ein Buch.“",
      solution: "これは"
    },
    {
      type: "fill",
      prompt_ja: "（weit weg）＿＿はがっこうです。",
      prompt_de: "„Dort drüben ist die Schule.“",
      solution: "あれは"
    },
    {
      type: "mc",
      prompt_ja: "„Das da bei dir ist ein Buch.“",
      prompt_de: "Wähle die passende Variante.",
      options_ja: [
        "これはほんです。",
        "それはほんです。",
        "あれはほんです。"
      ],
      correctIndex: 1
    },
    {
      type: "mc",
      prompt_ja: "Welche Form bedeutet „jene Sache dort“?",
      options_ja: ["これ", "それ", "あれ", "どれ"],
      correctIndex: 2
    }
  ],
  "g0-05-koko-soko-asoko": [
    {
      type: "fill",
      prompt_ja: "がっこうはどこですか。＿＿です。（hier beim Sprecher）",
      solution: "ここ",
      prompt_de: "Antwort: „Hier.“"
    },
    {
      type: "fill",
      prompt_ja: "トイレは＿＿です。（da beim Hörer）",
      solution: "そこ",
      prompt_de: "„Die Toilette ist da bei dir.“"
    },
    {
      type: "mc",
      prompt_ja: "„Die Bibliothek ist dort drüben.“",
      options_ja: [
        "としょかんはここです。",
        "としょかんはそこです。",
        "としょかんはあそこです。"
      ],
      correctIndex: 2
    },
    {
      type: "mc",
      prompt_ja: "Welches Wort bedeutet „wo?“ (Ort)?",
      options_ja: ["どこ", "どれ", "なに"],
      correctIndex: 0
    }
  ]
};

// Genki 1: ids aus Genki_1_Grammatik.json
// g1-01-wa, g1-02-time, g1-03-questions, g1-04-negation-desu
const GRAMMAR_EXERCISES_GENKI_1 = {
  "g1-01-wa": [
    {
      type: "fill",
      prompt_ja: "わたし＿＿がくせいです。",
      solution: "は",
      prompt_de: "Thema „ich“ markieren."
    },
    {
      type: "fill",
      prompt_ja: "メアリーさん＿＿にほんじんです。",
      solution: "は"
    },
    {
      type: "mc",
      prompt_ja: "Welcher Satz benutzt は korrekt?",
      options_ja: [
        "がくせいはわたしです。",
        "わたしはがくせいです。",
        "わたしががくせいは。"
      ],
      correctIndex: 1
    },
    {
      type: "mc",
      prompt_ja: "Thema des Satzes markieren: „Dieses Buch ist interessant.“",
      options_ja: [
        "ほんがおもしろいです。",
        "このほんはおもしろいです。",
        "このほんがおもしろいは。"
      ],
      correctIndex: 1
    },
    {
      type: "fill",
      prompt_ja: "にほんご＿＿むずかしいです。",
      solution: "は"
    },
    {
      type: "fill",
      prompt_ja: "きょう＿＿あついです。",
      solution: "は"
    },
    {
      type: "mc",
      prompt_ja: "Welches ist eine natürliche Satzstruktur?",
      options_ja: [
        "きょうはさむいです。",
        "さむいきょうはです。",
        "きょうさむいはです。"
      ],
      correctIndex: 0
    },
    {
      type: "mc",
      prompt_ja: "Thema: „Marys Hauptfach ist Japanisch.“",
      options_ja: [
        "メアリーさんがせんこうはにほんごです。",
        "メアリーさんのせんこうはにほんごです。",
        "メアリーさんのせんこうがにほんごです。"
      ],
      correctIndex: 1
    }
  ],
  "g1-02-time": [
    {
      type: "fill",
      prompt_ja: "いま＿＿じです。（9 Uhr）",
      solution: "く",
      prompt_de: "9 Uhr = くじ"
    },
    {
      type: "fill",
      prompt_ja: "クラスはごご３＿＿です。",
      solution: "じ",
      prompt_de: "3 Uhr nachmittags."
    },
    {
      type: "fill",
      prompt_ja: "まいあさ７じ＿＿３０ぷんにおきます。",
      solution: "は",
      prompt_de: "7:30 = ７じ３０ぷん"
    },
    {
      type: "mc",
      prompt_ja: "„Es ist jetzt halb drei.“",
      options_ja: [
        "いまは２じはんです。",
        "いまは３じはんです。",
        "いまは２じ３０ぷんです。"
      ],
      correctIndex: 0
    },
    {
      type: "mc",
      prompt_ja: "Die Klasse beginnt um 10:15.",
      options_ja: [
        "クラスは１０じ１５ぷんです。",
        "クラスは１０じじゅうごぷんです。",
        "Beide sind möglich."
      ],
      correctIndex: 2
    },
    {
      type: "fill",
      prompt_ja: "アルバイトはごご５じ＿＿９じまでです。",
      solution: "から"
    },
    {
      type: "mc",
      prompt_ja: "Wie fragst du „Wie spät ist es jetzt?“",
      options_ja: [
        "いまはなんですか。",
        "いまはなんじですか。",
        "いまはどこですか。"
      ],
      correctIndex: 1
    }
  ],
  "g1-03-questions": [
    {
      type: "fill",
      prompt_ja: "これは＿＿ですか。（Was ist das?）",
      solution: "なん"
    },
    {
      type: "fill",
      prompt_ja: "トイレは＿＿ですか。（Wo ist die Toilette?）",
      solution: "どこ"
    },
    {
      type: "fill",
      prompt_ja: "あの人は＿＿ですか。（Wer ist diese Person?）",
      solution: "だれ"
    },
    {
      type: "mc",
      prompt_ja: "Welcher Satz bedeutet „Wer ist Mary?“",
      options_ja: [
        "メアリーさんはだれですか。",
        "だれはメアリーさんですか。",
        "メアリーさんがだれですか。"
      ],
      correctIndex: 0
    },
    {
      type: "mc",
      prompt_ja: "Frage nach dem Ort: „Wo ist die Bibliothek?“",
      options_ja: [
        "としょかんはどこですか。",
        "としょかんはなにですか。",
        "どれはとしょかんですか。"
      ],
      correctIndex: 0
    },
    {
      type: "fill",
      prompt_ja: "いま＿＿じですか。（Wie viel Uhr ist es jetzt?）",
      solution: "なん"
    },
    {
      type: "mc",
      prompt_ja: "Welche Frage passt zu „Ich bin Student.“?",
      options_ja: [
        "なんですか。",
        "だれですか。",
        "がくせいですか。"
      ],
      correctIndex: 2
    }
  ],
  "g1-04-negation-desu": [
    {
      type: "fill",
      prompt_ja: "わたしはせんせい＿＿ありません。",
      solution: "では",
      prompt_de: "Höfliche Negation von です."
    },
    {
      type: "fill",
      prompt_ja: "メアリーさんはにほんじん＿＿ないです。",
      solution: "じゃ",
      prompt_de: "Informelle Negation."
    },
    {
      type: "mc",
      prompt_ja: "Welche Form ist höflich?",
      options_ja: [
        "ではありません",
        "じゃない",
        "じゃないよ"
      ],
      correctIndex: 0
    },
    {
      type: "mc",
      prompt_ja: "„Ich bin kein Student.“",
      options_ja: [
        "わたしはがくせいです。",
        "わたしはがくせいではありません。",
        "わたしはがくせいじゃないですか。"
      ],
      correctIndex: 1
    },
    {
      type: "fill",
      prompt_ja: "きょうはにちようび＿＿ありません。",
      solution: "では"
    },
    {
      type: "fill",
      prompt_ja: "ここはカフェ＿＿ないです。（informell）",
      solution: "じゃ"
    },
    {
      type: "mc",
      prompt_ja: "Welche Negation passt zu höflicher Sprache?",
      options_ja: [
        "じゃないです",
        "ではありません",
        "じゃない"
      ],
      correctIndex: 1
    },
    {
      type: "mc",
      prompt_ja: "„Das ist kein Buch.“",
      options_ja: [
        "これはほんです。",
        "これはほんではありません。",
        "これはほんじゃないか。"
      ],
      correctIndex: 1
    }
  ]
};

// Genki 2: ids aus Genki_2_Grammatik.json
// g2-01-kore-dore, g2-02-aru-iru, g2-03-mo-to, g2-04-price
const GRAMMAR_EXERCISES_GENKI_2 = {
  "g2-01-kore-dore": [
    {
      type: "fill",
      prompt_ja: "＿＿はいくらですか。（dieses Ding hier）",
      solution: "これは"
    },
    {
      type: "fill",
      prompt_ja: "りんごは＿＿ですか。（Welcher Apfel? → welches von mehreren）",
      solution: "どれ",
      prompt_de: "どれ = welches (von mehreren Dingen)."
    },
    {
      type: "fill",
      prompt_ja: "＿＿ペンがあなたのペンですか。（どの + Nomen）",
      solution: "どの"
    },
    {
      type: "mc",
      prompt_ja: "„Welches Buch ist Marys?“",
      options_ja: [
        "どれがメアリーさんのほんですか。",
        "どのがメアリーさんのほんですか。",
        "どれはメアリーさんのほんですか。"
      ],
      correctIndex: 0
    },
    {
      type: "mc",
      prompt_ja: "Richtig für „Dieses Buch ist teuer.“",
      options_ja: [
        "このほんはたかいです。",
        "これほんはたかいです。",
        "どのほんはたかいです。"
      ],
      correctIndex: 0
    },
    {
      type: "fill",
      prompt_ja: "＿＿えんぴつがいちばんやすいですか。（Welcher Bleistift ist am billigsten?）",
      solution: "どの"
    },
    {
      type: "mc",
      prompt_ja: "„Das da bei dir“ → ?",
      options_ja: ["これ", "それ", "あれ"],
      correctIndex: 1
    },
    {
      type: "mc",
      prompt_ja: "„jenes dort drüben“ → ?",
      options_ja: ["これ", "それ", "あれ"],
      correctIndex: 2
    }
  ],
  "g2-02-aru-iru": [
    {
      type: "fill",
      prompt_ja: "つくえのうえにほんが＿＿。",
      solution: "あります",
      prompt_de: "Buch = unbelebtes Ding → あります"
    },
    {
      type: "fill",
      prompt_ja: "あそこにねこが＿＿。",
      solution: "います",
      prompt_de: "Lebewesen → います"
    },
    {
      type: "fill",
      prompt_ja: "きょうしつにがくせいがたくさん＿＿。",
      solution: "います"
    },
    {
      type: "fill",
      prompt_ja: "へやにテレビが＿＿か。",
      solution: "あります"
    },
    {
      type: "mc",
      prompt_ja: "Welcher Satz ist korrekt?",
      options_ja: [
        "いえにねこがあります。",
        "いえにねこがいます。",
        "いえにねこです。"
      ],
      correctIndex: 1
    },
    {
      type: "mc",
      prompt_ja: "„Im Park gibt es viele Bäume.“",
      options_ja: [
        "こうえんにきがたくさんいます。",
        "こうえんにきがたくさんあります。",
        "こうえんにはたくさんです。"
      ],
      correctIndex: 1
    },
    {
      type: "fill",
      prompt_ja: "きょうはテストが＿＿。",
      solution: "あります",
      prompt_de: "Ereignisse (Tests, Partys usw.) → あります"
    },
    {
      type: "fill",
      prompt_ja: "きょうしつにせんせいが＿＿か。",
      solution: "います"
    }
  ],
  "g2-03-mo-to": [
    {
      type: "fill",
      prompt_ja: "わたし＿＿がくせいです。（„ich auch“）",
      solution: "も"
    },
    {
      type: "fill",
      prompt_ja: "パン＿＿コーヒーをたべました。",
      solution: "と",
      prompt_de: "A と B = A und B"
    },
    {
      type: "fill",
      prompt_ja: "メアリーさんはにほんご＿＿えいごもはなせます。",
      solution: "も"
    },
    {
      type: "mc",
      prompt_ja: "„Ich bin auch Student.“",
      options_ja: [
        "わたしはがくせいとです。",
        "わたしもがくせいです。",
        "わたしはがくせいもです。"
      ],
      correctIndex: 1
    },
    {
      type: "mc",
      prompt_ja: "„Ich habe mit Mary UND Takeshi gegessen.“",
      options_ja: [
        "メアリーさんもたけしさんとたべました。",
        "メアリーさんとたけしさんとたべました。",
        "メアリーさんとたけしさんもたべました。"
      ],
      correctIndex: 1
    },
    {
      type: "fill",
      prompt_ja: "コーヒー＿＿ケーキをください。",
      solution: "と"
    },
    {
      type: "fill",
      prompt_ja: "にほんじん＿＿がくせいです。（„auch Japaner“）",
      solution: "も"
    },
    {
      type: "mc",
      prompt_ja: "Partikel も benutzt du, um …",
      options_ja: [
        "Zeit auszudrücken",
        "Ort auszudrücken",
        "„auch“ auszudrücken"
      ],
      correctIndex: 2
    }
  ],
  "g2-04-price": [
    {
      type: "fill",
      prompt_ja: "このりんごは＿＿ですか。（Wie viel kostet dieser Apfel?）",
      solution: "いくら"
    },
    {
      type: "fill",
      prompt_ja: "このほんは１０００＿＿です。",
      solution: "えん"
    },
    {
      type: "mc",
      prompt_ja: "„Wie viel kostet das?“",
      options_ja: [
        "これはいくらですか。",
        "これはなんですか。",
        "これはどこですか。"
      ],
      correctIndex: 0
    },
    {
      type: "mc",
      prompt_ja: "„Dieser Apfel kostet 150 Yen.“",
      options_ja: [
        "このりんごは１５０えんです。",
        "このりんごはいくらです。",
        "このりんごは１５０ですか。"
      ],
      correctIndex: 0
    },
    {
      type: "fill",
      prompt_ja: "コーヒーは３００えん＿＿。",
      solution: "です"
    },
    {
      type: "fill",
      prompt_ja: "このTシャツはやすくて、５００えん＿＿。",
      solution: "だけです",
      prompt_de: "„nur 500 Yen“"
    },
    {
      type: "mc",
      prompt_ja: "Frage nach dem Preis dieses Stiftes:",
      options_ja: [
        "このペンはなんですか。",
        "このペンはいくらですか。",
        "このペンはどこですか。"
      ],
      correctIndex: 1
    },
    {
      type: "mc",
      prompt_ja: "„Der Kaffee ist teuer.“ im Kontext von Preis:",
      options_ja: [
        "コーヒーはたかいです。",
        "コーヒーはいくらですか。",
        "コーヒーはえんです。"
      ],
      correctIndex: 0
    }
  ]
};

// Helper: Übungen an geladene Grammatik anhängen
function applyGrammarExercises(items){
  if (!Array.isArray(items)) return [];
  const map = {};
  items.forEach(g => { map[String(g.id)] = g; });

  function attach(exMap){
    if (!exMap) return;
    Object.keys(exMap).forEach(id => {
      const g = map[id];
      if (!g) return;
      const extra = exMap[id];
      if (!Array.isArray(extra) || !extra.length) return;
      if (!Array.isArray(g.exercises)) g.exercises = [];
      g.exercises = g.exercises.concat(extra);
    });
  }

  attach(GRAMMAR_EXERCISES_GENKI_0);
  attach(GRAMMAR_EXERCISES_GENKI_1);
  attach(GRAMMAR_EXERCISES_GENKI_2);

  return items;
}


// sanft exponentiell ↑ : 1→20, 2→30, 3→50 … 50→~1000, 100→~2000
function tasksRequired(level){
  return Math.floor(20 * Math.pow(1.045, level * 1.2));
}

function loadLevels(){
  try { return JSON.parse(localStorage.getItem(LEVELS_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveLevels(arr){
  localStorage.setItem(LEVELS_KEY, JSON.stringify(arr || []));
}

function loadProgress(){
  try { return JSON.parse(localStorage.getItem(PROGRESS_KEY) || '{"currentLevel":1,"levelProgress":0,"completedLevels":[]}'); }
  catch(e){ return { currentLevel: 1, levelProgress: 0, completedLevels: [] }; }
}
function saveProgress(p){ localStorage.setItem(PROGRESS_KEY, JSON.stringify(p||{})); }

function ensureSeedLevels(){
  // 1) Vorhandenes laden
  const existing = Array.isArray(loadLevels()) ? loadLevels() : [];
  const byId = new Map(existing.map(l => [l.id, l]));

  // 2) Helper: bessere Daten übernehmen
  const takeRicher = (curr, seed) => {
    const out = { ...curr };

    // Titel: wenn leer/gleich "Thema X", nimm den Seed-Titel
    if (!out.title || /^Thema\s+\d+$/i.test(out.title)) out.title = seed.title || out.title;

    // Story-Text: nimm den längeren/nicht-leeren
    const len = s => (typeof s === "string" ? s.trim().length : 0);
    if (len(seed.story_ja) > len(out.story_ja)) out.story_ja = seed.story_ja;
    if (len(seed.story_de) > len(out.story_de)) out.story_de = seed.story_de;

    // Vokabeln: wenn Seed mehr Einträge hat, nimm Seed
    const seedV = Array.isArray(seed.vocab) ? seed.vocab : [];
    const currV = Array.isArray(out.vocab) ? out.vocab : [];
    if (seedV.length > currV.length) out.vocab = seedV;

    // tasksRequired & level & id beibehalten
    out.level = typeof out.level === "number" ? out.level : seed.level;
    out.id    = out.id || seed.id;
    out.tasksRequired = typeof out.tasksRequired === "number" ? out.tasksRequired : seed.tasksRequired;
    return out;
  };

  // 3) Deine Seed-Factory & Seeds (11–32 ausführlich + 33–100 Platzhalter)
  const L = (num, title, ja, de, vocab=[]) => ({
    id: "level-"+String(num).padStart(3,"0"),
    level: num,
    title,
    tasksRequired: (typeof window.tasksRequired === "function")
      ? tasksRequired(num)
      : Math.max(3, Math.min(10, Math.ceil(num / 2))),
    vocab,
    story_ja: ja,
    story_de: de
  });

  const seeds = [
    // 1
    L(1,"Begrüßung & Vorstellung",
      [
        "はじめまして。わたしはハンナです。ドイツから来ました。",
        "こんにちは。おなまえは？わたしはハンナ・ミュラーです。",
        "よろしくおねがいします。学生です。"
      ].join("\n"),
      [
        "Freut mich, ich bin Hanna. Ich komme aus Deutschland.",
        "Hallo! Wie heißt du? Ich heiße Hanna Müller.",
        "Angenehm, bitte behandle mich gut. Ich bin Studentin."
      ].join("\n"),
      [
        {de:"Hallo / Guten Tag",kana:"こんにちは",romaji:"konnichiwa"},
        {de:"Guten Morgen",kana:"おはようございます",romaji:"ohayō gozaimasu"},
        {de:"Guten Abend",kana:"こんばんは",romaji:"konbanwa"},
        {de:"Freut mich / Angenehm",kana:"はじめまして",romaji:"hajimemashite"},
        {de:"Bitte (bei Bitte um einen Gefallen)",kana:"おねがいします",romaji:"onegaishimasu"},
        {de:"Ich heiße …",kana:"わたしは…です",romaji:"watashi wa … desu"},
        {de:"Name",kana:"なまえ",kanji:"名前",romaji:"namae"},
        {de:"Student/in",kana:"がくせい",kanji:"学生",romaji:"gakusei"},
        {de:"aus … kommen",kana:"…から来ました",kanji:"来ました",romaji:"… kara kimashita"},
        {de:"Deutschland",kana:"ドイツ",romaji:"Doitsu"},
        {de:"Tschüss",kana:"さようなら",romaji:"sayōnara"},
        {de:"Bis später",kana:"またね",romaji:"mata ne"}
      ]
    ),

    // 2
    L(2,"Familie & Zuhause",
      [
        "わたしのかぞくは四人です。りょうしんと弟がいます。",
        "いえは小さいですが、あたたかいです。へやは二つあります。",
        "いぬもいます。なまえはポチです。"
      ].join("\n"),
      [
        "Meine Familie besteht aus vier Personen. Ich habe Eltern und einen jüngeren Bruder.",
        "Unser Haus ist klein, aber gemütlich. Es gibt zwei Zimmer.",
        "Wir haben auch einen Hund. Er heißt Pochi."
      ].join("\n"),
      [
        {de:"Familie",kana:"かぞく",kanji:"家族",romaji:"kazoku"},
        {de:"Eltern",kana:"りょうしん",kanji:"両親",romaji:"ryōshin"},
        {de:"Vater",kana:"ちち / おとうさん",kanji:"父 / お父さん",romaji:"chichi / otōsan"},
        {de:"Mutter",kana:"はは / おかあさん",kanji:"母 / お母さん",romaji:"haha / okāsan"},
        {de:"älterer Bruder",kana:"あに / おにいさん",kanji:"兄 / お兄さん",romaji:"ani / onīsan"},
        {de:"jüngerer Bruder",kana:"おとうと",kanji:"弟",romaji:"otōto"},
        {de:"ältere Schwester",kana:"あね / おねえさん",kanji:"姉 / お姉さん",romaji:"ane / onēsan"},
        {de:"jüngere Schwester",kana:"いもうと",kanji:"妹",romaji:"imōto"},
        {de:"Haus",kana:"いえ",kanji:"家",romaji:"ie"},
        {de:"Zimmer",kana:"へや",kanji:"部屋",romaji:"heya"},
        {de:"klein (Dinge)",kana:"小さい",kanji:"小さい",romaji:"chiisai"},
        {de:"Haustier",kana:"ペット",romaji:"petto"},
        {de:"Hund",kana:"いぬ",kanji:"犬",romaji:"inu"},
        {de:"Name",kana:"なまえ",kanji:"名前",romaji:"namae"}
      ]
    ),

    // 3
    L(3,"Alltag & Zeit",
      [
        "あさ六時におきて、七時にあさごはんを食べます。",
        "八時に学校へ行きます。ひるやすみにともだちと話します。",
        "よる十一時にねます。"
      ].join("\n"),
      [
        "Ich stehe um sechs auf und frühstücke um sieben.",
        "Um acht gehe ich zur Schule. In der Mittagspause spreche ich mit Freunden.",
        "Um elf Uhr abends gehe ich schlafen."
      ].join("\n"),
      [
        {de:"Morgen (Tageszeit)",kana:"あさ",romaji:"asa"},
        {de:"Abend/Nacht (spät)",kana:"よる",kanji:"夜",romaji:"yoru"},
        {de:"Mittagspause",kana:"ひるやすみ",kanji:"昼休み",romaji:"hiruyasumi"},
        {de:"aufstehen",kana:"おきる",kanji:"起きる",romaji:"okiru"},
        {de:"schlafen",kana:"ねる",kanji:"寝る",romaji:"neru"},
        {de:"essen (Speise)",kana:"たべる",kanji:"食べる",romaji:"taberu"},
        {de:"trinken",kana:"のむ",kanji:"飲む",romaji:"nomu"},
        {de:"gehen/fahren",kana:"いく",kanji:"行く",romaji:"iku"},
        {de:"Schule",kana:"学校",romaji:"gakkō"},
        {de:"Freund/in",kana:"ともだち",kanji:"友達",romaji:"tomodachi"},
        {de:"Uhrzeit ～Uhr",kana:"～時",romaji:"~ji"},
        {de:"Frühstück",kana:"あさごはん",kanji:"朝ご飯",romaji:"asagohan"},
        {de:"Zeit",kana:"じかん",kanji:"時間",romaji:"jikan"}
      ]
    ),

    // 4
    L(4,"Essen & Trinken",
      [
        "すしを食べます。みずをのみます。さかなが好きです。",
        "きょうのゆうごはんはカレーです。デザートにくだものを食べます。"
      ].join("\n"),
      [
        "Ich esse Sushi und trinke Wasser. Ich mag Fisch.",
        "Zum Abendessen gibt es heute Curry. Als Dessert esse ich Obst."
      ].join("\n"),
      [
        {de:"Wasser",kana:"みず",kanji:"水",romaji:"mizu"},
        {de:"Tee (grün)",kana:"おちゃ",kanji:"お茶",romaji:"ocha"},
        {de:"Reis (gekocht)",kana:"ごはん",kanji:"ご飯",romaji:"gohan"},
        {de:"Fisch",kana:"さかな",kanji:"魚",romaji:"sakana"},
        {de:"Fleisch",kana:"にく",kanji:"肉",romaji:"niku"},
        {de:"Gemüse",kana:"やさい",kanji:"野菜",romaji:"yasai"},
        {de:"Obst",kana:"くだもの",kanji:"果物",romaji:"kudamono"},
        {de:"Sushi",kana:"すし",kanji:"寿司",romaji:"sushi"},
        {de:"Curry",kana:"カレー",romaji:"karē"},
        {de:"Abendessen",kana:"ゆうごはん",kanji:"夕ご飯",romaji:"yūgohan"},
        {de:"lecker",kana:"おいしい",romaji:"oishii"},
        {de:"mögen/lieben",kana:"好き",romaji:"suki"},
        {de:"trinken",kana:"のむ",kanji:"飲む",romaji:"nomu"},
        {de:"essen",kana:"たべる",kanji:"食べる",romaji:"taberu"}
      ]
    ),

    // 5
    L(5,"Feste & Bräuche（おまつり）",
      [
        "きょうはおまつりです。たいこのおとが聞こえます。",
        "よるに花火を見ます。やたいでやきそばを食べました。"
      ].join("\n"),
      [
        "Heute ist ein Fest. Man hört Trommeln.",
        "Abends schauen wir Feuerwerk. An den Ständen habe ich Yakisoba gegessen."
      ].join("\n"),
      [
        {de:"Fest",kana:"まつり",kanji:"祭り",romaji:"matsuri"},
        {de:"Feuerwerk",kana:"はなび",kanji:"花火",romaji:"hanabi"},
        {de:"Trommel",kana:"たいこ",kanji:"太鼓",romaji:"taiko"},
        {de:"Essensstand",kana:"やたい",kanji:"屋台",romaji:"yatai"},
        {de:"Yakisoba",kana:"やきそば",romaji:"yakisoba"},
        {de:"Yukata (leichter Kimono)",kana:"ゆかた",kanji:"浴衣",romaji:"yukata"},
        {de:"tanzen",kana:"おどる",kanji:"踊る",romaji:"odoru"},
        {de:"sehen/anschauen",kana:"見る",romaji:"miru"},
        {de:"hören",kana:"きく",kanji:"聞く",romaji:"kiku"},
        {de:"Spaß",kana:"たのしい",kanji:"楽しい",romaji:"tanoshii"},
        {de:"Nacht",kana:"よる",kanji:"夜",romaji:"yoru"},
        {de:"Sommerfest Bon",kana:"ぼんおどり",kanji:"盆踊り",romaji:"bonodori"}
      ]
    ),

    // 6
    L(6,"Schule & Freunde",
      [
        "ともだちといっしょにべんきょうします。図書館で本を読みます。",
        "クラブかつどうでサッカーをします。先生はしんせつです。"
      ].join("\n"),
      [
        "Ich lerne zusammen mit Freunden. In der Bibliothek lese ich Bücher.",
        "Bei der AG/Clubaktivität spiele ich Fußball. Die Lehrerin/der Lehrer ist freundlich."
      ].join("\n"),
      [
        {de:"lernen/studieren",kana:"べんきょうする",kanji:"勉強する",romaji:"benkyō suru"},
        {de:"Freund/in",kana:"ともだち",kanji:"友達",romaji:"tomodachi"},
        {de:"Lehrer/in",kana:"せんせい",kanji:"先生",romaji:"sensei"},
        {de:"Schüler/in",kana:"せいと",kanji:"生徒",romaji:"seito"},
        {de:"Bibliothek",kana:"としょかん",kanji:"図書館",romaji:"toshokan"},
        {de:"Buch",kana:"ほん",kanji:"本",romaji:"hon"},
        {de:"Hausaufgaben",kana:"しゅくだい",kanji:"宿題",romaji:"shukudai"},
        {de:"Test/Prüfung",kana:"テスト",romaji:"tesuto"},
        {de:"Club/AG",kana:"クラブ",romaji:"kurabu"},
        {de:"Fußball",kana:"サッカー",romaji:"sakkā"},
        {de:"freundlich",kana:"しんせつ",kanji:"親切",romaji:"shinsetsu"},
        {de:"zusammen",kana:"いっしょに",romaji:"issho ni"}
      ]
    ),

    // 7
    L(7,"Orte in der Stadt",
      [
        "えきはどこですか。みちはあちらです。",
        "このちずを見せてください。コンビニはあのかどをまがってすぐです。"
      ].join("\n"),
      [
        "Wo ist der Bahnhof? Der Weg ist dort drüben.",
        "Bitte zeigen Sie mir diese Karte. Der Konbini ist gleich nach der Ecke."
      ].join("\n"),
      [
        {de:"Bahnhof",kana:"えき",kanji:"駅",romaji:"eki"},
        {de:"Weg/Straße",kana:"みち",kanji:"道",romaji:"michi"},
        {de:"rechts/links abbiegen",kana:"右/左にまがる",kanji:"右/左に曲がる",romaji:"migi/hidari ni magaru"},
        {de:"geradeaus",kana:"まっすぐ",romaji:"massugu"},
        {de:"Ecke",kana:"かど",kanji:"角",romaji:"kado"},
        {de:"Karte/Plan",kana:"ちず",kanji:"地図",romaji:"chizu"},
        {de:"Bank",kana:"ぎんこう",kanji:"銀行",romaji:"ginkō"},
        {de:"Post",kana:"ゆうびんきょく",kanji:"郵便局",romaji:"yūbinkyoku"},
        {de:"Krankenhaus",kana:"びょういん",kanji:"病院",romaji:"byōin"},
        {de:"Konbini",kana:"コンビニ",romaji:"konbini"},
        {de:"da/dort drüben",kana:"あちら",romaji:"achira"},
        {de:"wo?",kana:"どこ",romaji:"doko"},
        {de:"zeigen",kana:"見せる",romaji:"miseru"}
      ]
    ),

    // 8
    L(8,"Freizeit & Hobbys（文化）",
      [
        "わたしはおんがくがすきです。毎週ピアノをれんしゅうします。",
        "日本のまんがも読みます。週末にえいがを見に行きます。"
      ].join("\n"),
      [
        "Ich mag Musik und übe jede Woche Klavier.",
        "Ich lese auch japanische Manga und gehe am Wochenende ins Kino."
      ].join("\n"),
      [
        {de:"Freizeit/Hobby",kana:"しゅみ",kanji:"趣味",romaji:"shumi"},
        {de:"Musik",kana:"おんがく",kanji:"音楽",romaji:"ongaku"},
        {de:"Klavier",kana:"ピアノ",romaji:"piano"},
        {de:"üben/trainieren",kana:"れんしゅうする",kanji:"練習する",romaji:"renshū suru"},
        {de:"Manga",kana:"まんが",kanji:"漫画",romaji:"manga"},
        {de:"Film",kana:"えいが",kanji:"映画",romaji:"eiga"},
        {de:"Kino",kana:"えいがかん",kanji:"映画館",romaji:"eigakan"},
        {de:"lesen",kana:"読む",romaji:"yomu"},
        {de:"ansehen",kana:"見る",romaji:"miru"},
        {de:"jeden Woche",kana:"毎週",romaji:"maishū"},
        {de:"Wochenende",kana:"しゅうまつ",kanji:"週末",romaji:"shūmatsu"},
        {de:"mögen",kana:"好き",romaji:"suki"}
      ]
    ),

    // 9
    L(9,"Wetter & Jahreszeiten",
      [
        "きょうはあめです。かさを持っていってください。",
        "はるのさくらがきれいです。なつはあつく、ふゆはさむいです。"
      ].join("\n"),
      [
        "Heute regnet es. Bitte nimm einen Regenschirm mit.",
        "Die Kirschblüten im Frühling sind schön. Der Sommer ist heiß, der Winter ist kalt."
      ].join("\n"),
      [
        {de:"Wetter",kana:"てんき",kanji:"天気",romaji:"tenki"},
        {de:"Regen",kana:"あめ",kanji:"雨",romaji:"ame"},
        {de:"Schnee",kana:"ゆき",kanji:"雪",romaji:"yuki"},
        {de:"Wind",kana:"かぜ",kanji:"風",romaji:"kaze"},
        {de:"heiß (Wetter)",kana:"あつい",kanji:"暑い",romaji:"atsui"},
        {de:"kalt (Wetter)",kana:"さむい",kanji:"寒い",romaji:"samui"},
        {de:"frühling",kana:"はる",kanji:"春",romaji:"haru"},
        {de:"sommer",kana:"なつ",kanji:"夏",romaji:"natsu"},
        {de:"herbst",kana:"あき",kanji:"秋",romaji:"aki"},
        {de:"winter",kana:"ふゆ",kanji:"冬",romaji:"fuyu"},
        {de:"Regenschirm",kana:"かさ",kanji:"傘",romaji:"kasa"},
        {de:"schön/hübsch",kana:"きれい",romaji:"kirei"},
        {de:"mitnehmen",kana:"持っていく",romaji:"motte iku"}
      ]
    ),

    // 10
    L(10,"お正月（Neujahr in Japan）",
      [
        "おしょうがつにおもちを食べます。おせち料理も食べます。",
        "じんじゃへ初もうでに行きます。ねんがじょうを書きます。"
      ].join("\n"),
      [
        "Zu Neujahr essen wir Mochi und auch Osechi (Neujahrsgerichte).",
        "Wir gehen zum ersten Schreinbesuch des Jahres. Wir schreiben Neujahrskarten."
      ].join("\n"),
      [
        {de:"Neujahr",kana:"おしょうがつ",kanji:"お正月",romaji:"oshōgatsu"},
        {de:"Mochi (Reiskuchen)",kana:"もち",kanji:"餅",romaji:"mochi"},
        {de:"Osechi (Neujahrsgerichte)",kana:"おせちりょうり",kanji:"おせち料理",romaji:"osechi ryōri"},
        {de:"Schrein",kana:"じんじゃ",kanji:"神社",romaji:"jinja"},
        {de:"erster Schreinbesuch",kana:"はつもうで",kanji:"初詣",romaji:"hatsumōde"},
        {de:"Neujahrskarte",kana:"ねんがじょう",kanji:"年賀状",romaji:"nengajō"},
        {de:"schreiben",kana:"書く",romaji:"kaku"},
        {de:"gehen",kana:"行く",romaji:"iku"},
        {de:"essen",kana:"食べる",romaji:"taberu"},
        {de:"Jahr",kana:"とし",kanji:"年",romaji:"toshi"},
        {de:"Glückwunsch!",kana:"あけましておめでとう",romaji:"akemashite omedetō"}
      ]
    ),

/* 11 – Einkaufen & Zahlen */
L(11,"Einkaufen & Zahlen（買い物と数字）",
[
  "日曜日に近くのスーパーで買い物をしました。",
  "やさいとくだものをかごに入れました。",
  "りんごは一つ百円で、三つ買いました。",
  "パンと牛乳はセールで安かったです。",
  "レジでポイントカードを見せて、カードで払いました。",
  "店員さんはにこにこして「ありがとうございました」と言いました。"
].join("\n"),
[
  "Am Sonntag habe ich im Supermarkt in der Nähe eingekauft.",
  "Ich legte Gemüse und Obst in den Korb.",
  "Äpfel kosteten je 100 Yen, ich kaufte drei.",
  "Brot und Milch waren im Angebot und günstig.",
  "An der Kasse zeigte ich die Punktekarte und zahlte mit Karte.",
  "Die Verkäuferin lächelte und sagte: „Vielen Dank“."
].join("\n"),
[
  {de:"einkaufen",kana:"かいものする",kanji:"買い物する",romaji:"kaimono suru"},
  {de:"Kasse",kana:"レジ",romaji:"reji"},
  {de:"Punktekarte",kana:"ポイントカード",romaji:"pointo kādo"},
  {de:"zahlen",kana:"はらう",kanji:"払う",romaji:"harau"},
  {de:"Angebot / Sale",kana:"セール",romaji:"sēru"},
  {de:"Korb",kana:"かご",romaji:"kago"},
  {de:"Stück",kana:"～こ",kanji:"～個",romaji:"-ko"},
  {de:"hundert",kana:"ひゃく",kanji:"百",romaji:"hyaku"},
  {de:"drei (zählen)",kana:"みっつ",kanji:"三つ",romaji:"mittsu"},
  {de:"teuer",kana:"たかい",kanji:"高い",romaji:"takai"},
  {de:"günstig",kana:"やすい",kanji:"安い",romaji:"yasui"},
  {de:"Verkäufer/in",kana:"てんいん",kanji:"店員",romaji:"ten'in"},
  {de:"Danke sehr",kana:"ありがとうございます",romaji:"arigatō gozaimasu"},
  {de:"Apfel",kana:"りんご",romaji:"ringo"},
  {de:"Preis",kana:"ねだん",kanji:"値段",romaji:"nedan"}
]),

/* 12 – Verkehr & Reisen */
L(12,"Verkehr & Reisen（交通と旅行）",
[
  "来週、友だちと京都へ旅行します。",
  "朝早く駅で切符を買って、新幹線に乗ります。",
  "車内で駅弁を食べて、窓から山を見ます。",
  "京都駅に着いたら、バスでお寺へ行きます。",
  "夜は旅館にとまって、おんせんに入りたいです。"
].join("\n"),
[
  "Nächste Woche reise ich mit einem Freund nach Kyōto.",
  "Am frühen Morgen kaufen wir am Bahnhof Tickets und nehmen den Shinkansen.",
  "Im Zug essen wir ein Ekiben und sehen Berge aus dem Fenster.",
  "In Kyōto fahren wir mit dem Bus zum Tempel.",
  "Abends übernachten wir im Ryokan und möchten ins Onsen gehen."
].join("\n"),
[
  {de:"Reise",kana:"りょこう",kanji:"旅行",romaji:"ryokō"},
  {de:"Bahnhof",kana:"えき",kanji:"駅",romaji:"eki"},
  {de:"Fahrschein",kana:"きっぷ",kanji:"切符",romaji:"kippu"},
  {de:"Shinkansen",kana:"しんかんせん",kanji:"新幹線",romaji:"shinkansen"},
  {de:"Zugabteil / innen",kana:"しゃない",kanji:"車内",romaji:"shanai"},
  {de:"Bento vom Bahnhof",kana:"えきべん",kanji:"駅弁",romaji:"ekiben"},
  {de:"ankommen",kana:"つく",kanji:"着く",romaji:"tsuku"},
  {de:"Bus",kana:"バス",romaji:"basu"},
  {de:"Tempel",kana:"おてら",kanji:"お寺",romaji:"otera"},
  {de:"Ryokan (Gasthaus)",kana:"りょかん",kanji:"旅館",romaji:"ryokan"},
  {de:"Onsen",kana:"おんせん",kanji:"温泉",romaji:"onsen"},
  {de:"Fenster",kana:"まど",kanji:"窓",romaji:"mado"},
  {de:"früh",kana:"はやい",kanji:"早い",romaji:"hayai"},
  {de:"übernachten",kana:"とまる",kanji:"泊まる",romaji:"tomaru"},
  {de:"steigen / fahren (Zug)",kana:"のる",kanji:"乗る",romaji:"noru"}
]),

/* 13 – Kleidung & Kultur */
L(13,"Kleidung & Kultur（服と文化・ゆかた）",
[
  "夏の祭りでゆかたを着ました。",
  "友だちに帯のむすび方を教えてもらいました。",
  "屋台でたこやきを食べて、金魚すくいをしました。",
  "夜になると、花火が空いっぱいにひろがりました。",
  "たのしい音楽でみんながおどりました。"
].join("\n"),
[
  "Beim Sommerfest trug ich einen Yukata.",
  "Eine Freundin zeigte mir, wie man den Obi bindet.",
  "An den Ständen aß ich Takoyaki und spielte Goldfischangeln.",
  "Als es Nacht wurde, füllte Feuerwerk den Himmel.",
  "Zu fröhlicher Musik tanzten alle."
].join("\n"),
[
  {de:"Yukata",kana:"ゆかた",kanji:"浴衣",romaji:"yukata"},
  {de:"Obi (Gürtel)",kana:"おび",kanji:"帯",romaji:"obi"},
  {de:"anziehen/tragen",kana:"きる",kanji:"着る",romaji:"kiru"},
  {de:"binden",kana:"むすぶ",kanji:"結ぶ",romaji:"musubu"},
  {de:"Stand (Festival)",kana:"やたい",kanji:"屋台",romaji:"yatai"},
  {de:"Takoyaki",kana:"たこやき",kanji:"たこ焼き",romaji:"takoyaki"},
  {de:"Goldfischangeln",kana:"きんぎょすくい",kanji:"金魚すくい",romaji:"kingyo-sukui"},
  {de:"Feuerwerk",kana:"はなび",kanji:"花火",romaji:"hanabi"},
  {de:"Himmel",kana:"そら",kanji:"空",romaji:"sora"},
  {de:"tanzen",kana:"おどる",kanji:"踊る",romaji:"odoru"},
  {de:"Sommerfest",kana:"まつり",kanji:"祭り",romaji:"matsuri"},
  {de:"Musik",kana:"おんがく",kanji:"音楽",romaji:"ongaku"},
  {de:"fröhlich",kana:"たのしい",kanji:"楽しい",romaji:"tanoshii"},
  {de:"Kleidung",kana:"ふく",kanji:"服",romaji:"fuku"},
  {de:"anprobieren",kana:"ためす",kanji:"試す",romaji:"tamesu"}
]),

/* 14 – Japanisches Essen & Etikette */
L(14,"Japanisches Essen & Etikette（食事のマナー）",
[
  "友だちの家で夕ご飯をごちそうになりました。",
  "食べる前に『いただきます』と言います。",
  "おはしで料理を食べて、茶わんを手に持ちます。",
  "食べ終わったら『ごちそうさまでした』と言いました。",
  "日本のマナーを少しずつ覚えています。"
].join("\n"),
[
  "Ich wurde bei einer Freundin zum Abendessen eingeladen.",
  "Vor dem Essen sagt man „Itadakimasu“.",
  "Man isst mit Stäbchen und hält die Reisschale in der Hand.",
  "Nach dem Essen sagt man „Gochisōsama deshita“.",
  "Ich lerne die japanischen Tischsitten nach und nach."
].join("\n"),
[
  {de:"Stäbchen",kana:"おはし",kanji:"お箸",romaji:"ohashi"},
  {de:"Reisschale",kana:"ちゃわん",kanji:"茶碗",romaji:"chawan"},
  {de:"Itadakimasu",kana:"いただきます",romaji:"itadakimasu"},
  {de:"Gochisōsama",kana:"ごちそうさまでした",romaji:"gochisōsama deshita"},
  {de:"einladen / bewirten",kana:"ごちそうする",romaji:"gochisō suru"},
  {de:"essen (Höflich)",kana:"いただく",romaji:"itadaku"},
  {de:"halten (in der Hand)",kana:"もつ",kanji:"持つ",romaji:"motsu"},
  {de:"zu Ende essen",kana:"たべおわる",kanji:"食べ終わる",romaji:"tabeowaru"},
  {de:"Manieren / Etikette",kana:"マナー",romaji:"manā"},
  {de:"langsam / nach und nach",kana:"すこしずつ",kanji:"少しずつ",romaji:"sukoshi zutsu"}
]),

/* 15 – Schule in Japan */
L(15,"Schule in Japan（日本の学校）",
[
  "日本の学校では、げた箱にくつを入れて上ばきをはきます。",
  "朝、クラスでホームルームがあります。",
  "生徒は当番で教室をそうじします。",
  "給食の時間にはみんなで『いただきます』と言います。",
  "放課後、図書館で本を借りました。"
].join("\n"),
[
  "In japanischen Schulen stellt man die Straßenschuhe in ein Schuhfach und trägt Hausschuhe.",
  "Am Morgen gibt es eine Klassenbesprechung (Homeroom).",
  "Die Schüler reinigen das Klassenzimmer im Turnus.",
  "Zur Mittagszeit sagt die Klasse gemeinsam „Itadakimasu“.",
  "Nach dem Unterricht lieh ich mir in der Bibliothek Bücher aus."
].join("\n"),
[
  {de:"Schuhfach",kana:"げたばこ",kanji:"下駄箱",romaji:"getabako"},
  {de:"Hausschuhe",kana:"うわばき",kanji:"上ばき",romaji:"uwabaki"},
  {de:"Homeroom",kana:"ホームルーム",romaji:"hōmurūmu"},
  {de:"Zuständigkeit / Dienst",kana:"とうばん",kanji:"当番",romaji:"tōban"},
  {de:"reinigen / putzen",kana:"そうじする",kanji:"掃除する",romaji:"sōji suru"},
  {de:"Schulspeisung",kana:"きゅうしょく",kanji:"給食",romaji:"kyūshoku"},
  {de:"Bibliothek",kana:"としょかん",kanji:"図書館",romaji:"toshokan"},
  {de:"ausleihen",kana:"かりる",kanji:"借りる",romaji:"kariru"},
  {de:"zur Schule gehen",kana:"とうこうする",kanji:"登校する",romaji:"tōkō suru"},
  {de:"Schüler/in",kana:"せいと",kanji:"生徒",romaji:"seito"}
]),

/* 16 – Arzt & Gesundheit */
L(16,"Arzt & Gesundheit（病院と健康）",
[
  "きのうからのどがいたくて、熱も出ました。",
  "朝、病院に電話して予約を取りました。",
  "先生にのどを見てもらって、薬をもらいました。",
  "今日はゆっくり休んで、水をたくさん飲みます。"
].join("\n"),
[
  "Seit gestern habe ich Halsschmerzen und Fieber.",
  "Am Morgen rief ich im Krankenhaus an und vereinbarte einen Termin.",
  "Die Ärztin sah sich meinen Hals an und verschrieb mir Medizin.",
  "Heute ruhe ich mich aus und trinke viel Wasser."
].join("\n"),
[
  {de:"Hals",kana:"のど",romaji:"nodo"},
  {de:"Fieber",kana:"ねつ",kanji:"熱",romaji:"netsu"},
  {de:"Krankenhaus",kana:"びょういん",kanji:"病院",romaji:"byōin"},
  {de:"Termin / Reservierung",kana:"よやく",kanji:"予約",romaji:"yoyaku"},
  {de:"Arzt/Ärztin",kana:"いしゃ",kanji:"医者",romaji:"isha"},
  {de:"Medikament",kana:"くすり",kanji:"薬",romaji:"kusuri"},
  {de:"ruhen",kana:"やすむ",kanji:"休む",romaji:"yasumu"},
  {de:"trinken",kana:"のむ",kanji:"飲む",romaji:"nomu"}
]),

/* 17 – Technik & Online */
L(17,"Online lernen（オンライン学習）",
[
  "毎晩、オンラインで日本語の授業に参加します。",
  "ビデオをオンにして、先生の発音をまねします。",
  "チャットに質問を書いて、クラスメイトと話します。",
  "授業のあとで復習アプリで単語を覚えます。"
].join("\n"),
[
  "Jeden Abend nehme ich an einem Online-Japanischkurs teil.",
  "Ich schalte das Video ein und imitiere die Aussprache der Lehrerin.",
  "Ich schreibe Fragen in den Chat und spreche mit den Mitschülern.",
  "Nach dem Unterricht lerne ich die Vokabeln mit einer Wiederholungs-App."
].join("\n"),
[
  {de:"online",kana:"オンライン",romaji:"onrain"},
  {de:"Unterricht",kana:"じゅぎょう",kanji:"授業",romaji:"jugyō"},
  {de:"teilnehmen",kana:"さんかする",kanji:"参加する",romaji:"sanka suru"},
  {de:"Aussprache",kana:"はつおん",kanji:"発音",romaji:"hatsuon"},
  {de:"nachmachen",kana:"まねする",kanji:"真似する",romaji:"mane suru"},
  {de:"Chat",kana:"チャット",romaji:"chatto"},
  {de:"Wiederholung",kana:"ふくしゅう",kanji:"復習",romaji:"fukushū"},
  {de:"Vokabel",kana:"たんご",kanji:"単語",romaji:"tango"}
]),

/* 18 – Haushalt & Aufgaben */
L(18,"Haushalt & Aufgaben（家事）",
[
  "朝、せんたくをして、服をベランダに干しました。",
  "昼に部屋をそうじして、ごみを出しました。",
  "夜は台所で晩ご飯を作りました。",
  "家事は大変ですが、きれいになると気持ちがいいです。"
].join("\n"),
[
  "Am Morgen habe ich gewaschen und die Kleidung auf dem Balkon getrocknet.",
  "Mittags habe ich das Zimmer geputzt und den Müll rausgebracht.",
  "Abends kochte ich das Abendessen in der Küche.",
  "Hausarbeit ist anstrengend, aber wenn alles sauber ist, fühlt es sich gut an."
].join("\n"),
[
  {de:"Hausarbeit",kana:"かじ",kanji:"家事",romaji:"kaji"},
  {de:"Wäsche waschen",kana:"せんたくする",kanji:"洗濯する",romaji:"sentaku suru"},
  {de:"trocknen / aufhängen",kana:"ほす",kanji:"干す",romaji:"hosu"},
  {de:"putzen",kana:"そうじする",kanji:"掃除する",romaji:"sōji suru"},
  {de:"Müll",kana:"ごみ",romaji:"gomi"},
  {de:"rausbringen",kana:"だす",kanji:"出す",romaji:"dasu"},
  {de:"Küche",kana:"だいどころ",kanji:"台所",romaji:"daidokoro"},
  {de:"Abendessen",kana:"ばんごはん",kanji:"晩ご飯",romaji:"bangohan"}
]),

/* 19 – Freizeit im Park */
L(19,"Freizeit im Park（公園で）",
[
  "日曜日に家の近くの公園へ行きました。",
  "天気がよくて、空が青かったです。",
  "ジョギングをして、本を読みました。",
  "子どもたちはボールであそんでいました。",
  "ベンチにすわってアイスクリームを食べました。",
  "とても気持ちがよかったです。"
].join("\n"),
[
  "Am Sonntag ging ich in den Park in der Nähe meines Hauses.",
  "Das Wetter war schön, der Himmel war blau.",
  "Ich joggte und las ein Buch.",
  "Die Kinder spielten mit einem Ball.",
  "Ich saß auf einer Bank und aß Eis.",
  "Es fühlte sich sehr angenehm an."
].join("\n"),
[
  {de:"Park",kana:"こうえん",kanji:"公園",romaji:"kōen"},
  {de:"blau",kana:"あおい",kanji:"青い",romaji:"aoi"},
  {de:"joggen",kana:"はしる",kanji:"走る",romaji:"hashiru"},
  {de:"lesen",kana:"よむ",kanji:"読む",romaji:"yomu"},
  {de:"spielen",kana:"あそぶ",kanji:"遊ぶ",romaji:"asobu"},
  {de:"Bank",kana:"ベンチ",romaji:"benchi"},
  {de:"sitzen",kana:"すわる",kanji:"座る",romaji:"suwaru"},
  {de:"Eis",kana:"アイスクリーム",romaji:"aisukurīmu"}
]),

/* 20 – Im Restaurant */
L(20,"Im Restaurant（レストランで）",
[
  "友だちと新しいレストランに行きました。",
  "メニューを見て、すしとてんぷらを注文しました。",
  "みそしるもとてもおいしかったです。",
  "ウェイターはしんせつでした。",
  "デザートにアイスクリームを食べました。",
  "お会計は一人二千円でした。"
].join("\n"),
[
  "Ich ging mit einem Freund in ein neues Restaurant.",
  "Wir sahen die Speisekarte und bestellten Sushi und Tempura.",
  "Auch die Miso-Suppe war sehr lecker.",
  "Der Kellner war freundlich.",
  "Als Dessert aßen wir Eis.",
  "Die Rechnung betrug 2000 Yen pro Person."
].join("\n"),
[
  {de:"Menü",kana:"メニュー",romaji:"menyū"},
  {de:"bestellen",kana:"ちゅうもんする",kanji:"注文する",romaji:"chūmon suru"},
  {de:"Miso-Suppe",kana:"みそしる",kanji:"味噌汁",romaji:"misoshiru"},
  {de:"Kellner/in",kana:"ウェイター/ウェイトレス",romaji:"weitā"},
  {de:"Rechnung",kana:"おかいけい",kanji:"お会計",romaji:"okaikei"},
  {de:"pro Person",kana:"ひとりあたり",kanji:"一人当たり",romaji:"hitori atari"}
]),

/* 21 – Schule II */
L(21,"In der Schule II（学校生活）",
[
  "毎朝八時に学校に行きます。",
  "授業は九時から始まります。",
  "今日は数学と英語のテストがあります。",
  "昼休みに友達とお弁当を食べます。",
  "放課後にクラブ活動でテニスをします。"
].join("\n"),
[
  "Jeden Morgen gehe ich um acht zur Schule.",
  "Der Unterricht beginnt um neun.",
  "Heute haben wir Tests in Mathe und Englisch.",
  "In der Mittagspause esse ich mit Freunden Bento.",
  "Nach dem Unterricht spiele ich im Club Tennis."
].join("\n"),
[
  {de:"beginnen",kana:"はじまる",kanji:"始まる",romaji:"hajimaru"},
  {de:"Test",kana:"テスト",romaji:"tesuto"},
  {de:"Bento",kana:"おべんとう",kanji:"お弁当",romaji:"obentō"},
  {de:"nach dem Unterricht",kana:"ほうかご",kanji:"放課後",romaji:"hōkago"}
]),

/* 22 – Im Supermarkt */
L(22,"Im Supermarkt（スーパーで）",
[
  "母といっしょにスーパーへ行きました。",
  "やさいやくだものを買いました。",
  "パンと牛乳も買いました。",
  "セールで安かったです。",
  "レジでカードで払いました。"
].join("\n"),
[
  "Ich ging mit meiner Mutter in den Supermarkt.",
  "Wir kauften Gemüse und Obst.",
  "Auch Brot und Milch kamen dazu.",
  "Es war im Sale günstig.",
  "An der Kasse zahlten wir mit Karte."
].join("\n"),
[
  {de:"Gemüse",kana:"やさい",kanji:"野菜",romaji:"yasai"},
  {de:"Obst",kana:"くだもの",kanji:"果物",romaji:"kudamono"},
  {de:"bezahlen",kana:"はらう",kanji:"払う",romaji:"harau"},
  {de:"Kreditkarte",kana:"カード",romaji:"kādo"}
]),

/* 23 – Ein Tag am Meer */
L(23,"Ein Tag am Meer（海で）",
[
  "夏に家族と海へ行きました。",
  "すなはあつくて、海の水はつめたかったです。",
  "およいで、すいかを食べました。",
  "夕方にきれいな夕日を見ました。"
].join("\n"),
[
  "Im Sommer fuhr ich mit der Familie ans Meer.",
  "Der Sand war heiß, das Wasser kühl.",
  "Wir schwammen und aßen Wassermelone.",
  "Am Abend sahen wir einen schönen Sonnenuntergang."
].join("\n"),
[
  {de:"Meer",kana:"うみ",kanji:"海",romaji:"umi"},
  {de:"Sand",kana:"すな",kanji:"砂",romaji:"suna"},
  {de:"schwimmen",kana:"およぐ",kanji:"泳ぐ",romaji:"oyogu"},
  {de:"Wassermelone",kana:"すいか",romaji:"suika"},
  {de:"Sonnenuntergang",kana:"ゆうひ",kanji:"夕日",romaji:"yūhi"}
]),

/* 24 – Einkaufen in Tokio */
L(24,"Einkaufen in Tokio（東京で買い物）",
[
  "東京の渋谷で買い物をしました。",
  "デパートで新しい服を見ました。",
  "ズボンとシャツを買いました。",
  "かばんは高かったので買いませんでした。"
].join("\n"),
[
  "Ich ging in Shibuya einkaufen.",
  "Im Kaufhaus sah ich mir neue Kleidung an.",
  "Ich kaufte eine Hose und ein Hemd.",
  "Die Tasche war teuer, deshalb kaufte ich sie nicht."
].join("\n"),
[
  {de:"Kaufhaus",kana:"デパート",romaji:"depāto"},
  {de:"Kleidung",kana:"ふく",kanji:"服",romaji:"fuku"},
  {de:"Hose",kana:"ズボン",romaji:"zubon"},
  {de:"Hemd",kana:"シャツ",romaji:"shatsu"},
  {de:"Tasche",kana:"かばん",kanji:"鞄",romaji:"kaban"},
  {de:"teuer",kana:"たかい",kanji:"高い",romaji:"takai"}
]),

/* 25 – Arbeiten & Nebenjob */
L(25,"Arbeiten & Nebenjob（アルバイト）",
[
  "私は週に三回カフェでアルバイトをしています。",
  "お客さんにコーヒーを出します。",
  "時々ケーキも作ります。",
  "仕事はたいへんですが、たのしいです。"
].join("\n"),
[
  "Ich arbeite dreimal pro Woche im Café.",
  "Ich serviere Kaffee für die Gäste.",
  "Manchmal mache ich auch Kuchen.",
  "Die Arbeit ist anstrengend, aber macht Spaß."
].join("\n"),
[
  {de:"Gast",kana:"おきゃくさん",kanji:"お客さん",romaji:"okyakusan"},
  {de:"servieren",kana:"だす",kanji:"出す",romaji:"dasu"},
  {de:"herstellen",kana:"つくる",kanji:"作る",romaji:"tsukuru"},
  {de:"anstrengend",kana:"たいへん",kanji:"大変",romaji:"taihen"}
]),

/* 26 – Wohnen in Japan */
L(26,"Wohnen in Japan（日本での生活）",
[
  "私は東京で小さいアパートに住んでいます。",
  "へやは一つですが、とても明るいです。",
  "近くにコンビニとスーパーがあります。",
  "毎日自転車で学校へ行きます。"
].join("\n"),
[
  "Ich wohne in einer kleinen Wohnung in Tokio.",
  "Es gibt nur ein Zimmer, aber es ist sehr hell.",
  "In der Nähe gibt es einen Konbini und einen Supermarkt.",
  "Jeden Tag fahre ich mit dem Fahrrad zur Schule."
].join("\n"),
[
  {de:"wohnen",kana:"すむ",kanji:"住む",romaji:"sumu"},
  {de:"Wohnung",kana:"アパート",romaji:"apāto"},
  {de:"hell",kana:"あかるい",kanji:"明るい",romaji:"akarui"},
  {de:"Fahrrad",kana:"じてんしゃ",kanji:"自転車",romaji:"jitensha"}
]),

/* 27 – Elektronik & Technik */
L(27,"Elektronik & Technik（テクノロジー）",
[
  "新しいスマートフォンを買いました。",
  "カメラがとてもきれいです。",
  "アプリで日本語を勉強しています。",
  "毎日ニュースをスマホで読みます。"
].join("\n"),
[
  "Ich habe ein neues Smartphone gekauft.",
  "Die Kamera ist sehr gut.",
  "Ich lerne mit einer App Japanisch.",
  "Jeden Tag lese ich Nachrichten auf dem Handy."
].join("\n"),
[
  {de:"Smartphone",kana:"スマートフォン",romaji:"sumātofon"},
  {de:"App",kana:"アプリ",romaji:"apuri"},
  {de:"Kamera",kana:"カメラ",romaji:"kamera"},
  {de:"Nachrichten",kana:"ニュース",romaji:"nyūsu"},
  {de:"lernen",kana:"べんきょうする",kanji:"勉強する",romaji:"benkyō suru"}
]),

/* 28 – Natur & Wandern */
L(28,"Natur & Wandern（しぜんとハイキング）",
[
  "山にハイキングに行きました。",
  "みどりの木と花がたくさんありました。",
  "鳥の声がきこえて、気持ちがよかったです。",
  "お弁当を食べて、写真をとりました。"
].join("\n"),
[
  "Ich ging in die Berge zum Wandern.",
  "Es gab viele grüne Bäume und Blumen.",
  "Ich hörte Vogelstimmen, es war angenehm.",
  "Ich aß mein Bento und machte Fotos."
].join("\n"),
[
  {de:"Berg",kana:"やま",kanji:"山",romaji:"yama"},
  {de:"Natur",kana:"しぜん",kanji:"自然",romaji:"shizen"},
  {de:"Vogel",kana:"とり",kanji:"鳥",romaji:"tori"},
  {de:"Stimme",kana:"こえ",kanji:"声",romaji:"koe"},
  {de:"Foto machen",kana:"しゃしんをとる",kanji:"写真を撮る",romaji:"shashin o toru"}
]),

/* 29 – Wetterumschwung */
L(29,"Wetterumschwung（天気の変化）",
[
  "朝は晴れていましたが、昼ごろ急に雨になりました。",
  "かさを持っていなかったので、コンビニで買いました。",
  "夕方には雨が止んで、きれいな虹が見えました。",
  "明日はまた暑くなるそうです。"
].join("\n"),
[
  "Am Morgen war es sonnig, aber mittags fing es plötzlich an zu regnen.",
  "Ich hatte keinen Schirm und kaufte einen im Konbini.",
  "Am Abend hörte der Regen auf und ein schöner Regenbogen erschien.",
  "Morgen soll es wieder heiß werden."
].join("\n"),
[
  {de:"plötzlich",kana:"きゅうに",kanji:"急に",romaji:"kyū ni"},
  {de:"Regenbogen",kana:"にじ",kanji:"虹",romaji:"niji"},
  {de:"aufhören (Regen)",kana:"やむ",kanji:"止む",romaji:"yamu"},
  {de:"heiß werden",kana:"あつくなる",kanji:"暑くなる",romaji:"atsuku naru"}
]),

/* 30 – Besuch bei Freunden */
L(30,"Besuch bei Freunden（友だちの家へ）",
[
  "土曜日に友だちの家に遊びに行きました。",
  "おみやげにクッキーを持って行きました。",
  "いっしょにゲームをして、たくさん話しました。",
  "帰りに駅まで送ってくれました。"
].join("\n"),
[
  "Am Samstag besuchte ich einen Freund zu Hause.",
  "Ich brachte als Mitbringsel Kekse mit.",
  "Wir spielten zusammen Spiele und redeten viel.",
  "Auf dem Rückweg brachte er mich bis zum Bahnhof."
].join("\n"),
[
  {de:"besuchen / spielen",kana:"あそびにいく",kanji:"遊びに行く",romaji:"asobi ni iku"},
  {de:"Mitbringsel",kana:"おみやげ",kanji:"お土産",romaji:"omiyage"},
  {de:"bringen / mitnehmen",kana:"もっていく",kanji:"持っていく",romaji:"motte iku"},
  {de:"begleiten / bringen",kana:"おくる",kanji:"送る",romaji:"okuru"}
]),

/* 31 – Bibliothekstag */
L(31,"Tag in der Bibliothek（図書館の日）",
[
  "試験の前に図書館で勉強しました。",
  "しずかな席を見つけて、三時間ノートをまとめました。",
  "わからないところを先生の本で調べました。",
  "帰りに本を二冊借りました。"
].join("\n"),
[
  "Vor der Prüfung lernte ich in der Bibliothek.",
  "Ich fand einen ruhigen Platz und fasste drei Stunden lang Notizen zusammen.",
  "Unklare Stellen schlug ich in einem Buch der Lehrerin nach.",
  "Auf dem Heimweg lieh ich zwei Bücher aus."
].join("\n"),
[
  {de:"Prüfung",kana:"しけん",kanji:"試験",romaji:"shiken"},
  {de:"zusammenfassen",kana:"まとめる",romaji:"matomeru"},
  {de:"nachschlagen",kana:"しらべる",kanji:"調べる",romaji:"shiraberu"},
  {de:"ausleihen (Buch)",kana:"かりる",kanji:"借りる",romaji:"kariru"},
  {de:"Exemplar / Buch (Zähleinheit)",kana:"～さつ",kanji:"～冊",romaji:"-satsu"}
]),

/* 32 – Sporttag */
L(32,"Sporttag（スポーツの日）",
[
  "学校でスポーツ大会がありました。",
  "私はリレーに出て、一生けんめい走りました。",
  "クラスのみんなが大きな声でおうえんしました。",
  "最後にメダルをもらって、とても誇りに思いました。"
].join("\n"),
[
  "In der Schule gab es einen Sportwettbewerb.",
  "Ich trat beim Staffellauf an und rannte mit voller Kraft.",
  "Die ganze Klasse feuerte laut an.",
  "Am Ende bekam ich eine Medaille und war sehr stolz."
].join("\n"),
[
  {de:"Wettbewerb",kana:"たいかい",kanji:"大会",romaji:"taikai"},
  {de:"Staffellauf",kana:"リレー",romaji:"rirē"},
  {de:"mit ganzer Kraft",kana:"いっしょうけんめい",kanji:"一生懸命",romaji:"isshōkenmei"},
  {de:"anfeuern",kana:"おうえんする",kanji:"応援する",romaji:"ōen suru"},
  {de:"Medaille",kana:"メダル",romaji:"medaru"},
  {de:"stolz sein",kana:"ほこりにおもう",kanji:"誇りに思う",romaji:"hokori ni omō"}
])
    
  ];

 for (let lv = 33; lv <= 100; lv++) {
    seeds.push(L(
      lv,
      "Thema " + lv,
      "（準備中）\nこのレベルのストーリーはまだ作成中です。",
      "(Platzhalter-Story – wird später ergänzt.)",
      []
    ));
  }

  // 4) Merge anwenden
  for (const s of seeds){
    const cur = byId.get(s.id);
    if (!cur) {
      byId.set(s.id, s);
    } else {
      byId.set(s.id, takeRicher(cur, s));
    }
  }

  // 5) Speichern (sortiert)
  const merged = [...byId.values()].sort((a,b) => (a.level||0) - (b.level||0));
  saveLevels(merged);
}


function addProgressIfFlawless(n=1){
  const levels = loadLevels();
  if (!levels.length) return;
  const prog = loadProgress();
  const curr = levels.find(l => l.level === prog.currentLevel);
  if (!curr) return;
  prog.levelProgress += n;
  if (prog.levelProgress >= curr.tasksRequired){
    prog.completedLevels = Array.isArray(prog.completedLevels) ? prog.completedLevels : [];
    if (!prog.completedLevels.includes(curr.level)) prog.completedLevels.push(curr.level);
    prog.currentLevel = Math.min(100, curr.level + 1);
    prog.levelProgress = 0;
    saveProgress(prog);
    try{ alert(`🎉 Stufe ${curr.level} abgeschlossen! Willkommen in Stufe ${prog.currentLevel}.`); }catch(e){}
  } else {
    saveProgress(prog);
  }
}


function save(){
  // safe write (no crash if storage disabled)
  lsSet(STORAGE_KEY_V2, JSON.stringify(state.sets));
}

function buildSeedSets(){
  // --- Japanisch (kleiner Seed, für Demo/Offline) ---
  const jp = [
    ["Wasser","みず","水","mizu"],
    ["Mensch","ひと","人","hito"],
    ["Japan","にほん","日本","nihon"],
    ["Lehrer","せんせい","先生","sensei"],
    ["Student","がくせい","学生","gakusei"],
    ["Buch","ほん","本","hon"],
  ];
  const jpCards = jp.flatMap(([de,kana,kanji,romaji]) => ([
    { id: crypto.randomUUID(), question: `${de} – (Kana)`,  answer: kana },
    { id: crypto.randomUUID(), question: `${de} – (Kanji)`, answer: kanji },
    { id: crypto.randomUUID(), question: `${de} – (Romaji)`,answer: romaji },
  ]));

  // --- Englisch Basic ---
  const eng = {
    id: "eng-basic",
    name: "Englisch – Grundlagen",
    cards: [
      { id: crypto.randomUUID(), question: "Hello", answer: "Hallo" },
      { id: crypto.randomUUID(), question: "Thank you", answer: "Danke" },
      { id: crypto.randomUUID(), question: "Goodbye", answer: "Auf Wiedersehen" },
      { id: crypto.randomUUID(), question: "Please", answer: "Bitte" },
      { id: crypto.randomUUID(), question: "Excuse me", answer: "Entschuldigung" },
      { id: crypto.randomUUID(), question: "Friend", answer: "Freund(in)" },
    ],
    createdAt: Date.now(), updatedAt: Date.now()
  };

  // --- JS Match ---
  const jsMatch = {
    id: "js-match-terms",
    name: "JS Begriffe – Match (20/60s)",
    cards: [
      { id: crypto.randomUUID(), question: "Variable", answer: "Benannter Speicherplatz für einen Wert." },
      { id: crypto.randomUUID(), question: "Konstante", answer: "Wie Variable, aber nicht veränderbar (const)." },
      { id: crypto.randomUUID(), question: "Funktion", answer: "Wiederverwendbarer Codeblock mit optionalem Rückgabewert." },
      { id: crypto.randomUUID(), question: "Arrow Function", answer: "Kurze Funktionsschreibweise mit =>." },
      { id: crypto.randomUUID(), question: "Array", answer: "Geordnete Liste, indexbasiert ab 0." },
      { id: crypto.randomUUID(), question: "Objekt", answer: "Sammlung von Key-Value-Paaren." },
      { id: crypto.randomUUID(), question: "JSON", answer: "Textformat für Daten (Schlüssel/Werte)." },
      { id: crypto.randomUUID(), question: "DOM", answer: "Baumdarstellung einer HTML-Seite." },
      { id: crypto.randomUUID(), question: "Event Listener", answer: "Funktion, die auf Ereignisse wie Klicks reagiert." },
      { id: crypto.randomUUID(), question: "Promise", answer: "Objekt für zukünftige (asynchrone) Werte." },
      { id: crypto.randomUUID(), question: "async/await", answer: "Schreibweise zum Warten auf Promises." },
      { id: crypto.randomUUID(), question: "fetch", answer: "Führt HTTP-Anfragen aus und liefert ein Promise." },
      { id: crypto.randomUUID(), question: "Hoisting", answer: "Deklarationen werden vor Ausführung nach oben verschoben." },
      { id: crypto.randomUUID(), question: "Scope", answer: "Sichtbarkeitsbereich von Variablen." },
      { id: crypto.randomUUID(), question: "Closure", answer: "Funktion merkt sich Umgebung (Scope)." },
      { id: crypto.randomUUID(), question: "Prototype", answer: "Mechanismus zur Vererbung in JS." },
      { id: crypto.randomUUID(), question: "this", answer: "Verweist auf den aktuellen Kontext." },
      { id: crypto.randomUUID(), question: "NaN", answer: "‘Not a Number’ – ungültiges Zahlenergebnis." },
      { id: crypto.randomUUID(), question: "=== ", answer: "Strikter Vergleich ohne Typumwandlung." },
      { id: crypto.randomUUID(), question: "Template Literal", answer: "String mit Backticks und ${…} Einbettung." },
    ],
    createdAt: Date.now(), updatedAt: Date.now()
  };

  const jpSet = {
    id: "jp-basic-multi",
    name: "Japanisch – Grundbegriffe (DE → Kana/Kanji/Romaji)",
    cards: jpCards,
    createdAt: Date.now(), updatedAt: Date.now()
  };

  return [eng, jsMatch, jpSet];
}

function ensureSeedSets(){
  const seeds = buildSeedSets();
  let changed = false;
  seeds.forEach(seed => {
    if (!state.sets.some(s => s.id === seed.id)) {
      state.sets.push(seed);
      changed = true;
    }
  });
  if (changed) save();
}

function load(){
  const v2 = lsGet(STORAGE_KEY_V2);
  const v1 = lsGet(STORAGE_KEY_V1);
  if (v2) {
    try { state.sets = JSON.parse(v2) || []; } catch { state.sets = []; }
  }
}


// -------- Views --------
function render(){
const m = $("#app");
  if (state.route === "home") return renderHome(m);
  if (state.route === "new-set") return renderNewSet(m);
  if (state.route === "stories") return renderStories(m);
  if (state.route === "stats") return renderStats(m);
  if (state.route === "levels") return renderLevels(m);

  // ✨ neu: eigenständiges Schreib-Feature
  if (state.route === "write") return renderWriteStandalone(m);

  if (state.route.startsWith("level/read/")) return renderLevelRead(m, state.route.split("/")[2]);
  if (state.route === "new-story") return renderNewStory(m);
  if (state.route.startsWith("story/read/")) return renderStoryRead(m, state.route.split("/")[2]);
  if (state.route.startsWith("story/edit/")) return renderEditStory(m, state.route.split("/")[2]);
  if (state.route.startsWith("set/")) return renderSet(m, state.route.split("/")[1]);
  if (state.route.startsWith("learn/")) return renderLearn(m, state.route.split("/")[1]);
  if (state.route.startsWith("quiz/")) return renderQuiz(m, state.route.split("/")[1]);
  if (state.route.startsWith("match/")) return renderMatch(m, state.route.split("/")[1]);
  if (state.route.startsWith("spell/")) return renderSpell(m, state.route.split("/")[1]);

 if (state.route === "grammar") return renderGrammarList(m);
  if (state.route.startsWith("grammar/view/")) {
    const id = decodeURIComponent(state.route.split("/")[2]);
    return renderGrammarView(m, id);
  }
  if (state.route.startsWith("grammar/practice/")) {
    const id = decodeURIComponent(state.route.split("/")[2]);
    return renderGrammarPractice(m, id);
  }
}

function renderHome(mount){
  const filtered = state.search
    ? state.sets.filter(s => s.name.toLowerCase().includes(state.search))
    : state.sets;

  mount.innerHTML = `
    <h1>Meine Sets</h1>
    <div class="actions" style="margin:.5rem 0 1rem;">
      <button id="btnSeed" title="Fügt fehlende Standard-Sets hinzu (ohne deine zu löschen)">Seeds aktualisieren</button>
      <button id="btnGenki" class="primary" title="Importiert Genki‑Vokabeln (3rd Ed) direkt aus dem Repo">Genki‑Import (3rd Ed)</button>
    </div>
    <div class="grid">${filtered.map(s => `
      <div class="card">
        <h3>${s.name}</h3>
        <div class="badge">${s.cards.length} Karten</div>
        <div class="actions" style="margin-top:.5rem;">
          <button onclick="goto('set/${s.id}')">Öffnen</button>
          <button onclick="goto('learn/${s.id}')">Lernen</button>
          <button onclick="goto('quiz/${s.id}')">Quiz</button>
          <button onclick="goto('match/${s.id}')">Match 60s</button>
          <button class="primary" onclick="goto('spell/${s.id}')">Buchstabieren</button><button class="danger" onclick="deleteSet('${s.id}')">Löschen</button>
        </div>
      </div>
    `).join("")}</div>
    ${!filtered.length ? `<p>Keine Treffer. Erstelle ein neues Set oder ändere die Suche.</p>` : ""}
  `;
  $("#btnSeed").addEventListener("click", () => { ensureSeedSets(); render(); });
  $("#btnGenki").addEventListener("click", genkiImportWizard);
}

function renderNewSet(mount){
  mount.innerHTML = `
    <h2>Neues Set</h2>
    <form id="newSet">
      <label>Name</label>
      <input name="name" required maxlength="80" />
      <div class="hint" style="margin-top:.5rem;">Optional: Datei auswählen (JSON/CSV/XLSX) für dieses Set</div>
      <div class="actions" style="gap:.5rem; margin:.25rem 0 0;">
        <input type="file" id="newSetFile" accept=".json,.csv,.xlsx,.xls" style="display:none" />
        <button type="button" id="pickNewSetFile">Datei wählen</button>
        <span id="newSetFileName" class="hint"></span>
        <button type="button" id="clearNewSetFile" class="danger" style="display:none">Datei entfernen</button>
      </div>
      <div class="hint" style="margin-top:.5rem;">Oder: <button type="button" id="inlineImportBtn">Datei importieren (JSON/CSV/XLSX)</button></div>
      <button>Erstellen</button>
    </form>
  `;
  $("#newSet").onsubmit = async (e) => {
    e.preventDefault();
  const fileInput = document.getElementById('newSetFile');
  const staged = fileInput && fileInput.files && fileInput.files[0];
  let importedCards = null;
  if (staged) {
    try { importedCards = await parseFileToCards(staged); }
    catch(err){ console.error(err); alert('Datei konnte nicht gelesen werden: '+err.message); return; }
  }

    const name = e.target.name.value.trim();
    if (!name) return;
    const id = name.toLowerCase().replace(/[^\w]+/g,"-") + "-" + Date.now();
    const cardsFromFile = Array.isArray(importedCards) ? importedCards : [];
      state.sets.push({ id, name, cards: cardsFromFile, createdAt: Date.now(), updatedAt: Date.now() });
    save(); goto("set/" + id);
  };
  const _inlineBtn = document.getElementById("inlineImportBtn");
  if(_inlineBtn){ _inlineBtn.addEventListener("click", ()=> (function(){var __t=document.getElementById("importFile"); if(__t) __t.click();})()); }

  const pickBtn = document.getElementById('pickNewSetFile');
  const clrBtn = document.getElementById('clearNewSetFile');
  const fi = document.getElementById('newSetFile');
  const nameLbl = document.getElementById('newSetFileName');
  if (pickBtn && fi) pickBtn.onclick = () => fi.click();
  if (fi) fi.onchange = () => { const f = fi.files && fi.files[0]; if (f){ nameLbl.textContent = f.name; clrBtn.style.display='inline-block'; } else { nameLbl.textContent=''; clrBtn.style.display='none'; } };
  if (clrBtn && fi) clrBtn.onclick = () => { fi.value=''; nameLbl.textContent=''; clrBtn.style.display='none'; };


  try{ ensureFocusScroll('input, textarea'); }catch(e){}
}

function renderSet(mount, setId){
  const s = state.sets.find(x => x.id === setId);
  if (!s) return mount.innerHTML = `<p>Set nicht gefunden.</p>`;
  mount.innerHTML = `
    <h2>${s.name}</h2>
    <details ${s.cards.length ? "" : "open"}>
      <summary>Karte hinzufügen</summary>
      <form id="newCard">
        <label>Frage</label>
        <input name="q" required maxlength="200" />
        <label>Antwort</label>
        <input name="a" required maxlength="200" />
        <button>Hinzufügen</button>
      </form>
    </details>
    <hr/>
    <div id="cards">${s.cards.map(c => `
      <div class="card">
        <div><strong>Q:</strong> ${escapeHTML(c.question)} <button class="mini sayQ" data-id="${c.id}" title="Frage vorlesen">🔊</button></div>
        <div><strong>A:</strong> ${escapeHTML(c.answer)} <button class="mini sayA" data-id="${c.id}" title="Antwort vorlesen">🔊</button></div>
        <div class="actions" style="margin-top:.5rem;">
          <button onclick="editCard('${s.id}','${c.id}')">Bearbeiten</button>
          <button onclick="deleteCard('${s.id}','${c.id}')">Löschen</button>
        </div>
      </div>
    `).join("")}</div>
    <div class="actions" style="margin-top:1rem;">
      <button onclick="goto('learn/${s.id}')">Lernmodus</button>
      <button onclick="goto('quiz/${s.id}')">Quizmodus</button>
      <button onclick="goto('match/${s.id}')">Match 60s</button>
      <button class="primary" onclick="goto('spell/${s.id}')">Buchstabieren</button><button class="danger" onclick="deleteSet('${s.id}')">Löschen</button>
    </div>
  `;

  $("#newCard").onsubmit = (e) => {
    e.preventDefault();
    const q = e.target.q.value.trim();
    const a = e.target.a.value.trim();
    if (!q || !a) return;
    s.cards.push({ id: crypto.randomUUID(), question: q, answer: a });
    s.updatedAt = Date.now();
    e.target.reset(); save(); renderSet(mount, setId);
  };

  try{ ensureFocusScroll('input, textarea'); }catch(e){}
}

function renderGrammarList(mount){
    const items = applyGrammarExercises(loadGrammar());
  mount.innerHTML = `
    <h1>Grammatik</h1>
    <div class="card">
      <input id="gSearch" placeholder="Grammatik suchen …" />
    </div>
    <div class="grid" id="gList"></div>
  `;
  const gList = $("#gList");
  function redraw(){
    const q = ($("#gSearch").value || "").toLowerCase();
    const filtered = !q ? items : items.filter(it =>
      (it.title||"").toLowerCase().includes(q) ||
      (it.explanation_de||"").toLowerCase().includes(q)
    );
    gList.innerHTML = filtered.map(it => `
     <div class="card">
    <h3>${it.title}</h3>
    <p>${(it.explanation_de||"").slice(0,140)}${(it.explanation_de||"").length>140?"…":""}</p>
    <div class="actions">
      <button onclick="goto('grammar/view/${encodeURIComponent(it.id)}')">Öffnen</button>
      <button class="danger" onclick="deleteGrammar('${encodeURIComponent(it.id)}')">Löschen</button>
    </div>
  </div>
    `).join("") || "<p>Keine Treffer.</p>";
  }
  $("#gSearch").addEventListener("input", redraw);
  redraw();
}

function renderGrammarView(mount, id){
  const items = loadGrammar();
  const g = items.find(x => String(x.id) === String(id));
  if (!g){ mount.innerHTML = "<p>Nicht gefunden.</p>"; return; }

  const hasExercises = Array.isArray(g.exercises) && g.exercises.length > 0;

  mount.innerHTML = `
    <h2>${escapeHTML(g.title || "")}</h2>
    <div class="card">
      ${g.explanation_de ? `<p>${escapeHTML(g.explanation_de)}</p>` : ""}
      ${Array.isArray(g.patterns) && g.patterns.length ? `
        <h3>Muster</h3>
        <ul>${g.patterns.map(p=>`<li><code>${escapeHTML(p)}</code></li>`).join("")}</ul>` : ""
      }
      ${Array.isArray(g.examples) && g.examples.length ? `
        <h3>Beispiele</h3>
        <ul>${g.examples.map(ex=>`<li><strong>${escapeHTML(ex.ja||"")}</strong><br>${escapeHTML(ex.de||"")}</li>`).join("")}</ul>` : ""
      }
    </div>
    <div class="actions">
      <button onclick="goto('grammar')">Zurück</button>
      ${hasExercises ? `
        <button class="primary" onclick="goto('grammar/practice/${encodeURIComponent(String(id))}')">
          Übungen starten
        </button>
      ` : ""}
      <button class="danger" onclick="deleteGrammar('${String(id)}')">Löschen</button>
    </div>
  `;
}

function renderGrammarPractice(mount, id){
  const items = loadGrammar();
  const g = items.find(x => String(x.id) === String(id));

  if (!g){
    mount.innerHTML = "<p>Nicht gefunden.</p>";
    return;
  }

  const exercises = Array.isArray(g.exercises) ? g.exercises : [];
  if (!exercises.length){
    mount.innerHTML = `
      <h2>${escapeHTML(g.title || "Grammatik")}</h2>
      <div class="card">
        <p>Für diesen Eintrag sind noch keine Übungen hinterlegt.</p>
      </div>
      <div class="actions">
        <button onclick="goto('grammar/view/${encodeURIComponent(String(id))}')">Zurück zur Erklärung</button>
      </div>
    `;
    return;
  }

  let i = 0;
  let correct = 0;
  let wrong = 0;

  function norm(s){
    return String(s || "").trim().toLowerCase();
  }

  function renderStep(feedback){
    const ex = exercises[i];
    const total = exercises.length;
    const hasOptions = Array.isArray(ex.options) && ex.options.length > 0;

    mount.innerHTML = `
      <h2>Übung ${i+1} / ${total}: ${escapeHTML(g.title || "")}</h2>
      <div class="card">
        ${ex.prompt_de ? `<p><strong>Aufgabe:</strong> ${escapeHTML(ex.prompt_de)}</p>` : ""}
        ${ex.prompt_ja ? `<p>${escapeHTML(ex.prompt_ja)}</p>` : ""}

        ${ex.question_de && !ex.prompt_de ? `<p><strong>Aufgabe:</strong> ${escapeHTML(ex.question_de)}</p>` : ""}
        ${ex.question_ja && !ex.prompt_ja ? `<p>${escapeHTML(ex.question_ja)}</p>` : ""}

        ${hasOptions ? `
          <div id="gOpts" style="margin-top:.5rem;"></div>
        ` : `
          <div style="margin-top:.5rem;">
            <label>Lösung eingeben</label>
            <input id="gAnswer" autocomplete="off" />
            <button id="gCheckBtn">Prüfen</button>
          </div>
        `}
        <div id="gFeedback" class="${feedback ? "hint" : ""}" style="margin-top:.75rem;">
          ${feedback || ""}
        </div>
      </div>
      <div class="actions">
        <button id="gBack">${i === 0 ? "Abbrechen" : "Zurück"}</button>
        <button id="gNext"${hasOptions ? ' disabled style="opacity:.6;"' : ""}>
          ${i === total-1 ? "Fertig" : "Weiter"}
        </button>
      </div>
      <p style="margin-top:.5rem;">Richtig: ${correct}, Falsch: ${wrong}</p>
    `;

    const backBtn = document.getElementById("gBack");
    const nextBtn = document.getElementById("gNext");
    const fbEl = document.getElementById("gFeedback");

    backBtn.onclick = () => {
      if (i === 0){
        goto('grammar/view/' + encodeURIComponent(String(id)));
      } else {
        i--;
        renderStep("");
      }
    };

    function finishRound(){
      if (i < total - 1){
        i++;
        renderStep("");
      } else {
        const flawless = (wrong === 0);
        if (flawless){
          try { addProgressIfFlawless(1); } catch(e){}
        }
        mount.innerHTML = `
          <h2>Übungen zu: ${escapeHTML(g.title || "")}</h2>
          <div class="card">
            <p>Richtig: ${correct} / ${total}</p>
            <p>Falsch: ${wrong}</p>
            ${flawless ? `<p class="hint">Top! Fehlerfreie Runde – zählt als Aufgabe im Level-System.</p>` : ""}
          </div>
          <div class="actions">
            <button class="primary" onclick="goto('grammar/practice/${encodeURIComponent(String(id))}')">Nochmal</button>
            <button onclick="goto('grammar/view/${encodeURIComponent(String(id))}')">Zurück zur Erklärung</button>
          </div>
        `;
      }
    }

    if (hasOptions){
      const gOpts = document.getElementById("gOpts");

      const correctIndex =
        (typeof ex.correctIndex === "number" ? ex.correctIndex :
        (typeof ex.correct_index === "number" ? ex.correct_index : null));
      const correctText = ex.correctText || ex.correct || ex.answer;

      ex.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.onclick = () => {
          let isCorrect = false;

          if (correctIndex !== null){
            isCorrect = (idx === correctIndex);
          } else if (correctText != null){
            isCorrect = norm(opt) === norm(correctText);
          }

          if (isCorrect){
            correct++;
            fbEl.textContent = "✓ Richtig!";
          } else {
            wrong++;
            fbEl.textContent = "✗ Nicht ganz." + (ex.explanation_de ? " " + ex.explanation_de : "");
          }

          [...gOpts.querySelectorAll("button")].forEach(b => b.disabled = true);
          if (nextBtn){
            nextBtn.disabled = false;
            nextBtn.style.opacity = "1";
          }
        };
        gOpts.appendChild(btn);
      });

      if (nextBtn){
        nextBtn.onclick = () => finishRound();
      }
    } else {
      const inp = document.getElementById("gAnswer");
      const chk = document.getElementById("gCheckBtn");
      const correctText = ex.answer || ex.correct || ex.solution || "";
      const explanation = ex.explanation_de || "";

      function check(){
        const val = inp.value;
        if (!val.trim()) return;

        const ok = correctText ? norm(val) === norm(correctText) : false;

        if (ok){
          correct++;
          fbEl.textContent = "✓ Richtig!";
        } else {
          wrong++;
          fbEl.textContent = "✗ Nicht ganz." +
            (correctText ? " Erwartet: " + correctText : "") +
            (explanation ? " " + explanation : "");
        }

        inp.disabled = true;
        chk.disabled = true;
        if (nextBtn) nextBtn.disabled = false;
      }

      chk.onclick = check;
      inp.addEventListener("keydown", e => { if (e.key === "Enter") check(); });
      if (nextBtn){
        nextBtn.disabled = true;
        nextBtn.onclick = () => finishRound();
      }
      if (inp) inp.focus();
    }
  }

  renderStep("");
}

window.editCard = (setId, cardId) => {
  const s = state.sets.find(x => x.id === setId);
  const c = (s && s.cards) ? s.cards.find(x => x.id === cardId) : null;
  if (!c) return;
  const q = prompt("Neue Frage:", c.question);
  if (q == null) return;
  const a = prompt("Neue Antwort:", c.answer);
  if (a == null) return;
  c.question = q.trim();
  c.answer = a.trim();
  s.updatedAt = Date.now();
  save(); render();
};
window.deleteCard = (setId, cardId) => {
  const s = state.sets.find(x => x.id === setId);
  s.cards = s.cards.filter(c => c.id !== cardId);
  s.updatedAt = Date.now();
  save(); render();
};

window.deleteGrammar = (id) => {
  if (!id) return;
  if (!confirm("Diesen Grammatik­eintrag wirklich löschen?")) return;
  try {
    const items = Array.isArray(loadGrammar()) ? loadGrammar() : [];
    const next = items.filter(x => String(x.id) !== String(id));
    if (next.length === items.length) {
      alert("Eintrag nicht gefunden.");
      return;
    }
    saveGrammar(next);
    alert("Eintrag gelöscht.");
    // Falls du eine In-Memory-Spiegelung hältst, hier könnte man sie aktualisieren.
    // Danach zur Übersicht zurück:
    goto('grammar');
  } catch (e) {
    console.error(e);
    alert("Konnte den Eintrag nicht löschen.");
  }
};


const LEARN_CFG = { shuffle: true, repeatWrong: true };
function renderLearn(mount, setId){
  let hadMistake = false;
  const s = state.sets.find(x => x.id === setId);
  if (!s || !Array.isArray(s.cards) || !s.cards.length) { mount.innerHTML = `<p>Keine Karten.</p>`; return; }
  const cards = (typeof LEARN_CFG !== 'undefined' && LEARN_CFG.shuffle)
    ? [...s.cards].sort(() => Math.random() - 0.5)
    : [...s.cards];
  let i = 0, showAnswer = false, known = 0;

  function redraw(){
    const c = cards[i];
    mount.innerHTML = `
      <h2>Lernen: ${s.name}</h2>
      <div class="card">
        <div><strong>Frage ${i+1}/${cards.length}:</strong> ${escapeHTML(c.question)} <button id="speakQ" class="mini" title="Frage vorlesen">🔊</button></div>
        ${showAnswer ? `<div style="margin-top:.5rem;"><strong>Antwort:</strong> ${escapeHTML(c.answer)} <button id="speakA" class="mini" title="Antwort vorlesen">🔊</button></div>` : ``}
      </div>
      <div class="actions"><button class="danger" onclick="deleteSet('${s.id}')">Löschen</button>
        ${!showAnswer ? `<button id="reveal">Antwort zeigen</button>` : `
          <button id="know">Gewusst</button>
          <button id="dontknow">Nicht gewusst</button>`
        }
        <button id="next">${i < cards.length-1 ? "Nächste" : "Fertig"}</button>
      </div>
      <p>Punktestand (gewusst): ${known}</p>
    `;
    (function(){var _sq=$("#speakQ"); if(_sq) _sq.onclick=function(){ speak(c.question); };})();
    (function(){var _sa=$("#speakA"); if(_sa) _sa.onclick=function(){ speak(c.answer); };})();
    (function(){var __t=$("#reveal"); if(__t) __t.addEventListener("click", function(){ showAnswer = true; redraw(); });})();
    (function(){var __t=$("#know"); if(__t) __t.addEventListener("click", function(){ known++; next(); });})();
    (function(){var __t=$("#dontknow"); if(__t) __t.addEventListener("click", function(){ if (typeof LEARN_CFG !== "undefined" && LEARN_CFG.repeatWrong) { cards.push(cards[i]); } next(); });})();
    $("#next").addEventListener("click", () => next());
  }
  function next(){
    if (i < cards.length-1) { i++; showAnswer = false; redraw(); }
    else {
      if (!hadMistake && known === cards.length) { try { addProgressIfFlawless(1); } catch(e){} }
      mount.innerHTML = `<h2>Fertig!</h2><p>Gewusst: ${known} / ${cards.length}</p><button onclick="goto('set/${s.id}')">Zurück</button>`;
    }
  }
  redraw();
}

function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }

function renderQuiz(mount, setId){
  let hadMistake = false;
  const s = state.sets.find(x => x.id === setId);
  if (!s || s.cards.length < 2) return mount.innerHTML = `<p>Mindestens 2 Karten nötig.</p>`;
  const questions = shuffle(s.cards);
  let i = 0, score = 0;

  function makeOptions(correct, allCards){
    const wrongs = shuffle(allCards.filter(c => c !== correct)).slice(0,3).map(c => c.answer);
    return shuffle([correct.answer, ...wrongs]);
  }
  function redraw(){
    const c = questions[i];
    const options = makeOptions(c, s.cards);
    mount.innerHTML = `
      <h2>Quiz: ${s.name}</h2>
      <div class="card">
        <div><strong>Frage ${i+1}/${questions.length}:</strong> ${escapeHTML(c.question)}</div>
        <div id="opts" style="margin-top:.5rem;"></div>
        <div style="margin-top:.5rem;">Punkte: ${score}</div>
      </div>
    `;
    const opts = $("#opts");
    options.forEach(opt => {
      const btn = document.createElement("button");
      btn.textContent = opt;
      
      btn.onclick = () => {
        const correct = (opt === c.answer);
        if (correct) { score++; }
        if (i < questions.length-1) {
          i++;
          redraw();
        } else {
          if (score === questions.length) { try { addProgressIfFlawless(1); } catch(e){} }
          mount.innerHTML = `
            <h2>Ergebnis</h2>
            <p>Punkte: ${score} / ${questions.length}</p>
            <div class="actions">
              <button onclick="goto('quiz/${s.id}')">Nochmal</button>
              <button onclick="goto('set/${s.id}')">Zurück</button>
            </div>
          `;
        }
      };

      opts.appendChild(btn);
    });
  }
  redraw();
}

/* -------- Timed Match Mode (60s, 8 sichtbar, 20 insgesamt, -2s) -------- */
function renderMatch(mount, setId){
  const s = state.sets.find(x => x.id === setId);
  if (!s || s.cards.length < 2) return mount.innerHTML = `<p>Zu wenige Karten für Match.</p>`;

  const ROUND_TARGET = Math.min(20, s.cards.length);
  const BOARD_SIZE = Math.min(8, ROUND_TARGET);
  let pool = shuffle(s.cards).slice(0, ROUND_TARGET);
  let board = [];
  let remainingMs = 60000;
  let timer = null;
  let solved = 0, mistakes = 0;

  while (board.length < BOARD_SIZE && pool.length) {
    const c = pool.shift();
    board.push({ id: c.id, q: c.question, a: c.answer });
  }

  function startTimer(){
    timer = setInterval(() => {
      remainingMs -= 1000;
      if (remainingMs <= 0) { remainingMs = 0; clearInterval(timer); finish(); }
      $("#time").textContent = fmtTime(remainingMs);
    }, 1000);
  }
  function timePenalty(ms){
    remainingMs = Math.max(0, remainingMs - ms);
    if (remainingMs === 0) { clearInterval(timer); finish(); }
    $("#time").textContent = fmtTime(remainingMs);
  }

  let selectedQ = null, selectedA = null;

  mount.innerHTML = `
    <h2>Match (60s): ${s.name}</h2>
    <div class="card">
      <div>Runde: <strong id="solved">${solved}</strong> / ${ROUND_TARGET}
        &nbsp; | &nbsp; Fehler: <strong id="mistakes">${mistakes}</strong>
        &nbsp; | &nbsp; <span class="timer">Zeit: <strong id="time">${fmtTime(remainingMs)}</strong></span>
      </div>
    </div>
    <div class="match-board">
      <div class="match-col" id="colQ"><h3>Begriffe</h3></div>
      <div class="match-col" id="colA"><h3>Definitionen</h3></div>
    </div>
    <div class="actions" style="margin-top:1rem;">
      <button onclick="goto('match/${s.id}')" title="Neue Runde starten">Neu starten</button>
      <button onclick="goto('set/${s.id}')">Zurück</button>
    </div>
  `;

  function redrawColumns(){
    const qs = shuffle(board.map(b => ({ id: b.id, text: b.q })));
    const as = shuffle(board.map(b => ({ id: b.id, text: b.a })));
    const colQ = $("#colQ"); const colA = $("#colA");
    colQ.innerHTML = "<h3>Begriffe</h3>";
    colA.innerHTML = "<h3>Definitionen</h3>";
    qs.forEach(item => {
      const el = document.createElement("button");
      el.className = "match-item" + ((selectedQ && selectedQ.id) === item.id ? " selected" : "");
      el.textContent = item.text;
      el.onclick = () => { selectedQ = item; checkPair(); redrawColumns(); };
      colQ.appendChild(el);
    });
    as.forEach(item => {
      const el = document.createElement("button");
      el.className = "match-item" + ((selectedA && selectedA.id) === item.id ? " selected" : "");
      el.textContent = item.text;
      el.onclick = () => { selectedA = item; checkPair(); redrawColumns(); };
      colA.appendChild(el);
    });
  }

  function checkPair(){
    if (!selectedQ || !selectedA) return;
    if (selectedQ.id === selectedA.id) { board = board.filter(b => b.id !== selectedQ.id);
      solved++; $("#solved").textContent = solved;
      if (pool.length) {
        const c = pool.shift();
        board.push({ id: c.id, q: c.question, a: c.answer });
      }
    } else {
      mistakes++; $("#mistakes").textContent = mistakes; timePenalty(2000);
    }
    selectedQ = null; selectedA = null;
    if (solved >= ROUND_TARGET) { clearInterval(timer); finish(); }
  }

  function finish(){
    if (solved >= ROUND_TARGET && mistakes === 0) { try { addProgressIfFlawless(1); } catch(e){} }
$("#app").innerHTML = `
      <h2>Ergebnis – Match</h2>
      <div class="card">
        <p>Gelöst: <strong>${solved}</strong> / ${ROUND_TARGET}</p>
        <p>Fehler: <strong>${mistakes}</strong></p>
        <p>Verbrauchte Zeit: <strong>${fmtTime(60000 - remainingMs)}</strong></p>
      </div>
      <div class="actions">
        <button class="primary" onclick="goto('match/${s.id}')">Nochmal</button>
        <button onclick="goto('set/${s.id}')">Zum Set</button>
        <button onclick="goto('home')">Start</button>
      </div>
    `;
  }

  function fmtTime(ms){
    const s = Math.max(0, Math.ceil(ms/1000));
    const mm = String(Math.floor(s/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    return `${mm}:${ss}`;
  }

  redrawColumns();
  startTimer();
}





// --- TTS Helpers (Flashcards) ---
function detectLang(t){
  const s = String(t||"");
  if (/[ぁ-んァ-ン一-龯]/.test(s)) return "ja-JP";
  if (/[äöüÄÖÜß]/.test(s) || /\b(und|oder|Bitte|Danke|Hallo|Tschüss|Auf Wiedersehen)\b/i.test(s)) return "de-DE";
  // fallback: simple heuristic
  return /[a-zA-Z]/.test(s) ? "en-US" : "ja-JP";
}
function speak(t){
  if (!('speechSynthesis' in window) || !t) return;
  try {
    const u = new SpeechSynthesisUtterance(String(t));
    u.lang = detectLang(t);
    speechSynthesis.speak(u);
  } catch(e){}
}

// --- Speech-Recognition Helpers (Dialogmodus) ---
const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition || null;

function hasSpeechRecognition(){
  return !!SpeechRec;
}

// einfache Normalisierung japanischer Texte für den Vergleich
function normalizeJa(str){
  return String(str || "")
    .toLowerCase()
    .replace(/\s+/g, "")
    .replace(/[！？!?.。､、〜～\-—–'"「」『』（）()［］\[\]]/g, "");
}

// prüft, ob gesprochener Text „nah genug“ an der Zielphrase ist
function spokenMatchesExpected(spoken, expected){
  if (!spoken || !expected) return false;
  const s = normalizeJa(spoken);
  const e = normalizeJa(expected);
  if (!s || !e) return false;
  // „nah genug“, wenn einer den anderen enthält
  return s.includes(e) || e.includes(s);
}



/* -------- Buchstabieren (DE -> Fremdsprache) -------- */
function renderSpell(mount, setId) {
  const s = state.sets.find(x => x.id === setId);
  if (!s || !s.cards.length) { mount.innerHTML = `<p>Keine Karten.</p>`; return; }

  const pool = s.cards.filter(c => isSpellingCandidate(c));
  if (!pool.length) { mount.innerHTML = `<p>Dieses Set enthält keine passenden Vokabelkarten für die Buchstabierfunktion.</p>`; return; }

  const originalOrder = shuffle(pool);
  let order = originalOrder.slice();
  let i = 0;
  let tries = 0;
  let phase = "main";
  let forcedRomaji = false;

  const mistakesMain = new Map();
  const keyOf = (c) => c.id || c.question;
  const incMistake = (c) => {
    if (phase !== "main") return;
    const k = keyOf(c);
    mistakesMain.set(k, (mistakesMain.get(k) || 0) + 1);
  };
  const getMistakes = (c) => mistakesMain.get(keyOf(c)) || 0;

  function finishPhase() {
    if (phase === "main") {
      const problems = originalOrder.filter(c => getMistakes(c) >= 2);
      if (problems.length) {
        phase = "review";
        order = problems.slice();
        i = 0; tries = 0;
        redraw(); return;
      }
      return showStats();
    } else {
      return showStats();
    }
  }

  function showStats() {
    const total = originalOrder.length;
    let correct = 0, wrong = 0;
    originalOrder.forEach(c => (getMistakes(c) === 0 ? (correct++) : (wrong++)));
    const problems = originalOrder
      .map(c => ({ card: c, m: getMistakes(c) }))
      .filter(x => x.m >= 2);
    if (wrong === 0 && total > 0) { try { addProgressIfFlawless(1); } catch (e) { } }

    mount.innerHTML = `
      <h2>Ergebnis – Buchstabieren</h2>
      <div class="card">
        <p>Richtig (ohne Fehler): <strong>${correct}</strong> / ${total}</p>
        <p>Falsch bzw. mit Fehlern: <strong>${wrong}</strong> / ${total}</p>
      </div>
      ${problems.length ? `
        <div class="card">
          <h3>Problemkinder (≥ 2 Fehler im Hauptdurchlauf)</h3>
          <ul>
            ${problems.map(({ card, m }) => {
              const lab = extractJaScriptFromQuestion(card.question);
              const badge = lab ? `<span class="badge">${lab}</span>` : "";
              return `<li>${escapeHTML(card.question)} ${badge} – Fehler: ${m}</li>`;
            }).join("")}
          </ul>
        </div>
      ` : ``}
      <div class="actions">
        <button class="primary" onclick="goto('spell/${s.id}')">Nochmal</button>
        <button onclick="goto('set/${s.id}')">Zum Set</button>
        <button onclick="goto('home')">Start</button>
      </div>
    `;
  }

  function redraw() {
    if (i >= order.length) return finishPhase();
    const c = order[i];
    const { prompt, expected } = getPromptAndExpected(c);
    const scriptLabel = extractJaScriptFromQuestion(c.question);
    const romajiVariant = findRomajiVariant(c, s);
    const currExpected = (forcedRomaji && romajiVariant) ? romajiVariant.answer : expected;
    const currScript = (forcedRomaji && romajiVariant)
      ? 'romaji'
      : (scriptLabel ? scriptLabel.toLowerCase() : null);

    mount.innerHTML = `
      <h2>Buchstabieren: ${escapeHTML(s.name)} ${phase === "review" ? '<span class="badge">Mini-Wiederholung</span>' : ''}</h2>
      <div class="card">
        <div><strong>Bedeutung (DE):</strong> ${escapeHTML(prompt)}</div>
        ${(currScript && currScript !== 'romaji') ? `<div class="hint">Schrift: <span class="badge">${scriptLabel}</span></div>` : ``}
        ${(currScript === 'romaji') ? `<div class="hint">Schrift: <span class="badge">Romaji (umgestellt)</span></div>` : ``}
        <input id="spellInput" class="spell-input"
          placeholder="Antwort ${currScript ? `(${currScript === 'romaji' ? 'Romaji' : scriptLabel})` : ''}"
          autocomplete="off" />
        <div class="hint">3 Versuche pro Wort. Wörter mit ≥ 2 Fehlern werden am Ende nochmals abgefragt.</div>
        <div style="margin-top:.5rem;">Aktuelles Wort: ${i + 1} / ${order.length} | Phase: ${phase === 'main' ? 'Hauptdurchlauf' : 'Mini-Wiederholung'}</div>
      </div>
      <div class="actions">
        <button id="checkBtn" class="primary">Prüfen</button>
        <button id="skipBtn">Überspringen</button>
        ${(scriptLabel && scriptLabel !== 'Romaji' && romajiVariant)
          ? `<button id="romajiBtn" title="Diese Karte in Romaji beantworten">Auf Romaji umstellen</button>`
          : ``}
        <button onclick="goto('set/${s.id}')">Zurück</button>
      </div>

    `;

    
 if (!document.getElementById("writeCanvas")) {
    const container = document.getElementById("write-container");
    container.innerHTML = `
      <section class="write-pad" style="margin-top:1rem;">
        <div class="write-pad-controls">
          <button id="wp-kana" type="button">Kana</button>
          <button id="wp-kanji" type="button">Kanji</button>
          <button id="wp-undo" type="button">Undo</button>
          <button id="wp-clear" type="button">Löschen</button>
          <label for="wp-width" class="sr-only">Strichbreite</label>
          <input id="wp-width" type="range" min="2" max="30" value="10">
        </div>
        <div class="write-pad-stage">
          <canvas id="writeCanvas"></canvas>
          <div id="writeHint" aria-hidden="true"></div>
        </div>
        <span id="wp-current-kana" hidden></span>
        <span id="wp-current-kanji" hidden></span>
      </section>
    `;



    
 document.getElementById("wp-current-kana").textContent  = c.kana || "";
    document.getElementById("wp-current-kanji").textContent = c.kanji || "";
    setupWritingPad(); // <— siehe JS unten
}

    // Schreibübung initialisieren
    setTimeout(() => {
      if (window.WritingPractice) {
        WritingPractice.setVocab({ kana: c.kana, kanji: c.kanji });
      }
    }, 0);

    $("#spellInput").focus();
    $("#checkBtn").onclick = () => {
      const val = $("#spellInput").value.trim();
      const ok = currScript
        ? equalsJaByScript(val, currExpected, currScript)
        : (normalize(val) === normalize(currExpected));

      if (ok) { i++; tries = 0; forcedRomaji = false; redraw(); }
      else {
        tries++; incMistake(c);
        if (tries >= 3) {
          alert(`Gesucht war: ${currExpected}`);
          i++; tries = 0; forcedRomaji = false; redraw();
        } else {
          alert(`Leider falsch. Versuch ${tries}/3.`);
          $("#spellInput").focus();
        }
      }
    };
    $("#skipBtn").onclick = () => { i++; tries = 0; forcedRomaji = false; redraw(); };
    const rb = $("#romajiBtn");
    if (rb) rb.onclick = () => { forcedRomaji = true; redraw(); };
  }

  redraw();
}



// Sucht im selben Set eine Romaji-Variante zur gleichen DE-Grundlage
function findRomajiVariant(card, set){
  const m = /^(.+)\s+–\s+\((Kana|Kanji|Romaji)\)$/.exec(String(card.question||""));
  if (!m) return null;
  const de = m[1];
  return set.cards.find(cc => cc !== card && cc.question === `${de} – (Romaji)` ) || null;
}



// --- Helpers für JP-Schrift ---
function extractJaScriptFromQuestion(q){
  const m = /^.+\s+–\s+\((Kana|Kanji|Romaji)\)$/.exec(String(q||""));
  return m ? m[1] : null;
}
function kataToHira(str){
  return String(str).replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
}
function normalizeRomaji(str){
  return String(str)
    .toLowerCase()
    .normalize('NFKD')
    .replace(/[\u0304\u0306\u0302]/g,'')
    .replace(/[\s\-]/g,'');
}
function normalizeKana(str){
  return kataToHira(String(str)).replace(/\s+/g,'');
}
function equalsJaByScript(user, expected, script){
  if (script === 'romaji') return normalizeRomaji(user) === normalizeRomaji(expected);
  if (script === 'kana')   return normalizeKana(user) === normalizeKana(expected);
  return String(user).replace(/\s+/g,'') === String(expected).replace(/\s+/g,'');
}

// Heuristik: Karte ist tauglich, wenn DE auf der Frage steht (unser JP‑Seed) ODER die Antwort deutsch aussieht (Englisch‑Seed)
function isSpellingCandidate(c){
  if (/^.+\s+–\s+\((Kana|Kanji|Romaji)\)$/.test(c.question)) return true; // JP Seeds
  return isLikelyGerman(c.answer) && !isLikelyGerman(c.question); // z.B. Hello -> Hallo
}
function getPromptAndExpected(c){
  if (/^(.+)\s+–\s+\((Kana|Kanji|Romaji)\)$/.test(c.question)) {
    const de = c.question.replace(/\s+–\s+\((?:Kana|Kanji|Romaji)\)$/, "");
    return { prompt: de, expected: c.answer };
  }
  // sonst DE ist die Antwort
  return { prompt: c.answer, expected: c.question };
}
function isLikelyGerman(text){
  return /[äöüÄÖÜß]/.test(text) || /\b(und|oder|Hallo|Danke|Bitte|Auf|Wiedersehen|Freund|Entschuldigung)\b/i.test(text);
}
function normalize(s){
  return String(s).trim().replace(/\s+/g," ").toLowerCase();
}

// --- Helpers speziell für JP-Schrift (Anzeige + Auswertung) ---






// Utility
function escapeHTML(str){
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

// Export/Import (JSON/CSV/XLSX)
const _exportBtn = document.getElementById("exportBtn");
if (_exportBtn) _exportBtn.addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(state.sets, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "quizcards_sets.json";
  a.click();
});

const _importFile = document.getElementById("importFile");
if (_importFile) _importFile.addEventListener("change", async (e) => {
  const file = (e && e.target && e.target.files && e.target.files[0]);
  if (!file) return;
  try {
    if (/\.(xlsx|xls)$/i.test(file.name)) {
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, { type: "array" });
      // Erwartet Spalten: de,kana,kanji,romaji  (oder question,answer)
      const allSets = [];
      wb.SheetNames.forEach(sheet => {
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval:"" });
        const cards = [];
        rows.forEach(r => {
          if (r.de && (r.kana || r.kanji || r.romaji)) {
            if (r.kana)  cards.push({ id: crypto.randomUUID(), question: `${r.de} – (Kana)`,  answer: String(r.kana) });
            if (r.kanji) cards.push({ id: crypto.randomUUID(), question: `${r.de} – (Kanji)`, answer: String(r.kanji) });
            if (r.romaji)cards.push({ id: crypto.randomUUID(), question: `${r.de} – (Romaji)`,answer: String(r.romaji) });
          } else if (r.question && r.answer) {
            cards.push({ id: crypto.randomUUID(), question: String(r.question), answer: String(r.answer) });
          }
        });
        if (cards.length) allSets.push({ id: sheet.toLowerCase().replace(/[^\w]+/g,"-")+"-"+Date.now(), name: sheet, cards, createdAt: Date.now(), updatedAt: Date.now() });
      });
      if (!allSets.length) throw new Error("Keine verwertbaren Spalten gefunden.");
      state.sets.push(...allSets); save(); render(); alert(`Importiert: ${allSets.length} Set(s).`);
    } else if (/\.csv$/i.test(file.name)) {
      const text = await file.text();
      const rows = text.split(/\r?\n/).map(l=>l.split(","));
      const header = rows.shift().map(h=>h.trim().toLowerCase());
      const idx = (k)=> header.indexOf(k);
      const cards = [];
      rows.forEach(r => {
        if (idx("de")>-1 && (idx("kana")>-1 || idx("kanji")>-1 || idx("romaji")>-1)) {
          const de = r[idx("de")]||"";
          if (r[idx("kana")])   cards.push({ id: crypto.randomUUID(), question: `${de} – (Kana)`,  answer: r[idx("kana")] });
          if (r[idx("kanji")])  cards.push({ id: crypto.randomUUID(), question: `${de} – (Kanji)`, answer: r[idx("kanji")] });
          if (r[idx("romaji")]) cards.push({ id: crypto.randomUUID(), question: `${de} – (Romaji)`,answer: r[idx("romaji")] });
        } else if (idx("question")>-1 && idx("answer")>-1) {
          cards.push({ id: crypto.randomUUID(), question: r[idx("question")], answer: r[idx("answer")] });
        }
      });
      if (!cards.length) throw new Error("CSV enthielt keine passenden Spalten.");
      const name = (prompt("Name für das neue Set:", "Import (CSV)") || "Import (CSV)").trim();
      state.sets.push({ id: name.toLowerCase().replace(/[^\w]+/g,"-")+"-"+Date.now(), name, cards, createdAt: Date.now(), updatedAt: Date.now() });
      save(); render(); alert(`Importiert: ${cards.length} Karten.`);
    } else {
      const text = await file.text();

       const data = JSON.parse(text);
      const existing = Array.isArray(state.sets) ? state.sets : [];
      const now = Date.now();

      if (Array.isArray(data)) {
        // ✅ Sets importieren (wie bisher)
        const incoming = data.filter(x => x && x.id && x.name && Array.isArray(x.cards));
        const byId = new Map(existing.map(s => [s.id, s]));
        incoming.forEach(s => { if (!byId.has(s.id)) byId.set(s.id, s); });
        state.sets = [...byId.values()];
        save(); render();
        alert(`Import erfolgreich ✔ (hinzugefügt: ${incoming.length})`);

      } else if (data && typeof data === "object" && Array.isArray(data.grammar)) {
        // 🆕 Grammatik importieren: erwartet { grammar: [...] }
        const incomingG = data.grammar.filter(g => g && g.id && g.title);
        incomingG.forEach(g => {
          if (!g.createdAt) g.createdAt = now;
          if (!g.updatedAt) g.updatedAt = now;
        });
        const prev = Array.isArray(loadGrammar()) ? loadGrammar() : [];
        const map = new Map(prev.map(x => [String(x.id), x]));
        incomingG.forEach(x => map.set(String(x.id), x)); // merge by id (replace/update)
        saveGrammar([...map.values()]);
        render();
        alert(`Grammatik importiert ✔ (${incomingG.length} Einträge)`);

      } else if (data && typeof data === "object" && Array.isArray(data.chats)) {
        // 🆕 Dialog-Chats importieren: erwartet { chats: [ { level, threads:[...] }, ... ] }
        const incomingC = data.chats.filter(l =>
          l &&
          typeof l.level !== "undefined" &&
          Array.isArray(l.threads)
        );

        const prevChats = Array.isArray(loadChats()) ? loadChats() : [];
        const byLevel = new Map(prevChats.map(l => [Number(l.level), l]));

        incomingC.forEach(lv => {
          const lvNum = Number(lv.level);
          const curr = byLevel.get(lvNum) || { level: lvNum, threads: [] };
          const byId = new Map((curr.threads || []).map(t => [t.id, t]));

          (lv.threads || []).forEach(t => {
            if (!t || !t.id) return;
            // eingehende Threads ersetzen vorhandene gleichen id
            byId.set(String(t.id), t);
          });

          curr.threads = [...byId.values()];
          byLevel.set(lvNum, curr);
        });

        saveChats([...byLevel.values()]);
        render();
        alert(`Chats importiert ✔ (${incomingC.length} Level-Einträge)`);
      } else {
        throw new Error("Ungültiges JSON-Format: Array von Sets oder {grammar:[...]} erwartet.");
      }
    }
  } catch (err) { alert("Import fehlgeschlagen: " + err.message); }
  finally { e.target.value = ""; }
});

/* -------- Genki‑Import (3rd Ed) – bevorzugt -------- */
async function genkiImportWizard(){
  const confirmed = confirm("Genki‑Import (3rd Edition)\n\nIch versuche zuerst, eine vorbereitete JSON‑Liste direkt aus dem Genki‑Repo zu laden. Falls das scheitert, wirst du nach einer JSON‑URL oder Datei (XLSX/CSV/JSON) gefragt.\n\nWeiter?");
  if (!confirmed) return;

  // 1) Versuch: gut bekannte Raw‑JSON‑URLs (falls Maintainer sie bereitstellt)
  const candidateJSON = [
    "https://sethclydesdale.github.io/genki-study-resources/lessons-3rd/appendix/dictionary/",
  ];

  for (const url of candidateJSON){
    try {
      const res = await fetch(url, { mode: "cors" });
      if (!res.ok) continue;
      const ct = (res.headers.get("content-type")||"").toLowerCase();
      if (ct.includes("application/json")) {
        const json = await res.json();
        const added = absorbGenkiJSON(json);
        if (added > 0) { alert(`Genki‑Import abgeschlossen: ${added} Karten hinzugefügt.`); save(); render(); return; }
      }
    } catch {}
  }

  const fromUrl = prompt("Keine direkt nutzbare JSON‑Liste gefunden.\n\nBitte OPTIONAL eine JSON‑URL aus dem Genki‑Repo (raw.githubusercontent.com …) einfügen.\nOder einfach Abbrechen, um XLSX/CSV/JSON per Datei‑Import zu wählen.");
  if (fromUrl) {
    try {
      const res = await fetch(fromUrl, { mode: "cors" });
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      const json = await res.json();
      const added = absorbGenkiJSON(json);
      if (added > 0) { alert(`Genki‑Import abgeschlossen: ${added} Karten hinzugefügt.`); save(); render(); return; }
      else throw new Error("JSON hatte kein erwartetes Format.");
    } catch (e) {
      alert("Konnte JSON nicht laden: " + e.message);
    }
  }

  alert("Bitte verwende jetzt den Datei‑Import (JSON/CSV/XLSX) oben im Menü.\nHinweis: XLSX‑Spalten: de, kana, kanji, romaji");
}

// Nimmt ein JSON im Format [{de,kana,kanji,romaji}] oder [{question,answer}] entgegen
function absorbGenkiJSON(json){
  let added = 0;
  const name = "Genki – 3rd Ed (Import)";
  const setId = "genki-3rd-import";
  let set = state.sets.find(s => s.id === setId);
  if (!set) { set = { id: setId, name, cards: [], createdAt: Date.now(), updatedAt: Date.now() }; state.sets.push(set); }
  const pushCard = (q,a)=>{ set.cards.push({ id: crypto.randomUUID(), question:q, answer:a }); added++; };

  if (Array.isArray(json)) {
    json.forEach(r => {
      if (r.de && (r.kana || r.kanji || r.romaji)) {
        if (r.kana)  pushCard(`${r.de} – (Kana)`,  String(r.kana));
        if (r.kanji) pushCard(`${r.de} – (Kanji)`, String(r.kanji));
        if (r.romaji)pushCard(`${r.de} – (Romaji)`,String(r.romaji));
      } else if (r.question && r.answer) {
        pushCard(String(r.question), String(r.answer));
      }
    });
  } else if (json && typeof json === "object" && Array.isArray(json.words)) {
    json.words.forEach(w => {
      if (w.de && (w.kana || w.kanji || w.romaji)) {
        if (w.kana)  pushCard(`${w.de} – (Kana)`,  String(w.kana));
        if (w.kanji) pushCard(`${w.de} – (Kanji)`, String(w.kanji));
        if (w.romaji)pushCard(`${w.de} – (Romaji)`,String(w.romaji));
      }
    });
  }
  set.updatedAt = Date.now();
  return added;
}

// Navbar: Zurücksetzen (lokale Daten löschen und Seeds neu anlegen)
const _rb = document.getElementById("resetBtn");
if (_rb) {
  _rb.addEventListener("click", () => {
    if (confirm("Alle lokalen Daten löschen und Standard-Seeds neu anlegen?")) {
      try {
        localStorage.setItem("quizcards_backup_v1", localStorage.getItem(STORAGE_KEY_V2) || "[]");
localStorage.removeItem(STORAGE_KEY_V2);
localStorage.removeItem(STORAGE_KEY_V1);
localStorage.removeItem("quizcards_chats_v1"); // Altbestand
localStorage.removeItem("quizcards_chats_v2"); // neuer Key
      } catch {}
      state.sets = [];
      ensureSeedSets();
      save();
      location.reload();
    }
  });
}

// Init
load();
ensureSeedLevels();   // <-- NEU: Level-Seeds sofort bereitstellen
render();



/* ===== Lesegeschichten (Stories) ===== */

// --- Bridge: Level-Stories auch als Lesegeschichten anzeigen ---
// Nimmt den ersten vorhandenen/nicht-leeren Wert aus mehreren Schlüsseln

function pick(obj, keys, fallback=""){
  for (const k of keys){
    const v = obj && obj[k];
    if (typeof v === "string" && v.trim()) return v;
  }
  return fallback;
}
function pickArr(obj, keys){
  for (const k of keys){
    const v = obj && obj[k];
    if (Array.isArray(v)) return v;
  }
  return [];
}
function pickNum(obj, keys){
  for (const k of keys){
    const v = obj && obj[k];
    if (typeof v === "number" && !Number.isNaN(v)) return v;
  }
  return undefined;
}

function levelsToStories(levels){
  return (levels||[])
    .map(lvl => {
      // mögliche Feldnamen des Factories L(...)
      const ja = pick(lvl, ["story_ja","text_ja","ja","jp","jpn","japanese"]);
      const de = pick(lvl, ["story_de","text_de","de","german"]);
      const vocab = pickArr(lvl, ["vocab","words","lex","glossary"]);

      // Titel + Level/ID tolerant bestimmen
      const title = pick(lvl, ["title","name","label"], "(ohne Titel)");
      const lvlNo = pickNum(lvl, ["level","lvl","no","id"]);

      // Nur Storys mit japanischem Text aufnehmen
      if (!ja) return null;

      return {
        id: "lvl-"+(lvl.id ?? lvlNo ?? title),   // stabile ID aus ID/Level/Titel
        title: `${lvlNo ? (lvlNo+". ") : ""}${title}`,
        level: "Level",
        vocab,
        text_ja: ja,     // vereinheitlichte Ziel-Felder für die Anzeige
        text_de: de,
        __source: "level"
      };
    })
    .filter(Boolean);
}

// Liefert Stories + Level-Stories in EINER Liste
function listAllStories(){
  const userStories = loadStories();      // gespeicherte Stories
  const levelStories = levelsToStories(loadLevels()); // virtuelle Stories
  // IDs dürfen sich nicht überschneiden (userStories behalten Priorität)
  const byId = new Map(userStories.map(s => [s.id, s]));
  levelStories.forEach(s => { if (!byId.has(s.id)) byId.set(s.id, s); });
  return [...byId.values()];
}

// Story aus beiden Quellen holen
function getStoryById(id){
  // 1) User-Stories?
  const direct = loadStories().find(s => s.id === id);
  if (direct) return direct;

  // 2) Level-Story?
  const allLvls = loadLevels() || [];
  const raw = allLvls.find(l => ("lvl-"+(l.id ?? l.level ?? l.title)) === id);
  if (!raw) return null;

  // gleiche Normalisierung wie oben
  const ja = pick(raw, ["story_ja","text_ja","ja","jp","jpn","japanese"]);
  const de = pick(raw, ["story_de","text_de","de","german"]);
  const vocab = pickArr(raw, ["vocab","words","lex","glossary"]);
  const title = pick(raw, ["title","name","label"], "(ohne Titel)");
  const lvlNo = pickNum(raw, ["level","lvl","no","id"]);

  return {
    id,
    title: `${lvlNo ? (lvlNo+". ") : ""}${title}`,
    level: "Level",
    vocab,
    text_ja: ja,
    text_de: de,
    __source: "level"
  };
}

const STORIES_KEY = "quizcards_stories_v1";

function loadStories(){
  try { return JSON.parse(localStorage.getItem(STORIES_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveStories(arr){
  localStorage.setItem(STORIES_KEY, JSON.stringify(arr || []));
}
function ensureSeedStories(){
  const cur = loadStories();
  if (cur && cur.length) return;
  const seed = [{
    id: "story-001",
    title: "ハンナとリサ",
    level: "A1",
    vocab: [
      {"de":"Freundin","kana":"ともだち","kanji":"友達","romaji":"tomodachi"},
      {"de":"heute","kana":"きょう","kanji":"今日","romaji":"kyou"},
      {"de":"nach Hause gehen","kana":"かえる","kanji":"帰る","romaji":"kaeru"},
      {"de":"Haus","kana":"いえ","kanji":"家","romaji":"ie"},
      {"de":"Abend","kana":"よる","kanji":"夜","romaji":"yoru"}
    ],
    text_ja: "ハンナは今日、友達のリサの家に行きました。夜に帰りました。",
    text_de: "Hanna war heute bei ihrer Freundin Lisa und ging abends nach Hause."
  }];
  saveStories(seed);
}

function renderStories(mount){
  ensureSeedStories();
  ensureSeedLevels();   // <-- NEU: Level-Stories stehen garantiert bereit
  const stories = listAllStories();
  mount.innerHTML = `
    <h2>Lesegeschichten</h2>
    <div class="actions">
      <button class="primary" onclick="goto('new-story')">Neue Geschichte</button>
      <label class="import-label">Import (JSON)
        <input type="file" id="importStoryFile" accept="application/json" hidden />
      </label>
    </div>
    <div class="grid" id="storiesGrid"></div>
  `;
  const grid = document.getElementById("storiesGrid");
  if(!stories.length){
    grid.innerHTML = `<div class="card"><p>Noch keine Geschichten. Lege mit „Neue Geschichte“ los.</p></div>`;
  } else {
    grid.innerHTML = stories.map(st => {
  const readonly = st.__source === 'level';
  return `
    <div class="card">
      <h3>${escapeHTML(st.title || '(ohne Titel)')} ${st.level?`<span class="badge">${st.level}</span>`:""}</h3>
      <div class="hint">${(st.vocab||[]).length} Vokabeln</div>
      <div class="actions">
        <button class="primary" onclick="goto('story/read/${st.id}')">Lesen</button>
        ${readonly ? '' : `
          <button onclick="exportStory('${st.id}')">Exportieren</button>
          <button onclick="goto('story/edit/${st.id}')">Bearbeiten</button>
          <button class="danger" onclick="deleteStory('${st.id}')">Löschen</button>
        `}
      </div>
    </div>
  `;
}).join("");
  }

  const fileInput = document.getElementById("importStoryFile");
  fileInput.onchange = async (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const txt = await f.text();
    try{
      const obj = JSON.parse(txt);
      const arr = Array.isArray(obj) ? obj : [obj];
      const storiesNow = loadStories();
      arr.forEach(o => { if(!o.id) o.id = 'story-' + Date.now() + '-' + Math.random().toString(36).slice(2,8); });
      saveStories(storiesNow.concat(arr));
      alert(`${arr.length} Geschichte(n) importiert.`);
      goto('stories');
    }catch(err){
      alert("Ungültige JSON-Datei für Geschichten.");
    }
  };
}
function exportStory(id){
  const s = loadStories().find(x=>x.id===id);
  if(!s){ alert('Story nicht gefunden.'); return; }
  const blob = new Blob([JSON.stringify(s, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (s.title || 'story') + '.json';
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 500);
}
function deleteStory(id){
  if(!confirm("Diese Geschichte löschen?")) return;
  const stories = loadStories().filter(s => s.id !== id);
  saveStories(stories);
  goto('stories');
}

function renderNewStory(mount, id){
  const editing = !!id;
  const stories = loadStories();
  const story = editing ? (stories.find(s => s.id === id) || {id, title:'', level:'A1', text_ja:'', text_de:'', vocab:[]})
                        : {id:'story-'+Date.now(), title:'', level:'A1', text_ja:'', text_de:'', vocab:[]};

  function vocabToTextarea(vocab){
    return (vocab||[]).map(v => `${v.de||''} | ${v.kana||''} | ${v.kanji||''} | ${v.romaji||''}`).join("\n");
  }
  function textareaToVocab(txt){
    const rows = (txt||'').split(/\\r?\\n/).map(l => l.trim()).filter(Boolean);
    return rows.map(line => {
      const [de,kana,kanji,romaji] = line.split("|").map(s => (s||'').trim());
      return {de,kana,kanji,romaji};
    });
  }

  mount.innerHTML = `
    <h2>${editing ? 'Geschichte bearbeiten' : 'Neue Geschichte'}</h2>
    <div class="card">
      <label>Titel</label>
      <input id="stTitle" value="${escapeHTML(story.title||'')}" />
      <label>Niveau</label>
      <select id="stLevel">
        <option value="A1">A1</option>
        <option value="A2">A2</option>
        <option value="B1">B1</option>
      </select>
      <label>Vokabeln (eine pro Zeile, Format: de | kana | kanji | romaji)</label>
      <textarea id="stVocab" rows="8" placeholder="Freundin | ともだち | 友達 | tomodachi
heute | きょう | 今日 | kyou
nach Hause gehen | かえる | 帰る | kaeru">${escapeHTML(vocabToTextarea(story.vocab))}</textarea>
      <label>Geschichte (Japanisch, ohne Romaji)</label>
      <textarea id="stTextJa" rows="5" placeholder="ハンナは今日、友達のリサの家に行きました。夜に帰りました。">${escapeHTML(story.text_ja||'')}</textarea>
      <label>Übersetzung (Deutsch)</label>
      <textarea id="stTextDe" rows="5" placeholder="Hanna war heute bei ihrer Freundin Lisa und ging abends nach Hause.">${escapeHTML(story.text_de||'')}</textarea>
    </div>
    <div class="actions">
      <button class="primary" id="saveStoryBtn">${editing ? 'Speichern' : 'Anlegen'}</button>
      <button onclick="goto('stories')">Abbrechen</button>
    </div>
  `;
  const lvlSel = document.getElementById('stLevel'); if(lvlSel) lvlSel.value = story.level || 'A1';

  document.getElementById("saveStoryBtn").onclick = () => {
    const title = document.getElementById("stTitle").value.trim();
    const level = (document.getElementById('stLevel') && document.getElementById('stLevel').value) || 'A1';
    const vocab = textareaToVocab(document.getElementById("stVocab").value);
    const text_ja = document.getElementById("stTextJa").value.trim();
    const text_de = document.getElementById("stTextDe").value.trim();
    if(!title || !text_ja){
      alert("Titel und japanischer Text sind erforderlich.");
      return;
    }
    const updated = {id: story.id, title, level, vocab, text_ja, text_de};
    if(editing){
      const idx = stories.findIndex(s => s.id === story.id);
      if(idx >= 0) stories[idx] = updated; else stories.push(updated);
      saveStories(stories);
    } else {
      stories.push(updated);
      saveStories(stories);
    }
    goto('stories');
  };

  try{ ensureFocusScroll('input, textarea'); }catch(e){}
}

function renderEditStory(mount, id){
  return renderNewStory(mount, id);
}

function renderStoryRead(mount, id){
const st = getStoryById(id);
  if(!st){
    mount.innerHTML = `<p>Geschichte nicht gefunden.</p>`;
    return;
  }
  let step = 1; // 1=vocab, 2=story, 3=rate
  let showDe = false;

  function renderStep(){
    if(step === 1){
      mount.innerHTML = `
        <h2>${escapeHTML(st.title)} ${st.level?`<span class="badge">${st.level}</span>`:""}</h2>
        <div class="card">
          <h3>Wichtige Vokabeln</h3>
          ${(st.vocab && st.vocab.length) ? `
          <ul>
            ${st.vocab.map(v => `<li><strong>${escapeHTML(v.de||'')}</strong>: ${escapeHTML(v.kana||v.kanji||'')} <span class="hint">${escapeHTML(v.romaji||'')}</span> <button class="mini speak-vocab" data-jp="${(v.kana||v.kanji||'').replace(/`/g,'')}">🔊</button></li>`).join('')}
          </ul>` : `<p class="hint">Keine Vokabeln hinterlegt.</p>`}
          <div class="actions">
            <button class="primary" id="toStoryBtn">Weiter zur Geschichte</button>
            <button onclick="goto('stories')">Zurück</button>
          </div>
        </div>
      `;
      document.getElementById("toStoryBtn").onclick = () => { step = 2; renderStep(); };
      if('speechSynthesis' in window){
        document.querySelectorAll('.speak-vocab').forEach(b=>{
          b.onclick=()=>{ const t=b.dataset.jp||''; if(!t) return; const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.speak(u); };
        });
      }
    } else if(step === 2){
      mount.innerHTML = `
        <h2>${escapeHTML(st.title)} ${st.level?`<span class="badge">${st.level}</span>`:""}</h2>
        <div class="card">
          <div style="white-space:pre-wrap; font-size:1.1rem;">${escapeHTML(st.text_ja || '')}</div>
          <button id="speakStoryBtn" class="mini">🔊 Vorlesen</button>
          <div class="actions" style="margin-top:.5rem;">
            <button id="toggleDeBtn">${showDe ? 'Übersetzung ausblenden' : 'Übersetzung anzeigen'}</button>
            <button class="primary" id="finishReadBtn">Fertig gelesen</button>
          </div>
          ${showDe ? `<hr/><div class="hint" style="white-space:pre-wrap;">${escapeHTML(st.text_de||'')}</div>` : ``}
        </div>
      `;
      document.getElementById("toggleDeBtn").onclick = () => { showDe = !showDe; renderStep(); };
      document.getElementById("finishReadBtn").onclick = () => { step = 3; renderStep(); };
      if('speechSynthesis' in window){ const b=document.getElementById('speakStoryBtn'); if(b){ b.onclick=()=>{ const u=new SpeechSynthesisUtterance(st.text_ja||''); u.lang='ja-JP'; speechSynthesis.speak(u); } } }
    } else {
      mount.innerHTML = `
        <h2>${escapeHTML(st.title)}</h2>
        <div class="card">
          <p>Konntest du die Geschichte lesen und verstehen?</p>
          <div class="actions">
            <button class="primary" id="btnYes">Ja</button>
            <button class="danger" id="btnNo">Nein, war zu schwer</button>
          </div>
        </div>
      `;
      document.getElementById("btnYes").onclick = () => { try{ statStory(st.id,true); }catch(e){} 
        mount.innerHTML = `
          <h2>Super!</h2>
          <div class="card"><p>Du hast die Geschichte verstanden.</p></div>
          <div class="actions">
            <button class="primary" onclick="goto('stories')">Weitere Geschichten</button>
          </div>`;
      };
      document.getElementById("btnNo").onclick = () => { try{ statStory(st.id,false); }catch(e){} 
        const tempId = 'story-temp-' + st.id + '-' + Date.now();
        const now = Date.now();
        const cards = (st.vocab||[]).map((v,idx) => {
          const jp = v.kana || v.kanji || v.romaji || '';
          const label = v.kana ? 'Kana' : (v.kanji ? 'Kanji' : 'Romaji');
          return { id: tempId + '-' + idx, question: (v.de||'') + ' – (' + label + ')', answer: jp };
        });
        if (!cards.length) { alert('Keine Vokabeln vorhanden.'); goto('stories'); return; }
        try{
          const raw = localStorage.getItem(typeof STORAGE_KEY_V2 !== 'undefined' ? STORAGE_KEY_V2 : "quizcards_sets_v2");
          const sets = raw ? JSON.parse(raw) : [];
          sets.push({ id: tempId, name: 'Story Wiederholung – ' + (st.title||''), cards, createdAt: now, updatedAt: now });
          localStorage.setItem(typeof STORAGE_KEY_V2 !== 'undefined' ? STORAGE_KEY_V2 : "quizcards_sets_v2", JSON.stringify(sets));
        try { state.sets = sets; if (typeof save === 'function') save(); } catch(e) {}
        }catch(e){ console.error(e); }
        setTimeout(() => goto('learn/' + tempId), 0);
      };
    }
  }
  renderStep();
}


const STATS_KEY = "quizcards_stats_v1";
function loadStats(){ try{return JSON.parse(localStorage.getItem(STATS_KEY)||"{}");}catch(e){return {};} }
function saveStats(s){ localStorage.setItem(STATS_KEY, JSON.stringify(s||{})); }
function statStory(id, ok){
  const s = loadStats();
  s.stories = s.stories || {};
  const o = s.stories[id] = s.stories[id] || { reads: 0, ok: 0, last: 0 };
  o.reads++; if(ok) o.ok++;
  o.last = Date.now();
  saveStats(s);
}
function renderStats(mount){
  const s = loadStats();
  const stories = s.stories || {};
  const totalReads = Object.values(stories).reduce((a,b)=>a+(b.reads||0),0);
  const totalOk = Object.values(stories).reduce((a,b)=>a+(b.ok||0),0);
  mount.innerHTML = `<h2>Statistik</h2>
  <div class="card">
    <p><strong>Gelesene Geschichten:</strong> ${totalReads} (verstanden: ${totalOk})</p>
    <p class="hint">Weitere Set-Statistiken fügen wir gern später hinzu.</p>
  </div>`;
}

// Schnell-Wiederherstellung per Konsole
window.restoreBackup = () => {
  try {
    const b = localStorage.getItem("quizcards_backup_v1");
    if (!b) return alert("Kein Backup gefunden.");
    const arr = JSON.parse(b);
    if (!Array.isArray(arr)) throw new Error("Backup defekt.");
    localStorage.setItem(STORAGE_KEY_V2, JSON.stringify(arr));
    alert("Backup wiederhergestellt. Seite lädt neu.");
    location.reload();
  } catch (e) {
    alert("Backup konnte nicht wiederhergestellt werden: " + e.message);
  }
};

// --- Set löschen (mit Bestätigung) ---
function deleteSet(id){
  if(!confirm("Dieses Set wirklich löschen?")) return;
  try{
    const raw = localStorage.getItem(typeof STORAGE_KEY_V2 !== 'undefined' ? STORAGE_KEY_V2 : "quizcards_sets_v2");
    const loaded = raw ? JSON.parse(raw) : [];
    state.sets = Array.isArray(loaded) ? loaded : [];
    state.sets = (state.sets || []).filter(s => s.id !== id);
    if (typeof save === "function") save(); else localStorage.setItem(typeof STORAGE_KEY_V2 !== 'undefined' ? STORAGE_KEY_V2 : "quizcards_sets_v2", JSON.stringify(state.sets));
    goto("home");
  }catch(e){
    console.error(e);
    alert("Konnte das Set nicht löschen.");
  }
}


async function parseFileToCards(file){
  const name = file.name.toLowerCase();
  if (name.endsWith(".json")){
    const text = await file.text();
    const data = JSON.parse(text);
    const arr = Array.isArray(data) ? data : (Array.isArray(data.cards) ? data.cards : []);
    if (!Array.isArray(arr)) throw new Error("JSON enthält keine Kartenliste.");
    return normalizeToCards(arr);
  } else if (name.endsWith(".csv")){
    const text = await file.text();
    const rows = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if (!rows.length) return [];
    const headers = rows[0].split(",").map(s=>s.trim().toLowerCase());
    const out = [];
    for (let i=1;i<rows.length;i++){
      const cols = rows[i].split(",").map(s=>s.trim());
      const obj = Object.fromEntries(headers.map((h,idx)=>[h, cols[idx]||'']));
      out.push(obj);
    }
    return normalizeToCards(out);
  } else if (name.endsWith(".xlsx") || name.endsWith(".xls")){
    if (typeof XLSX === 'undefined') throw new Error("XLSX-Bibliothek nicht geladen.");
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, {type:'array'});
    const first = wb.SheetNames[0];
    const ws = wb.Sheets[first];
    const json = XLSX.utils.sheet_to_json(ws, {defval:''});
    return normalizeToCards(json);
  } else {
    throw new Error("Nicht unterstützter Dateityp.");
  }
}

function normalizeToCards(arr){
  const cards = [];
  arr.forEach((row, idx) => {
    const r = row || {};
    // case 1: question/answer
    if (r.question && r.answer){
      cards.push({ id: 'c'+Date.now()+'-'+idx, question: String(r.question), answer: String(r.answer) });
      return;
    }
    // case 2: de + (kana/kanji/romaji)
    const de = r.de || r.DE || r.Deutsch || r.deutsch;
    const kana = r.kana || r.Kana;
    const kanji = r.kanji || r.Kanji;
    const romaji = r.romaji || r.Romaji;
    if (de && (kana || kanji || romaji)){
      const jp = kana || kanji || romaji || '';
      const label = kana ? 'Kana' : (kanji ? 'Kanji' : 'Romaji');
      cards.push({ id: 'c'+Date.now()+'-'+idx, question: `${de} – (${label})`, answer: String(jp) });
      return;
    }
    // case 3: two-column fallback
    const values = Object.values(r);
    if (values.length >= 2){
      cards.push({ id: 'c'+Date.now()+'-'+idx, question: String(values[0]), answer: String(values[1]) });
    }
  });
  return cards;
}



// === Android Tablet UX helper: ensure focused input scrolls into view
function ensureFocusScroll(selector){
  try{
    const nodes = document.querySelectorAll(selector);
    nodes.forEach(el => {
      el.addEventListener('focus', () => {
        setTimeout(() => {
          try { el.scrollIntoView({ block: 'center', behavior: 'smooth' }); } catch(e){}
        }, 50);
      }, { passive: true });
    });
  }catch(e){}
}


function renderLevels(mount){
  ensureSeedLevels();
  const levels = loadLevels();
  const prog = loadProgress();

  // ✅ Sicherheitsnetz: falls aus irgendeinem Grund noch leer
  if (!levels.length) {
    mount.innerHTML = `<h2>Level-Modus</h2>
      <div class="card"><p>Keine Leveldaten gefunden. Seeds wurden initialisiert. Öffne den Level-Modus erneut.</p></div>`;
    return;
  }

  const curr = levels.find(l => l.level === prog.currentLevel) || levels[0];

  mount.innerHTML = `
    <h2>Level-Modus</h2>
    <div class="card level-card">
      <h3>Aktuelle Stufe: ${prog.currentLevel} – ${escapeHTML((curr && curr.title) || "")}</h3>
      <div>Aufgaben: ${prog.levelProgress} / ${curr.tasksRequired}</div>
      <div class="progress"><div style="width:${Math.min(100, Math.floor(100*prog.levelProgress/curr.tasksRequired))}%;"></div></div>
      <div class="actions" style="margin-top:.5rem;">
        <button class="primary" onclick="goto('level/read/${curr.id}')">Story & Vokabeln öffnen</button>
        <button onclick="goto('home')">Training starten (Sets/Quiz/Match…)</button>
      </div>
    </div>
    <h3>Alle Stufen</h3>
    <div class="grid">
      ${levels.slice(0,100).map(l => {
        const done = (prog.completedLevels||[]).includes(l.level);
        const isCurr = l.level === prog.currentLevel;
        return `
          <div class="card level-card">
            <h3>${l.level}. ${escapeHTML(l.title||"")}</h3>
            <div class="hint">Ziel: ${l.tasksRequired} Aufgaben</div>
            ${isCurr ? `<div class="badge">Aktiv</div>` : (done ? `<div class="badge">Abgeschlossen</div>`:"")}
            <div class="actions" style="margin-top:.5rem;">
              <button onclick="goto('level/read/${l.id}')">Ansehen</button>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

function renderLevelRead(mount, id){
  const levels = loadLevels();
  const lvl = levels.find(l => l.id === id);
  if (!lvl){ mount.innerHTML = `<p>Level nicht gefunden.</p>`; return; }
  const prog = loadProgress();
  const isCurr = prog.currentLevel === lvl.level;

  const jpOf = (v) => v.kana || v.kanji || v.romaji || '';

  mount.innerHTML = `
    <h2>${lvl.level}. ${escapeHTML(lvl.title||"")}</h2>

    <div class="card">
      <h3>Story (日本語)</h3>
${
  (String(lvl.story_ja||"")
    .split(/\r?\n/)
    .map(s => s.trim())
    .filter(Boolean)
    .map((line,i) => `
      <div class="card">
        <div style="white-space:pre-wrap; font-size:1.05rem;">${escapeHTML(line)}</div>
        <button class="mini speak-line" data-ja="${(line||'').replace(/"/g,'&quot;')}">🔊</button>
      </div>
    `).join("")
  ) || `<div class="card"><p class="hint">Keine Story vorhanden.</p></div>`
}
<div class="actions" style="margin-top:.5rem;">
  <button class="primary" onclick="goto('story/read/${'lvl-'+(lvl.id || lvl.level || lvl.title)}')">
    Lesen (mit Übersetzung)
  </button>
</div>

    <div class="card">
      <h3>Vokabeln</h3>
      ${
        Array.isArray(lvl.vocab) && lvl.vocab.length
        ? `<ul id="lvlVocab">
            ${lvl.vocab.map((v, i) => `
              <li>
                <strong>${escapeHTML(v.de||'')}</strong>
                ：${escapeHTML(jpOf(v))}
                <button class="mini speak-lv" data-jp="${(jpOf(v)||'').replace(/"/g,'&quot;')}">🔊</button>
              </li>`).join("")}
          </ul>`
        : `<p class="hint">Keine Vokabeln hinterlegt.</p>`
      }
    </div>

    <div class="actions">
      ${isCurr ? `<button class="primary" onclick="goto('levels')">Zur aktiven Stufe</button>` : ``}
      <button onclick="startTrainingForLevel('${lvl.id}','learn')">Lernen</button>
      <button onclick="startTrainingForLevel('${lvl.id}','quiz')">Quiz</button>
      <button onclick="startTrainingForLevel('${lvl.id}','match')">Match 60s</button>
      <button class="primary" onclick="startTrainingForLevel('${lvl.id}','spell')">Buchstabieren</button>
      <button onclick="goto('levels')">Zurück</button>
    </div>
  `;

  // Vorlesen
  document.querySelectorAll('.speak-lv').forEach(btn => {
    btn.addEventListener('click', () => { speak(btn.dataset.jp || ''); });
  });
}

// Level-Vokabeln zu temporärem Karten-Set machen
function buildCardsFromLevelVocab(vocab){
  const cards = [];
  (vocab || []).forEach((v, idx) => {
    const de = String(v.de || '').trim();
    const kana  = v.kana  ? String(v.kana)  : '';
    const kanji = v.kanji ? String(v.kanji) : '';
    const romaji= v.romaji? String(v.romaji): '';
    if (de && kana)  cards.push({ id: 'lv-'+Date.now()+'-'+idx+'-k', question: `${de} – (Kana)`,  answer: kana });
    if (de && kanji) cards.push({ id: 'lv-'+Date.now()+'-'+idx+'-j', question: `${de} – (Kanji)`, answer: kanji });
    if (de && romaji)cards.push({ id: 'lv-'+Date.now()+'-'+idx+'-r', question: `${de} – (Romaji)`,answer: romaji });
  });
  return cards;
}

function startTrainingForLevel(levelId, mode){
  const levels = loadLevels();
  const lvl = levels.find(l => l.id === levelId);
  if (!lvl) { alert('Level nicht gefunden.'); return; }
  const cards = buildCardsFromLevelVocab(lvl.vocab);
  if (!cards.length) { alert('Dieses Level hat keine trainierbaren Vokabeln.'); return; }

  const now = Date.now();
  const tempId = `level-${String(lvl.level).padStart(3,'0')}-vocab-${now}`;
  const setName = `Level ${lvl.level}: ${lvl.title || 'Vokabeln'}`;

  // in Sets abspeichern (nutzt deinen STORAGE_KEY_V2 = "quizcards_sets_v2")
  const raw = lsGet(STORAGE_KEY_V2);
  let sets = [];
  try { sets = raw ? JSON.parse(raw) : []; } catch { sets = []; }
  sets.push({ id: tempId, name: setName, cards, createdAt: now, updatedAt: now });
  lsSet(STORAGE_KEY_V2, JSON.stringify(sets));
  state.sets = sets;

  // zum gewünschten Modus routen (dein Router unterstützt learn/quiz/match/spell/<setId>)
  const route = (mode === 'quiz' ? 'quiz/' :
                 mode === 'match' ? 'match/' :
                 mode === 'spell' ? 'spell/' : 'learn/') + tempId;
  goto(route);
}

/* =========================================================
   CHATS – Gesprächstrainer (Kana/Kanji, 3 Optionen)
   Storage: quizcards_chats_v1  •  Routen: chats, chats/level/XX, chat/play/ID
   ========================================================= */

// ---------- Storage ----------
const CHATS_KEY = "quizcards_chats_v2";
function loadChats(){
  try { return JSON.parse(localStorage.getItem(CHATS_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveChats(arr){
  localStorage.setItem(CHATS_KEY, JSON.stringify(arr || []));
}

function chatsHaveGerman(arr){
  return (arr||[]).some(level =>
    (level.threads||[]).some(t =>
      (t.turns||[]).some(tr =>
        (tr.npc_de && String(tr.npc_de).trim()) ||
        (Array.isArray(tr.options_de) && tr.options_de.some(x => String(x||"").trim()))
      )
    )
  );
}

// sorgt dafür, dass DE-Felder vorhanden sind (sonst reseed)
function ensureChatsUpToDate(){
  let arr = loadChats();
  if (!arr.length || !chatsHaveGerman(arr)){
    try { localStorage.removeItem(CHATS_KEY); } catch {}
    // frische Seeds schreiben
    ensureSeedChats();
    arr = loadChats();
  }
  return arr;
}
// ---------- Types (Kommentar) ----------
// ChatTurn  : { npc: string, options: [string,string,string], correct: 0|1|2 }
// ChatThread: { id, level, persona, title, about, turns: ChatTurn[], __placeholder?: true }
// LevelChats: { level, threads: ChatThread[] }

// ---------- Utility ----------
function getChatsForLevel(lv){
  const all = ensureChatsUpToDate();
  return (all.find(x => x.level === Number(lv)) || { level: Number(lv), threads: [] }).threads;
}
function getThreadById(threadId){
  const all = ensureChatsUpToDate();
  for (const lv of all){ for (const t of (lv.threads||[])){ if (t.id === threadId) return t; } }
  return null;
}
function isJapaneseText(s){ return /[ぁ-んァ-ン一-龯]/.test(String(s||"")); }

// ---------- Seeder (Level 1 voll • 2–32 Platzhalter) ----------
function ensureSeedChats(){
  const existing = loadChats();
  const byLevel = new Map(existing.map(l => [l.level, l]));

  // Helper zum Mergen (füge fehlende Threads hinzu; überschreibe Platzhalter)
  const mergeLevel = (lvNum, threads) => {
    const curr = byLevel.get(lvNum) || { level: lvNum, threads: [] };
    const byId = new Map(curr.threads.map(t => [t.id, t]));
    for (const t of threads){
      const prev = byId.get(t.id);
      if (!prev) { byId.set(t.id, t); continue; }
      // vorhandene Platzhalter mit echten Daten ersetzen
      if (prev.__placeholder && !t.__placeholder) byId.set(t.id, t);
    }
    byLevel.set(lvNum, { level: lvNum, threads: [...byId.values()] });
  };

  // ---- Level 1: Begrüßung & Vorstellung (5 Personen × ~10 Turns) ----
  // Vokab passend zu Level 1 (Begrüßen, Name, Herkunft, Student/in, etc.)
  const L1 = [
   {
  id: "level-001-A",
  level: 1,
  persona: "A：はるか",
  title: "はじめまして",
  about: "初対面のあいさつ",
  turns: [
    {
      npc:"はじめまして。",
      npc_de:"Freut mich, Sie kennenzulernen.",
      options:["はじめまして。","こんにちは、りんごです。","さようなら。"],
      options_de:["Freut mich, Sie kennenzulernen.","Hallo, ich bin ein Apfel.","Auf Wiedersehen."],
      correct:0
    },
    {
      npc:"おなまえは？",
      npc_de:"Wie heißen Sie?",
      options:["ドイツです。","ハンナです。","学生です。"],
      options_de:["Ich komme aus Deutschland.","Ich heiße Hanna.","Ich bin Studentin."],
      correct:1
    },
    {
      npc:"どこから来ましたか。",
      npc_de:"Woher kommen Sie?",
      options:["ドイツから来ました。","学生です。","ありがとうございます。"],
      options_de:["Ich komme aus Deutschland.","Ich bin Studentin.","Vielen Dank."],
      correct:0
    },
    {
      npc:"よろしくおねがいします。",
      npc_de:"Angenehm, bitte behandeln Sie mich gut.",
      options:["よろしくおねがいします。","ごちそうさまでした。","こんばんは。"],
      options_de:["Angenehm, bitte behandeln Sie mich gut.","Danke für das Essen.","Guten Abend."],
      correct:0
    },
    {
      npc:"学生ですか。",
      npc_de:"Sind Sie Studentin?",
      options:["はい、学生です。","いいえ、さようなら。","おねがいします。"],
      options_de:["Ja, ich bin Studentin.","Nein, auf Wiedersehen.","Bitte."],
      correct:0
    },
    {
      npc:"ミュラーさんですか。",
      npc_de:"Sind Sie Frau Müller?",
      options:["はい、ハンナ・ミュラーです。","水をのみます。","犬です。"],
      options_de:["Ja, ich bin Hanna Müller.","Ich trinke Wasser.","Es ist ein Hund."],
      correct:0
    },
    {
      npc:"日本はどうですか。",
      npc_de:"Wie finden Sie Japan?",
      options:["たのしいです。","すしをつくります。","父は母です。"],
      options_de:["Es macht Spaß.","Ich mache Sushi.","Mein Vater ist meine Mutter."],
      correct:0
    },
    {
      npc:"日本語はむずかしいですか。",
      npc_de:"Ist Japanisch schwierig?",
      options:["ちょっとむずかしいです。","七時にねます。","雨です。"],
      options_de:["Ein bisschen schwierig.","Ich gehe um sieben schlafen.","Es regnet."],
      correct:0
    },
    {
      npc:"ドイツのどこですか。",
      npc_de:"Wo in Deutschland?",
      options:["ベルリンです。","学生です。","さかなが好きです。"],
      options_de:["In Berlin.","Ich bin Studentin.","Ich mag Fisch."],
      correct:0
    },
    {
      npc:"きょうはよろしく。",
      npc_de:"Ich freue mich heute auf die Zusammenarbeit.",
      options:["こちらこそ。","おはようございます。","またね。"],
      options_de:["Ganz meinerseits.","Guten Morgen.","Bis später."],
      correct:0
    }
  ]
},
{
  id: "level-001-B",
  level: 1,
  persona: "B：たろう",
  title: "なまえの確認",
  about: "名前・呼び方",
  turns: [
    {
      npc:"こんにちは。おなまえは？",
      npc_de:"Hallo. Wie heißen Sie?",
      options:["ハンナです。","水です。","さようなら。"],
      options_de:["Ich heiße Hanna.","Es ist Wasser.","Auf Wiedersehen."],
      correct:0
    },
    {
      npc:"ミュラーさんでいいですか。",
      npc_de:"Ist „Müller“ in Ordnung?",
      options:["はい、ミュラーでお願いします。","はい、魚です。","いいえ、雨です。"],
      options_de:["Ja, bitte nennen Sie mich Müller.","Ja, es ist ein Fisch.","Nein, es ist Regen."],
      correct:0
    },
    {
      npc:"ドイツ人ですか。",
      npc_de:"Sind Sie Deutsche?",
      options:["はい、ドイツ人です。","いいえ、学生です。","はい、さようなら。"],
      options_de:["Ja, ich bin Deutsche.","Nein, ich bin Studentin.","Ja, auf Wiedersehen."],
      correct:0
    },
    {
      npc:"学校はどこですか。",
      npc_de:"Wo ist Ihre Schule?",
      options:["大学です。","こんばんは。","花火です。"],
      options_de:["An der Universität.","Guten Abend.","Feuerwerk."],
      correct:0
    },
    {
      npc:"日本語がすきですか。",
      npc_de:"Mögen Sie Japanisch?",
      options:["はい、すきです。","水をのみます。","犬をたべます。"],
      options_de:["Ja, ich mag es.","Ich trinke Wasser.","Ich esse einen Hund."],
      correct:0
    },
    {
      npc:"趣味は？",
      npc_de:"Was ist Ihr Hobby?",
      options:["まんがを読みます。","切符です。","郵便局です。"],
      options_de:["Ich lese Manga.","Das ist eine Fahrkarte.","Das ist ein Postamt."],
      correct:0
    },
    {
      npc:"自己紹介をおねがいします。",
      npc_de:"Bitte stellen Sie sich vor.",
      options:["ハンナです。ドイツから来ました。学生です。","雨です。風です。","好きです。好きです。"],
      options_de:["Ich bin Hanna. Ich komme aus Deutschland. Ich bin Studentin.","Es ist Regen. Es ist Wind.","Ich mag es. Ich mag es."],
      correct:0
    },
    {
      npc:"わたしはたろうです。",
      npc_de:"Ich bin Tarō.",
      options:["よろしくおねがいします。","いくらですか。","銀行です。"],
      options_de:["Angenehm, bitte behandeln Sie mich gut.","Wie viel kostet es?","Bank."],
      correct:0
    },
    {
      npc:"今日はここまで。",
      npc_de:"Für heute war’s das.",
      options:["ありがとうございます。","おはようございます。","テストです。"],
      options_de:["Vielen Dank.","Guten Morgen.","Test."],
      correct:0
    },
    {
      npc:"またね。",
      npc_de:"Bis dann.",
      options:["またね。","さかな。","ねます。"],
      options_de:["Bis dann.","Fisch.","Ich schlafe."],
      correct:0
    }
  ]
},
{
  id: "level-001-C",
  level: 1,
  persona: "C：みさき",
  title: "出身を話す",
  about: "出身・国・都市",
  turns: [
    {
      npc:"はじめまして。どちらのご出身ですか。",
      npc_de:"Freut mich. Woher stammen Sie?",
      options:["ドイツです。","朝ごはんです。","サッカーです。"],
      options_de:["Aus Deutschland.","Frühstück.","Fußball."],
      correct:0
    },
    {
      npc:"ドイツのどの町ですか。",
      npc_de:"Welche Stadt in Deutschland?",
      options:["ミュンヘンです。","図書館です。","花火です。"],
      options_de:["München.","Bibliothek.","Feuerwerk."],
      correct:0
    },
    {
      npc:"日本は初めてですか。",
      npc_de:"Sind Sie zum ersten Mal in Japan?",
      options:["はい、初めてです。","はい、犬です。","いいえ、雨です。"],
      options_de:["Ja, zum ersten Mal.","Ja, es ist ein Hund.","Nein, es ist Regen."],
      correct:0
    },
    {
      npc:"日本のごはんはどうですか。",
      npc_de:"Wie finden Sie japanisches Essen?",
      options:["おいしいです。","やすみです。","カードです。"],
      options_de:["Lecker.","Pause.","Karte."],
      correct:0
    },
    {
      npc:"すしが好きですか。",
      npc_de:"Mögen Sie Sushi?",
      options:["はい、好きです。","はい、三つです。","はい、切符です。"],
      options_de:["Ja, ich mag es.","Ja, drei Stück.","Ja, eine Fahrkarte."],
      correct:0
    },
    {
      npc:"おなまえ、もう一度お願いします。",
      npc_de:"Ihren Namen bitte noch einmal.",
      options:["ハンナ・ミュラーです。","本を読みます。","夜にねます。"],
      options_de:["Ich bin Hanna Müller.","Ich lese ein Buch.","Ich schlafe abends."],
      correct:0
    },
    {
      npc:"学生なんですね。",
      npc_de:"Ah, Sie sind also Studentin.",
      options:["はい、学生です。","駅です。","道です。"],
      options_de:["Ja, ich bin Studentin.","Bahnhof.","Straße."],
      correct:0
    },
    {
      npc:"どの学年ですか。",
      npc_de:"Welches Studienjahr?",
      options:["一年生です。","レジです。","火です。"],
      options_de:["Erstes Jahr.","Kasse.","Feuer."],
      correct:0
    },
    {
      npc:"よろしく。",
      npc_de:"Freut mich / Angenehm.",
      options:["こちらこそよろしく。","ごちそうさま。","病院です。"],
      options_de:["Ganz meinerseits.","Danke für das Essen.","Krankenhaus."],
      correct:0
    },
    {
      npc:"じゃ、また。",
      npc_de:"Dann bis später.",
      options:["またね。","朝ごはん。","傘。"],
      options_de:["Bis später.","Frühstück.","Regenschirm."],
      correct:0
    }
  ]
},
{
  id: "level-001-D",
  level: 1,
  persona: "D：せんせい",
  title: "クラスの最初の会話",
  about: "授業の最初の自己紹介",
  turns: [
    {
      npc:"はじめまして。おなまえは。",
      npc_de:"Freut mich. Ihr Name?",
      options:["ハンナです。","こんにちはです。","雨です。"],
      options_de:["Ich bin Hanna.","Ich bin ‚Guten Tag‘.","Es ist Regen."],
      correct:0
    },
    {
      npc:"どこの国から来ましたか。",
      npc_de:"Aus welchem Land sind Sie gekommen?",
      options:["ドイツから来ました。","おちゃをのみます。","サッカーです。"],
      options_de:["Ich komme aus Deutschland.","Ich trinke Tee.","Es ist Fußball."],
      correct:0
    },
    {
      npc:"日本語はいつから勉強しましたか。",
      npc_de:"Seit wann lernen Sie Japanisch?",
      options:["去年からです。","さかなからです。","ゆうごはんです。"],
      options_de:["Seit letztem Jahr.","Seit Fisch.","Abendessen."],
      correct:0
    },
    {
      npc:"好きな食べ物は。",
      npc_de:"Was ist Ihr Lieblingsessen?",
      options:["すしが好きです。","きっぷが好きです。","郵便が好きです。"],
      options_de:["Ich mag Sushi.","Ich mag Fahrkarten.","Ich mag Post."],
      correct:0
    },
    {
      npc:"趣味は。",
      npc_de:"Was ist Ihr Hobby?",
      options:["音楽です。","銀行です。","角です。"],
      options_de:["Musik.","Bank.","Ecke."],
      correct:0
    },
    {
      npc:"大学では何を勉強しますか。",
      npc_de:"Was studieren Sie an der Universität?",
      options:["日本語を勉強します。","雨を勉強します。","花火を勉強します。"],
      options_de:["Ich studiere Japanisch.","Ich studiere Regen.","Ich studiere Feuerwerk."],
      correct:0
    },
    {
      npc:"質問はありますか。",
      npc_de:"Haben Sie Fragen?",
      options:["いいえ、ありません。","はい、犬です。","はい、駅です。"],
      options_de:["Nein, habe ich nicht.","Ja, es ist ein Hund.","Ja, es ist ein Bahnhof."],
      correct:0
    },
    {
      npc:"では、よろしく。",
      npc_de:"Dann, auf gute Zusammenarbeit.",
      options:["よろしくおねがいします。","おはようございます。","さようなら（いま）。"],
      options_de:["Angenehm, bitte behandeln Sie mich gut.","Guten Morgen.","Auf Wiedersehen (jetzt)."],
      correct:0
    },
    {
      npc:"座ってください。",
      npc_de:"Bitte setzen Sie sich.",
      options:["はい。","すし。","はな。"],
      options_de:["Ja.","Sushi.","Blume."],
      correct:0
    },
    {
      npc:"次の人。",
      npc_de:"Die nächste Person, bitte.",
      options:["はい。","魚。","風。"],
      options_de:["Ja.","Fisch.","Wind."],
      correct:0
    }
  ]
},
{
  id: "level-001-E",
  level: 1,
  persona: "E：りさ",
  title: "友だちになる",
  about: "カジュアルな出会い",
  turns: [
    {
      npc:"こんにちは！",
      npc_de:"Hallo!",
      options:["こんにちは！","ごちそうさま！","切符！"],
      options_de:["Hallo!","Vielen Dank für das Essen!","Fahrkarte!"],
      correct:0
    },
    {
      npc:"ハンナさん？",
      npc_de:"Hanna?",
      options:["はい、そうです。","はい、雨です。","はい、駅です。"],
      options_de:["Ja, genau.","Ja, Regen.","Ja, Bahnhof."],
      correct:0
    },
    {
      npc:"どこから？",
      npc_de:"Woher?",
      options:["ドイツです。","三つです。","朝ごはんです。"],
      options_de:["Aus Deutschland.","Drei Stück.","Frühstück."],
      correct:0
    },
    {
      npc:"日本はどう？",
      npc_de:"Wie ist Japan?",
      options:["たのしいです！","駅です。","角です。"],
      options_de:["Macht Spaß!","Bahnhof.","Ecke."],
      correct:0
    },
    {
      npc:"すし、好き？",
      npc_de:"Magst du Sushi?",
      options:["うん、好き。","うん、駅。","うん、雨。"],
      options_de:["Ja, mag ich.","Ja, Bahnhof.","Ja, Regen."],
      correct:0
    },
    {
      npc:"学生？",
      npc_de:"Studentin?",
      options:["うん、学生。","うん、切符。","うん、傘。"],
      options_de:["Ja, Studentin.","Ja, Fahrkarte.","Ja, Regenschirm."],
      correct:0
    },
    {
      npc:"なまえ、なんてよぶ？",
      npc_de:"Wie darf ich dich nennen?",
      options:["ハンナでいいよ。","雨でいいよ。","魚でいいよ。"],
      options_de:["‚Hanna‘ ist okay.","‚Regen‘ ist okay.","‚Fisch‘ ist okay."],
      correct:0
    },
    {
      npc:"連絡先は？",
      npc_de:"Kontakt?",
      options:["あとでお願いします。","銀行です。","病院です。"],
      options_de:["Bitte später.","Bank.","Krankenhaus."],
      correct:0
    },
    {
      npc:"じゃ、またね！",
      npc_de:"Dann, bis später!",
      options:["またね！","おはよう！","ごはん！"],
      options_de:["Bis später!","Guten Morgen!","Essen!"],
      correct:0
    },
    {
      npc:"今日はありがとう～",
      npc_de:"Danke für heute!",
      options:["こちらこそ！","郵便局！","風！"],
      options_de:["Ebenso!","Postamt!","Wind!"],
      correct:0
    }
  ]
}
  ];
  mergeLevel(1, L1);

 const L2 = [
    {
      id: "level-002-A",
      level: 2,
      persona: "A：りょうしん",
      title: "家族を紹介",
      about: "家族構成・兄弟姉妹・ペット",
      turns: [
        {
          npc: "あなたの家族は何人ですか。",
          npc_de: "Aus wie vielen Personen besteht deine Familie?",
          options: ["四人です。", "犬です。", "朝ごはんです。"],
          options_de: ["Aus vier Personen.", "Es ist ein Hund.", "Frühstück."],
          correct: 0
        },
        {
          npc: "兄弟はいますか。",
          npc_de: "Hast du Geschwister?",
          options: ["はい、弟がいます。", "はい、駅です。", "いいえ、雨です。"],
          options_de: ["Ja, ich habe einen jüngeren Bruder.", "Ja, es ist ein Bahnhof.", "Nein, es ist Regen."],
          correct: 0
        },
        {
          npc: "ペットはいますか。",
          npc_de: "Habt ihr ein Haustier?",
          options: ["はい、犬がいます。", "はい、魚をたべます。", "はい、図書館です。"],
          options_de: ["Ja, wir haben einen Hund.", "Ja, ich esse Fisch.", "Ja, Bibliothek."],
          correct: 0
        },
        {
          npc: "家はどこにありますか。",
          npc_de: "Wo liegt euer Haus?",
          options: ["駅の近くです。", "テストです。", "こんばんは。"],
          options_de: ["In der Nähe des Bahnhofs.", "Es ist ein Test.", "Guten Abend."],
          correct: 0
        },
        {
          npc: "部屋はいくつありますか。",
          npc_de: "Wie viele Zimmer gibt es?",
          options: ["二つあります。", "雨です。", "切符です。"],
          options_de: ["Es gibt zwei Zimmer.", "Es regnet.", "Fahrkarte."],
          correct: 0
        },
        {
          npc: "あなたの部屋は大きいですか。",
          npc_de: "Ist dein Zimmer groß?",
          options: ["小さいですが明るいです。", "魚です。", "銀行です。"],
          options_de: ["Es ist klein, aber hell.", "Es ist ein Fisch.", "Bank."],
          correct: 0
        },
        {
          npc: "リビングで何をしますか。",
          npc_de: "Was machst du im Wohnzimmer?",
          options: ["テレビを見ます。", "道をまがります。", "雨をのみます。"],
          options_de: ["Ich schaue Fernsehen.", "Ich biege ab.", "Ich trinke Regen."],
          correct: 0
        },
        {
          npc: "夜は何時に寝ますか。",
          npc_de: "Wann gehst du abends schlafen?",
          options: ["十一時に寝ます。", "切符に寝ます。", "図書館に寝ます。"],
          options_de: ["Ich schlafe um 23 Uhr.", "Ich schlafe auf einer Fahrkarte.", "Ich schlafe in der Bibliothek."],
          correct: 0
        },
        {
          npc: "休みの日は家で何をしますか。",
          npc_de: "Was machst du zu Hause am freien Tag?",
          options: ["本を読みます。", "駅を読みます。", "風を読みます。"],
          options_de: ["Ich lese Bücher.", "Ich lese den Bahnhof.", "Ich lese den Wind."],
          correct: 0
        },
        {
          npc: "今日はゆっくり休んでね。",
          npc_de: "Ruh dich heute gut aus.",
          options: ["ありがとうございます。", "おはようございます。", "さようなら（今）。"],
          options_de: ["Vielen Dank.", "Guten Morgen.", "Auf Wiedersehen (jetzt)."],
          correct: 0
        }
      ]
    },
    {
      id: "level-002-B",
      level: 2,
      persona: "B：ルームメイト",
      title: "家事の分担",
      about: "掃除・洗濯・ゴミ出し",
      turns: [
        {
          npc: "今週の掃除はだれがしますか。",
          npc_de: "Wer putzt diese Woche?",
          options: ["わたしがします。", "魚がします。", "雨がします。"],
          options_de: ["Ich mache es.", "Der Fisch macht es.", "Der Regen macht es."],
          correct: 0
        },
        {
          npc: "ごみは何曜日に出しますか。",
          npc_de: "An welchem Wochentag bringen wir den Müll raus?",
          options: ["火曜日です。", "四時です。", "テストです。"],
          options_de: ["Am Dienstag.", "Es ist 4 Uhr.", "Test."],
          correct: 0
        },
        {
          npc: "洗濯は朝と夜どちらがいい？",
          npc_de: "Was ist besser: morgens oder abends waschen?",
          options: ["朝がいいです。", "雨がいいです。", "駅がいいです。"],
          options_de: ["Morgens ist gut.", "Regen ist gut.", "Bahnhof ist gut."],
          correct: 0
        },
        {
          npc: "台所はせまいですね。",
          npc_de: "Die Küche ist eng, oder?",
          options: ["はい、でも使いやすいです。", "はい、でも魚です。", "はい、でも銀行です。"],
          options_de: ["Ja, aber sie ist praktisch.", "Ja, aber es ist ein Fisch.", "Ja, aber es ist eine Bank."],
          correct: 0
        },
        {
          npc: "冷蔵庫に牛乳はありますか。",
          npc_de: "Haben wir Milch im Kühlschrank?",
          options: ["はい、少しあります。", "はい、図書館があります。", "はい、角があります。"],
          options_de: ["Ja, ein bisschen.", "Ja, wir haben eine Bibliothek.", "Ja, wir haben eine Ecke."],
          correct: 0
        },
        {
          npc: "土曜日に引っ越しパーティーをします。",
          npc_de: "Am Samstag machen wir eine Einzugsparty.",
          options: ["いいですね、楽しみです。", "いいですね、雨です。", "いいですね、切符です。"],
          options_de: ["Klingt gut, ich freue mich.", "Klingt gut, Regen.", "Klingt gut, Fahrkarte."],
          correct: 0
        },
        {
          npc: "友だちも呼んでいい？",
          npc_de: "Darf ich Freunde einladen?",
          options: ["もちろん、三人まで。", "もちろん、三つです。", "もちろん、駅です。"],
          options_de: ["Klar, bis zu drei Personen.", "Klar, drei Stück.", "Klar, Bahnhof."],
          correct: 0
        },
        {
          npc: "日曜は静かにしましょう。",
          npc_de: "Am Sonntag lass uns leise sein.",
          options: ["はい、気をつけます。", "はい、風です。", "はい、魚です。"],
          options_de: ["Ja, ich passe auf.", "Ja, es ist Wind.", "Ja, es ist ein Fisch."],
          correct: 0
        },
        {
          npc: "助けてくれてありがとう。",
          npc_de: "Danke für deine Hilfe.",
          options: ["いえいえ、どういたしまして。", "さようなら。", "おはようございます。"],
          options_de: ["Gern geschehen.", "Auf Wiedersehen.", "Guten Morgen."],
          correct: 0
        },
        {
          npc: "じゃ、またね。",
          npc_de: "Dann bis später.",
          options: ["またね。", "魚。", "風。"],
          options_de: ["Bis später.", "Fisch.", "Wind."],
          correct: 0
        }
      ]
    },
    {
      id: "level-002-C",
      level: 2,
      persona: "C：となりの人",
      title: "近所づきあい",
      about: "あいさつ・迷惑をかけない",
      turns: [
        {
          npc: "はじめまして。となりに住んでいます。",
          npc_de: "Freut mich. Ich wohne nebenan.",
          options: ["よろしくおねがいします。", "テストです。", "切符です。"],
          options_de: ["Angenehm, bitte behandeln Sie mich gut.", "Es ist ein Test.", "Fahrkarte."],
          correct: 0
        },
        {
          npc: "夜は静かにお願いします。",
          npc_de: "Bitte nachts leise sein.",
          options: ["はい、気をつけます。", "はい、雨です。", "はい、駅です。"],
          options_de: ["Ja, ich passe auf.", "Ja, es ist Regen.", "Ja, es ist Bahnhof."],
          correct: 0
        },
        {
          npc: "ゴミ置き場はあちらです。",
          npc_de: "Der Müllplatz ist dort drüben.",
          options: ["ありがとうございます。", "おはようございます。", "こんばんは。"],
          options_de: ["Vielen Dank.", "Guten Morgen.", "Guten Abend."],
          correct: 0
        },
        {
          npc: "困ったことがあれば言ってください。",
          npc_de: "Sag Bescheid, wenn etwas ist.",
          options: ["はい、ありがとうございます。", "はい、魚です。", "はい、銀行です。"],
          options_de: ["Ja, danke schön.", "Ja, es ist ein Fisch.", "Ja, es ist eine Bank."],
          correct: 0
        },
        {
          npc: "雨の日はすべりやすいですよ。",
          npc_de: "An Regentagen ist es rutschig.",
          options: ["気をつけます。", "切符を買います。", "駅を見ます。"],
          options_de: ["Ich passe auf.", "Ich kaufe eine Fahrkarte.", "Ich sehe den Bahnhof."],
          correct: 0
        },
        {
          npc: "この辺は安全ですか。",
          npc_de: "Ist es hier in der Gegend sicher?",
          options: ["はい、わりと安全です。", "はい、魚です。", "はい、角です。"],
          options_de: ["Ja, ziemlich sicher.", "Ja, es ist ein Fisch.", "Ja, es ist eine Ecke."],
          correct: 0
        },
        {
          npc: "公園は近いですか。",
          npc_de: "Ist der Park in der Nähe?",
          options: ["はい、三分です。", "はい、三つです。", "はい、三人です。"],
          options_de: ["Ja, drei Minuten.", "Ja, drei Stück.", "Ja, drei Personen."],
          correct: 0
        },
        {
          npc: "今度いっしょに散歩しませんか。",
          npc_de: "Wollen wir mal zusammen spazieren gehen?",
          options: ["ぜひ、お願いします。", "ぜひ、魚です。", "ぜひ、銀行です。"],
          options_de: ["Gern, sehr gern.", "Gern, es ist ein Fisch.", "Gern, es ist eine Bank."],
          correct: 0
        },
        {
          npc: "連絡先を教えてください。",
          npc_de: "Bitte gib mir deine Kontaktdaten.",
          options: ["あとで送ります。", "今、雨です。", "今、駅です。"],
          options_de: ["Ich schicke sie später.", "Jetzt ist Regen.", "Jetzt ist Bahnhof."],
          correct: 0
        },
        {
          npc: "よろしくお願いします！",
          npc_de: "Auf gute Nachbarschaft!",
          options: ["こちらこそ！", "さかな！", "ねます！"],
          options_de: ["Ebenso!", "Fisch!", "Ich schlafe!"],
          correct: 0
        }
      ]
    },
    {
      id: "level-002-D",
      level: 2,
      persona: "D：大家さん",
      title: "アパートのルール",
      about: "契約・禁止事項",
      turns: [
        {
          npc: "契約書は読みましたか。",
          npc_de: "Haben Sie den Mietvertrag gelesen?",
          options: ["はい、読みました。", "はい、食べました。", "はい、走りました。"],
          options_de: ["Ja, ich habe ihn gelesen.", "Ja, ich habe ihn gegessen.", "Ja, ich bin gelaufen."],
          correct: 0
        },
        {
          npc: "ペットは禁止です。",
          npc_de: "Haustiere sind verboten.",
          options: ["わかりました。", "いただきます。", "ごちそうさま。"],
          options_de: ["Verstanden.", "Guten Appetit.", "Danke für das Essen."],
          correct: 0
        },
        {
          npc: "ゴミ出しは朝七時までです。",
          npc_de: "Müll raus bis 7 Uhr morgens.",
          options: ["はい、守ります。", "はい、買います。", "はい、泳ぎます。"],
          options_de: ["Ja, ich halte mich daran.", "Ja, ich kaufe.", "Ja, ich schwimme."],
          correct: 0
        },
        {
          npc: "困ったら事務所に電話してください。",
          npc_de: "Wenn es Probleme gibt, rufen Sie das Büro an.",
          options: ["はい、電話します。", "はい、電話です。", "はい、電話を食べます。"],
          options_de: ["Ja, ich rufe an.", "Ja, es ist ein Telefon.", "Ja, ich esse ein Telefon."],
          correct: 0
        },
        {
          npc: "家賃は毎月末までです。",
          npc_de: "Die Miete ist bis Monatsende fällig.",
          options: ["カードで払います。", "駅で払います。", "雨で払います。"],
          options_de: ["Ich zahle mit Karte.", "Ich zahle am Bahnhof.", "Ich zahle mit Regen."],
          correct: 0
        },
        {
          npc: "水道の調子はどうですか。",
          npc_de: "Wie läuft die Wasserversorgung?",
          options: ["少しこわれています。", "少しおいしいです。", "少し青いです。"],
          options_de: ["Etwas kaputt.", "Etwas lecker.", "Etwas blau."],
          correct: 0
        },
        {
          npc: "では、修理の人を呼びます。",
          npc_de: "Dann rufe ich einen Techniker.",
          options: ["助かります。", "走ります。", "泳ぎます。"],
          options_de: ["Das hilft sehr, danke.", "Ich renne.", "Ich schwimme."],
          correct: 0
        },
        {
          npc: "来週の火曜は点検があります。",
          npc_de: "Nächsten Dienstag gibt es eine Inspektion.",
          options: ["了解しました。", "おいしいです。", "つめたいです。"],
          options_de: ["Verstanden.", "Es ist lecker.", "Es ist kalt."],
          correct: 0
        },
        {
          npc: "質問はありますか。",
          npc_de: "Haben Sie Fragen?",
          options: ["いいえ、ありません。", "はい、犬です。", "はい、駅です。"],
          options_de: ["Nein, keine.", "Ja, es ist ein Hund.", "Ja, es ist ein Bahnhof."],
          correct: 0
        },
        {
          npc: "よろしくお願いします。",
          npc_de: "Auf gute Zusammenarbeit.",
          options: ["こちらこそ。", "さかな。", "ねこ。"],
          options_de: ["Ganz meinerseits.", "Fisch.", "Katze."],
          correct: 0
        }
      ]
    },
    {
      id: "level-002-E",
      level: 2,
      persona: "E：いとこ",
      title: "家に遊びに行く",
      about: "訪問・おみやげ・連絡",
      turns: [
        {
          npc: "今度、家に遊びに来てください。",
          npc_de: "Komm doch mal zu mir nach Hause.",
          options: ["ぜひ、行きます。", "ぜひ、食べます。", "ぜひ、泳ぎます。"],
          options_de: ["Gern, ich komme.", "Gern, ich esse.", "Gern, ich schwimme."],
          correct: 0
        },
        {
          npc: "土曜日はだいじょうぶ？",
          npc_de: "Geht Samstag?",
          options: ["はい、だいじょうぶです。", "はい、図書館です。", "はい、角です。"],
          options_de: ["Ja, das passt.", "Ja, Bibliothek.", "Ja, Ecke."],
          correct: 0
        },
        {
          npc: "何時ごろ来ますか。",
          npc_de: "Gegen wie viel Uhr kommst du?",
          options: ["三時ごろです。", "三つです。", "三人です。"],
          options_de: ["Gegen 15 Uhr.", "Drei Stück.", "Drei Personen."],
          correct: 0
        },
        {
          npc: "おみやげはいりませんよ。",
          npc_de: "Du brauchst kein Mitbringsel.",
          options: ["じゃ、クッキーを少し。", "じゃ、駅を少し。", "じゃ、雨を少し。"],
          options_de: ["Dann bringe ich ein paar Kekse.", "Dann bringe ich etwas Bahnhof.", "Dann bringe ich etwas Regen."],
          correct: 0
        },
        {
          npc: "住所を送りますね。",
          npc_de: "Ich schicke dir die Adresse.",
          options: ["お願いします。", "泳ぎます。", "走ります。"],
          options_de: ["Bitte, danke.", "Ich schwimme.", "Ich renne."],
          correct: 0
        },
        {
          npc: "インターホンを押してください。",
          npc_de: "Bitte klingeln.",
          options: ["わかりました。", "いただきます。", "ごちそうさま。"],
          options_de: ["Verstanden.", "Guten Appetit.", "Danke für das Essen."],
          correct: 0
        },
        {
          npc: "道はわかりますか。",
          npc_de: "Findest du den Weg?",
          options: ["地図があります。", "魚があります。", "雨があります。"],
          options_de: ["Ich habe eine Karte.", "Ich habe einen Fisch.", "Ich habe Regen."],
          correct: 0
        },
        {
          npc: "気をつけて来てね。",
          npc_de: "Komm gut an!",
          options: ["はい、行きます。", "はい、食べます。", "はい、読みます。"],
          options_de: ["Ja, ich komme.", "Ja, ich esse.", "Ja, ich lese."],
          correct: 0
        },
        {
          npc: "到着したらメッセージください。",
          npc_de: "Schreib mir, wenn du angekommen bist.",
          options: ["はい、連絡します。", "はい、連絡です。", "はい、連絡を食べます。"],
          options_de: ["Ja, ich melde mich.", "Ja, es ist Kontakt.", "Ja, ich esse Kontakt."],
          correct: 0
        },
        {
          npc: "またね！",
          npc_de: "Bis bald!",
          options: ["またね！", "さかな！", "ねます！"],
          options_de: ["Bis bald!", "Fisch!", "Ich schlafe!"],
          correct: 0
        }
      ]
    }
  ];
  mergeLevel(2, L2);

  // ---- Level 3: Alltag & Zeit（毎日の生活・時間）----
  const L3 = [
    {
      id: "level-003-A",
      level: 3,
      persona: "A：クラスメイト",
      title: "一日のスケジュール",
      about: "起きる・食べる・行く・寝る",
      turns: [
        {
          npc: "朝は何時に起きますか。",
          npc_de: "Wann stehst du morgens auf?",
          options: ["六時に起きます。", "六時に食べます。", "六時に泳ぎます。"],
          options_de: ["Ich stehe um 6 Uhr auf.", "Ich esse um 6 Uhr.", "Ich schwimme um 6 Uhr."],
          correct: 0
        },
        {
          npc: "朝ごはんは食べますか。",
          npc_de: "Isst du Frühstück?",
          options: ["はい、七時に食べます。", "はい、七時に走ります。", "はい、七時に雨です。"],
          options_de: ["Ja, um 7 Uhr.", "Ja, ich renne um 7 Uhr.", "Ja, um 7 Uhr Regen."],
          correct: 0
        },
        {
          npc: "何時に学校へ行きますか。",
          npc_de: "Wann gehst du zur Schule?",
          options: ["八時に行きます。", "八時に帰ります。", "八時に寝ます。"],
          options_de: ["Ich gehe um 8 Uhr.", "Ich gehe um 8 Uhr nach Hause.", "Ich schlafe um 8 Uhr."],
          correct: 0
        },
        {
          npc: "昼休みは何をしますか。",
          npc_de: "Was machst du in der Mittagspause?",
          options: ["友だちと話します。", "夜に話します。", "風と話します。"],
          options_de: ["Ich rede mit Freunden.", "Ich rede nachts.", "Ich rede mit dem Wind."],
          correct: 0
        },
        {
          npc: "放課後は？",
          npc_de: "Und nach der Schule?",
          options: ["図書館で勉強します。", "図書館を食べます。", "図書館に寝ます。"],
          options_de: ["Ich lerne in der Bibliothek.", "Ich esse die Bibliothek.", "Ich schlafe in der Bibliothek."],
          correct: 0
        },
        {
          npc: "夕ご飯は何時ですか。",
          npc_de: "Wann ist Abendessen?",
          options: ["七時半です。", "午後七人です。", "七角です。"],
          options_de: ["Um 19:30.", "Sieben Personen am Nachmittag.", "Sieben Ecken."],
          correct: 0
        },
        {
          npc: "夜は何をしますか。",
          npc_de: "Was machst du abends?",
          options: ["音楽を聞きます。", "駅を聞きます。", "雨を聞きます。"],
          options_de: ["Ich höre Musik.", "Ich höre den Bahnhof.", "Ich höre den Regen."],
          correct: 0
        },
        {
          npc: "何時に寝ますか。",
          npc_de: "Wann gehst du schlafen?",
          options: ["十一時に寝ます。", "十一時に起きます。", "十一時に買います。"],
          options_de: ["Ich gehe um 23 Uhr schlafen.", "Ich stehe um 23 Uhr auf.", "Ich kaufe um 23 Uhr."],
          correct: 0
        },
        {
          npc: "週末はどうしますか。",
          npc_de: "Was machst du am Wochenende?",
          options: ["映画を見に行きます。", "映画を飲みに行きます。", "映画を風に行きます。"],
          options_de: ["Ich gehe ins Kino.", "Ich gehe Film trinken.", "Ich gehe Film zum Wind."],
          correct: 0
        },
        {
          npc: "明日もがんばりましょう。",
          npc_de: "Lass uns auch morgen unser Bestes geben.",
          options: ["はい、がんばります。", "はい、食べます。", "はい、泳ぎます。"],
          options_de: ["Ja, ich gebe mein Bestes.", "Ja, ich esse.", "Ja, ich schwimme."],
          correct: 0
        }
      ]
    },
    {
      id: "level-003-B",
      level: 3,
      persona: "B：せんせい",
      title: "時間の確認",
      about: "時刻・開始と終了",
      turns: [
        {
          npc: "授業は九時からですよ。",
          npc_de: "Der Unterricht beginnt um 9 Uhr.",
          options: ["はい、間に合います。", "はい、間に合いませんです。", "はい、魚です。"],
          options_de: ["Ja, ich komme rechtzeitig.", "Ja, ich komme nicht rechtzeitig ist.", "Ja, es ist ein Fisch."],
          correct: 0
        },
        {
          npc: "何分前に来られますか。",
          npc_de: "Wie viele Minuten vorher kannst du kommen?",
          options: ["十分前に来ます。", "十個前に来ます。", "十人前に来ます。"],
          options_de: ["Ich komme 10 Minuten vorher.", "Ich komme 10 Stück vorher.", "Ich komme vor 10 Personen."],
          correct: 0
        },
        {
          npc: "昼休みは十二時からです。",
          npc_de: "Die Mittagspause ist ab 12 Uhr.",
          options: ["わかりました。", "いただきます。", "ごちそうさま。"],
          options_de: ["Verstanden.", "Guten Appetit.", "Danke für das Essen."],
          correct: 0
        },
        {
          npc: "午後の授業は三時までです。",
          npc_de: "Der Nachmittagsunterricht geht bis 15 Uhr.",
          options: ["はい、三時までいます。", "はい、三時まで食べます。", "はい、三時まで雨です。"],
          options_de: ["Ja, ich bleibe bis 15 Uhr.", "Ja, ich esse bis 15 Uhr.", "Ja, bis 15 Uhr Regen."],
          correct: 0
        },
        {
          npc: "今日は宿題があります。",
          npc_de: "Heute gibt es Hausaufgaben.",
          options: ["図書館でやります。", "図書館で寝ます。", "図書館で泳ぎます。"],
          options_de: ["Ich mache sie in der Bibliothek.", "Ich schlafe in der Bibliothek.", "Ich schwimme in der Bibliothek."],
          correct: 0
        },
        {
          npc: "質問があればチャットに書いてください。",
          npc_de: "Schreib Fragen in den Chat.",
          options: ["はい、書きます。", "はい、買います。", "はい、飼います。"],
          options_de: ["Ja, ich schreibe.", "Ja, ich kaufe.", "Ja, ich halte (ein Tier)."],
          correct: 0
        },
        {
          npc: "次のテストは何時からですか。",
          npc_de: "Um wie viel Uhr beginnt der nächste Test?",
          options: ["九時半からです。", "九人半からです。", "九角からです。"],
          options_de: ["Ab 9:30.", "Ab neuneinhalb Personen.", "Ab neun Ecken."],
          correct: 0
        },
        {
          npc: "それでは今日はここまで。",
          npc_de: "Dann sind wir für heute fertig.",
          options: ["ありがとうございます。", "おはようございます。", "さようなら（いま）。"],
          options_de: ["Vielen Dank.", "Guten Morgen.", "Auf Wiedersehen (jetzt)."],
          correct: 0
        },
        {
          npc: "家で復習してください。",
          npc_de: "Bitte wiederhole zu Hause.",
          options: ["はい、復習します。", "はい、復習を食べます。", "はい、復習は雨です。"],
          options_de: ["Ja, ich wiederhole.", "Ja, ich esse Wiederholung.", "Ja, Wiederholung ist Regen."],
          correct: 0
        },
        {
          npc: "また明日会いましょう。",
          npc_de: "Wir sehen uns morgen.",
          options: ["はい、また明日。", "はい、また魚。", "はい、また駅。"],
          options_de: ["Ja, bis morgen.", "Ja, bis Fisch.", "Ja, bis Bahnhof."],
          correct: 0
        }
      ]
    },
    {
      id: "level-003-C",
      level: 3,
      persona: "C：アルバイト先の先輩",
      title: "シフトの相談",
      about: "開始・終了・休憩",
      turns: [
        {
          npc: "明日のシフトは八時から入れますか。",
          npc_de: "Kannst du morgen ab 8 Uhr arbeiten?",
          options: ["はい、入れます。", "はい、食べます。", "はい、泳げます。"],
          options_de: ["Ja, ich kann.", "Ja, ich esse.", "Ja, ich kann schwimmen."],
          correct: 0
        },
        {
          npc: "休憩は何時にしますか。",
          npc_de: "Wann machst du Pause?",
          options: ["十二時にします。", "十二人にします。", "十二角にします。"],
          options_de: ["Um 12 Uhr.", "Ich mache es zu 12 Personen.", "Ich mache es zu 12 Ecken."],
          correct: 0
        },
        {
          npc: "終わりは何時ですか。",
          npc_de: "Wann ist Feierabend?",
          options: ["四時半です。", "四人半です。", "四角です。"],
          options_de: ["Um 16:30.", "Viereinhalb Personen.", "Viereck."],
          correct: 0
        },
        {
          npc: "通勤はどうやって来ますか。",
          npc_de: "Wie kommst du zur Arbeit?",
          options: ["自転車で来ます。", "魚で来ます。", "雨で来ます。"],
          options_de: ["Ich komme mit dem Fahrrad.", "Ich komme mit Fisch.", "Ich komme mit Regen."],
          correct: 0
        },
        {
          npc: "お客さんが多い時は走ります。",
          npc_de: "Wenn viele Kunden da sind, muss man rennen.",
          options: ["はい、がんばります。", "はい、食べます。", "はい、寝ます。"],
          options_de: ["Ja, ich gebe mein Bestes.", "Ja, ich esse.", "Ja, ich schlafe."],
          correct: 0
        },
        {
          npc: "ユニフォームはありますか。",
          npc_de: "Hast du eine Uniform?",
          options: ["はい、持っています。", "はい、読んでいます。", "はい、泳いでいます。"],
          options_de: ["Ja, ich habe sie.", "Ja, ich lese sie.", "Ja, ich schwimme sie."],
          correct: 0
        },
        {
          npc: "遅刻しないでくださいね。",
          npc_de: "Bitte komm nicht zu spät.",
          options: ["はい、気をつけます。", "はい、気を食べます。", "はい、気を泳ぎます。"],
          options_de: ["Ja, ich passe auf.", "Ja, ich esse die Stimmung.", "Ja, ich schwimme die Stimmung."],
          correct: 0
        },
        {
          npc: "タイムカードを忘れないでください。",
          npc_de: "Vergiss die Stempelkarte nicht.",
          options: ["わかりました。", "いただきました。", "ごちそうさまでした。"],
          options_de: ["Verstanden.", "Ich habe es erhalten (Essensformel).", "Danke für das Essen."],
          correct: 0
        },
        {
          npc: "終わったら連絡してください。",
          npc_de: "Melde dich, wenn du fertig bist.",
          options: ["はい、連絡します。", "はい、連絡を食べます。", "はい、連絡は雨です。"],
          options_de: ["Ja, ich melde mich.", "Ja, ich esse Kontakt.", "Ja, Kontakt ist Regen."],
          correct: 0
        },
        {
          npc: "よろしくお願いします。",
          npc_de: "Danke im Voraus.",
          options: ["こちらこそお願いします。", "さかな。", "かぜ。"],
          options_de: ["Ganz meinerseits.", "Fisch.", "Wind."],
          correct: 0
        }
      ]
    },
    {
      id: "level-003-D",
      level: 3,
      persona: "D：ともだち",
      title: "週末の予定",
      about: "時間合わせ・待ち合わせ",
      turns: [
        {
          npc: "土曜日、ひまですか。",
          npc_de: "Hast du am Samstag Zeit?",
          options: ["はい、ひまです。", "はい、雨です。", "はい、駅です。"],
          options_de: ["Ja, ich habe Zeit.", "Ja, es ist Regen.", "Ja, es ist Bahnhof."],
          correct: 0
        },
        {
          npc: "何時に会いましょうか。",
          npc_de: "Um wie viel Uhr treffen wir uns?",
          options: ["十時はどうですか。", "十人はどうですか。", "十角はどうですか。"],
          options_de: ["Wie wäre 10 Uhr?", "Wie wären 10 Personen?", "Wie wären 10 Ecken?"],
          correct: 0
        },
        {
          npc: "どこで会いますか。",
          npc_de: "Wo treffen wir uns?",
          options: ["駅の前で。", "雨の前で。", "魚の前で。"],
          options_de: ["Vor dem Bahnhof.", "Vor dem Regen.", "Vor dem Fisch."],
          correct: 0
        },
        {
          npc: "映画の前にランチしませんか。",
          npc_de: "Wollen wir vor dem Film Mittag essen?",
          options: ["いいですね。", "青いですね。", "風ですね。"],
          options_de: ["Gute Idee.", "Es ist blau.", "Es ist Wind."],
          correct: 0
        },
        {
          npc: "カフェは十分歩きます。",
          npc_de: "Zum Café laufen wir 10 Minuten.",
          options: ["わかりました。", "いただきました。", "ごちそうさまでした。"],
          options_de: ["Verstanden.", "Ich habe es erhalten.", "Danke für das Essen."],
          correct: 0
        },
        {
          npc: "映画は何時からですか。",
          npc_de: "Wann beginnt der Film?",
          options: ["一時半からです。", "一人半からです。", "一角からです。"],
          options_de: ["Ab 13:30.", "Ab eineinhalb Personen.", "Ab eine Ecke."],
          correct: 0
        },
        {
          npc: "じゃ、十時に駅前で。",
          npc_de: "Dann um 10 Uhr vor dem Bahnhof.",
          options: ["はい、遅れないようにします。", "はい、遅れないように食べます。", "はい、遅れないように泳ぎます。"],
          options_de: ["Ja, ich komme nicht zu spät.", "Ja, ich esse nicht zu spät.", "Ja, ich schwimme nicht zu spät."],
          correct: 0
        },
        {
          npc: "雨が降ったらどうしますか。",
          npc_de: "Was machen wir, wenn es regnet?",
          options: ["カフェで待ちます。", "駅で食べます。", "風で待ちます。"],
          options_de: ["Wir warten im Café.", "Wir essen am Bahnhof.", "Wir warten im Wind."],
          correct: 0
        },
        {
          npc: "連絡先は知っていますか。",
          npc_de: "Hast du meine Kontaktdaten?",
          options: ["はい、LINEがあります。", "はい、角があります。", "はい、魚があります。"],
          options_de: ["Ja, ich habe LINE.", "Ja, ich habe eine Ecke.", "Ja, ich habe einen Fisch."],
          correct: 0
        },
        {
          npc: "じゃ、また連絡します。",
          npc_de: "Dann melde ich mich nochmal.",
          options: ["お願いします。", "おはようございます。", "さようなら（いま）。"],
          options_de: ["Bitte.", "Guten Morgen.", "Auf Wiedersehen (jetzt)."],
          correct: 0
        }
      ]
    },
    {
      id: "level-003-E",
      level: 3,
      persona: "E：先輩（サークル）",
      title: "集合時間の周知",
      about: "集合・解散・遅刻注意",
      turns: [
        {
          npc: "明日の集合は九時です。",
          npc_de: "Morgen treffen wir uns um 9 Uhr.",
          options: ["はい、九時に行きます。", "はい、九時に寝ます。", "はい、九時に買います。"],
          options_de: ["Ja, ich komme um 9 Uhr.", "Ja, ich schlafe um 9 Uhr.", "Ja, ich kaufe um 9 Uhr."],
          correct: 0
        },
        {
          npc: "遅刻しないでください。",
          npc_de: "Bitte nicht zu spät kommen.",
          options: ["はい、気をつけます。", "はい、気を食べます。", "はい、気を泳ぎます。"],
          options_de: ["Ja, ich passe auf.", "Ja, ich esse die Stimmung.", "Ja, ich schwimme die Stimmung."],
          correct: 0
        },
        {
          npc: "終わりは十二時ごろです。",
          npc_de: "Gegen 12 Uhr sind wir fertig.",
          options: ["了解しました。", "ごちそうさまでした。", "いただきます。"],
          options_de: ["Verstanden.", "Danke für das Essen.", "Guten Appetit."],
          correct: 0
        },
        {
          npc: "場所は駅の西口です。",
          npc_de: "Ort ist der Westausgang des Bahnhofs.",
          options: ["迷ったら連絡します。", "迷ったら泳ぎます。", "迷ったら食べます。"],
          options_de: ["Wenn ich mich verlaufe, melde ich mich.", "Wenn ich mich verlaufe, schwimme ich.", "Wenn ich mich verlaufe, esse ich."],
          correct: 0
        },
        {
          npc: "昼ごはんは各自でお願いします。",
          npc_de: "Mittagessen organisiert jeder selbst.",
          options: ["わかりました。", "おいしいです。", "つめたいです。"],
          options_de: ["Verstanden.", "Es ist lecker.", "Es ist kalt."],
          correct: 0
        },
        {
          npc: "雨の場合は中止です。",
          npc_de: "Bei Regen fällt es aus.",
          options: ["その時は連絡します。", "その時は走ります。", "その時は泳ぎます。"],
          options_de: ["Dann informiere ich dich.", "Dann renne ich.", "Dann schwimme ich."],
          correct: 0
        },
        {
          npc: "質問はありますか。",
          npc_de: "Gibt es Fragen?",
          options: ["いいえ、ありません。", "はい、犬です。", "はい、駅です。"],
          options_de: ["Nein.", "Ja, es ist ein Hund.", "Ja, es ist ein Bahnhof."],
          correct: 0
        },
        {
          npc: "では、よろしく。",
          npc_de: "Dann bis morgen.",
          options: ["よろしくおねがいします。", "おはようございます。", "さようなら（いま）。"],
          options_de: ["Angenehm/Bitte um gute Zusammenarbeit.", "Guten Morgen.", "Auf Wiedersehen (jetzt)."],
          correct: 0
        },
        {
          npc: "集合時間に遅れないでね。",
          npc_de: "Komm bitte pünktlich zur Treffzeit.",
          options: ["はい、気をつけます。", "はい、気を食べます。", "はい、気を泳ぎます。"],
          options_de: ["Ja, ich passe auf.", "Ja, ich esse die Stimmung.", "Ja, ich schwimme die Stimmung."],
          correct: 0
        },
        {
          npc: "また連絡します。",
          npc_de: "Ich melde mich nochmal.",
          options: ["お願いします。", "さかな。", "かぜ。"],
          options_de: ["Bitte.", "Fisch.", "Wind."],
          correct: 0
        }
      ]
    }
  ];
  mergeLevel(3, L3);

// ---- Level 4: Essen & Trinken（たべもの・のみもの）----
const L4 = [
  {
    id: "level-004-A",
    level: 4,
    persona: "A：クラスメイト",
    title: "好きな食べ物",
    about: "好み・アレルギー・おすすめ",
    turns: [
      { npc: "好きな食べ物は何ですか。", npc_de: "Was isst du am liebsten?", options: ["カレーが好きです。", "駅が好きです。", "角が好きです。"], options_de: ["Ich mag Curry.", "Ich mag den Bahnhof.", "Ich mag die Ecke."], correct: 0 },
      { npc: "辛いのは大丈夫？", npc_de: "Verträgst du Scharfes?", options: ["はい、すこし大丈夫です。", "はい、すこし駅です。", "はい、すこし角です。"], options_de: ["Ja, ein bisschen.", "Ja, ein bisschen Bahnhof.", "Ja, ein bisschen Ecke."], correct: 0 },
      { npc: "アレルギーはありますか。", npc_de: "Hast du Allergien?", options: ["ナッツはだめです。", "夏はだめです。", "なつは駅です。"], options_de: ["Nüsse gehen nicht.", "Der Sommer geht nicht.", "Sommer ist Bahnhof."], correct: 0 },
      { npc: "よく行くレストランは？", npc_de: "Welches Restaurant besuchst du oft?", options: ["安くておいしい店です。", "安くて青い店です。", "安くて風の店です."], options_de: ["Ein günstiges und leckeres Lokal.", "Ein günstiges und blaues Lokal.", "Ein günstiges Wind-Lokal."], correct: 0 },
      { npc: "飲み物は何にしますか。", npc_de: "Was möchtest du trinken?", options: ["お茶をください。", "駅をください。", "風をください。"], options_de: ["Bitte Tee.", "Bitte Bahnhof.", "Bitte Wind."], correct: 0 },
      { npc: "ベジタリアンですか。", npc_de: "Bist du Vegetarier:in?", options: ["いいえ、何でも食べます。", "いいえ、何でも駅です。", "いいえ、何でも雨です。"], options_de: ["Nein, ich esse alles.", "Nein, alles ist Bahnhof.", "Nein, alles ist Regen."], correct: 0 },
      { npc: "デザートはどうしますか。", npc_de: "Wie sieht’s mit Dessert aus?", options: ["アイスを少し。", "アイスを駅。", "アイスを青。"], options_de: ["Ein bisschen Eis.", "Eis Bahnhof.", "Eis Blau."], correct: 0 },
      { npc: "おすすめ料理は？", npc_de: "Empfehlung des Hauses?", options: ["店のラーメンが一番です。", "店の駅が一番です。", "店の角が一番です。"], options_de: ["Die Ramen sind top.", "Der Bahnhof ist top.", "Die Ecke ist top."], correct: 0 },
      { npc: "おなかいっぱい？", npc_de: "Satt?", options: ["はい、もう十分です。", "はい、もう十角です。", "はい、もう十人です。"], options_de: ["Ja, mehr als genug.", "Ja, schon zehn Ecken.", "Ja, schon zehn Personen."], correct: 0 },
      { npc: "じゃ、また食べに行こう。", npc_de: "Dann lass uns wieder essen gehen.", options: ["ぜひ、行きましょう。", "ぜひ、泳ぎましょう。", "ぜひ、寝ましょう。"], options_de: ["Gern, gehen wir.", "Gern, schwimmen wir.", "Gern, schlafen wir."], correct: 0 }
    ]
  },
  {
    id: "level-004-B",
    level: 4,
    persona: "B：店員（カフェ）",
    title: "注文する",
    about: "メニュー・サイズ・支払い",
    turns: [
      { npc: "いらっしゃいませ。ご注文は？", npc_de: "Willkommen, was darf’s sein?", options: ["ラテのMサイズをください。", "ラテのM角をください。", "ラテのM駅をください。"], options_de: ["Bitte einen Latte in M.", "Bitte einen M-Eck Latte.", "Bitte einen M-Bahnhof Latte."], correct: 0 },
      { npc: "お砂糖は入れますか。", npc_de: "Zucker dazu?", options: ["いいえ、なしで。", "いいえ、駅で。", "いいえ、角で。"], options_de: ["Nein, ohne.", "Nein, am Bahnhof.", "Nein, an der Ecke."], correct: 0 },
      { npc: "ホイップはどうしますか。", npc_de: "Schlagsahne dazu?", options: ["はい、少しお願いします。", "はい、少し走ります。", "はい、少し泳ぎます。"], options_de: ["Ja, ein wenig bitte.", "Ja, ich renne etwas.", "Ja, ich schwimme etwas."], correct: 0 },
      { npc: "店内で召し上がりますか。", npc_de: "Zum Hiertrinken?", options: ["はい、ここで。", "はい、そこで雨。", "はい、そこで駅。"], options_de: ["Ja, hier.", "Ja, dort Regen.", "Ja, dort Bahnhof."], correct: 0 },
      { npc: "お会計は500円です。", npc_de: "Das macht 500 Yen.", options: ["カードで払います。", "角で払います。", "駅で払います。"], options_de: ["Ich zahle mit Karte.", "Ich zahle mit Ecke.", "Ich zahle am Bahnhof."], correct: 0 },
      { npc: "レシートは要りますか。", npc_de: "Brauchen Sie den Beleg?", options: ["はい、ください。", "はい、ください駅。", "はい、ください角。"], options_de: ["Ja, bitte.", "Ja, bitte Bahnhof.", "Ja, bitte Ecke."], correct: 0 },
      { npc: "お名前をお願いします。", npc_de: "Ihren Namen bitte.", options: ["山田です。", "やまだ角です。", "やまだ駅です。"], options_de: ["Ich heiße Yamada.", "Ich heiße Yamada-Ecke.", "Ich heiße Yamada-Bahnhof."], correct: 0 },
      { npc: "できあがったらお呼びします。", npc_de: "Ich rufe, wenn es fertig ist.", options: ["お願いします。", "泳ぎます。", "走ります。"], options_de: ["Bitte.", "Ich schwimme.", "Ich renne."], correct: 0 },
      { npc: "お待たせしました。", npc_de: "Danke für’s Warten.", options: ["ありがとうございます。", "おはようございます。", "さようなら（今）。"], options_de: ["Vielen Dank.", "Guten Morgen.", "Auf Wiedersehen (jetzt)."], correct: 0 },
      { npc: "またお越しください。", npc_de: "Besuchen Sie uns wieder.", options: ["はい、また来ます。", "はい、また寝ます。", "はい、また雨です。"], options_de: ["Ja, ich komme wieder.", "Ja, ich schlafe wieder.", "Ja, wieder Regen."], correct: 0 }
    ]
  },
  {
    id: "level-004-C",
    level: 4,
    persona: "C：ルームメイト",
    title: "自炊する",
    about: "材料・味・手伝い",
    turns: [
      { npc: "今夜カレーを作るよ。", npc_de: "Ich koche heute Curry.", options: ["手伝います。", "手で駅です。", "手で角です。"], options_de: ["Ich helfe mit.", "Mit der Hand Bahnhof.", "Mit der Hand Ecke."], correct: 0 },
      { npc: "玉ねぎはありますか。", npc_de: "Haben wir Zwiebeln?", options: ["はい、二個あります。", "はい、二人あります。", "はい、二角あります。"], options_de: ["Ja, zwei Stück.", "Ja, zwei Personen.", "Ja, zwei Ecken."], correct: 0 },
      { npc: "味は甘口にする？", npc_de: "Mild würzen?", options: ["はい、甘口で。", "はい、雨口で。", "はい、駅口で。"], options_de: ["Ja, mild.", "Ja, Regen-Geschmack.", "Ja, Bahnhof-Geschmack."], correct: 0 },
      { npc: "にんじんを切ってください。", npc_de: "Bitte schneide die Karotten.", options: ["はい、細かく切ります。", "はい、細かく泳ぎます。", "はい、細かく走ります。"], options_de: ["Ja, ich schneide fein.", "Ja, ich schwimme fein.", "Ja, ich renne fein."], correct: 0 },
      { npc: "ご飯は何合たきますか。", npc_de: "Wie viel Reis kochen wir?", options: ["二合たきます。", "二角たきます。", "二駅たきます。"], options_de: ["Zwei Go.", "Zwei Ecken.", "Zwei Bahnhöfe."], correct: 0 },
      { npc: "味見してくれる？", npc_de: "Probierst du mal?", options: ["うん、ちょうどいい。", "うん、ちょうど青い。", "うん、ちょうど駅。"], options_de: ["Ja, genau richtig.", "Ja, genau blau.", "Ja, genau Bahnhof."], correct: 0 },
      { npc: "サラダも作ろう。", npc_de: "Lass uns Salat machen.", options: ["トマトを入れます。", "トマトを走ります。", "トマトを泳ぎます。"], options_de: ["Ich gebe Tomaten dazu.", "Ich renne Tomaten.", "Ich schwimme Tomaten."], correct: 0 },
      { npc: "ドレッシングは？", npc_de: "Welches Dressing?", options: ["オリーブオイルと塩です。", "オリーブオイルと駅です。", "オリーブオイルと角です。"], options_de: ["Olivenöl und Salz.", "Olivenöl und Bahnhof.", "Olivenöl und Ecke."], correct: 0 },
      { npc: "片づけはあとでいい？", npc_de: "Aufräumen später ok?", options: ["はい、食べてから。", "はい、雨てから。", "はい、駅てから。"], options_de: ["Ja, nach dem Essen.", "Ja, nach dem Regen.", "Ja, nach dem Bahnhof."], correct: 0 },
      { npc: "いただきます！", npc_de: "Guten Appetit!", options: ["どうぞ！", "どうぞ駅！", "どうぞ角！"], options_de: ["Bitte schön!", "Bitte Bahnhof!", "Bitte Ecke!"], correct: 0 }
    ]
  },
  {
    id: "level-004-D",
    level: 4,
    persona: "D：友だち",
    title: "外食の計画",
    about: "店選び・予約・予算",
    turns: [
      { npc: "今夜、外で食べない？", npc_de: "Lust, heute auswärts zu essen?", options: ["いいね、行こう。", "青いね、行こう。", "駅ね、行こう。"], options_de: ["Klingt gut, los!", "Blau, los!", "Bahnhof, los!"], correct: 0 },
      { npc: "和食とイタリアンどっち？", npc_de: "Japanisch oder Italienisch?", options: ["和食がいいです。", "和食が角です。", "和食が駅です。"], options_de: ["Japanisch ist mir lieber.", "Japanisch ist Ecke.", "Japanisch ist Bahnhof."], correct: 0 },
      { npc: "予約したほうがいい？", npc_de: "Sollen wir reservieren?", options: ["はい、七時でお願いします。", "はい、七角でお願いします。", "はい、七駅でお願いします。"], options_de: ["Ja, für 19 Uhr bitte.", "Ja, für sieben Ecken.", "Ja, für sieben Bahnhöfe."], correct: 0 },
      { npc: "予算は一人いくら？", npc_de: "Wie viel Budget pro Person?", options: ["二千円ぐらい。", "二千角ぐらい。", "二千駅ぐらい。"], options_de: ["Etwa 2000 Yen.", "Etwa 2000 Ecken.", "Etwa 2000 Bahnhöfe."], correct: 0 },
      { npc: "苦手なものある？", npc_de: "Gibt’s etwas, das du nicht magst?", options: ["パクチーは苦手です。", "パクチーは駅です。", "パクチーは角です。"], options_de: ["Koriander mag ich nicht.", "Koriander ist Bahnhof.", "Koriander ist Ecke."], correct: 0 },
      { npc: "じゃ、この店にしよう。", npc_de: "Dann nehmen wir dieses Lokal.", options: ["賛成です。", "山盛りです。", "駅盛りです。"], options_de: ["Einverstanden.", "Bergvoll.", "Bahnhofvoll."], correct: 0 },
      { npc: "集合は店の前ね。", npc_de: "Treffpunkt vor dem Restaurant.", options: ["了解、五分前に行く。", "了解、五角前に行く。", "了解、五駅前に行く。"], options_de: ["Verstanden, ich bin 5 Min vorher da.", "Verstanden, fünf Ecken vorher.", "Verstanden, fünf Bahnhöfe vorher."], correct: 0 },
      { npc: "飲み放題つける？", npc_de: "Mit Getränkeflat?", options: ["いいえ、今回はなしで。", "いいえ、今回は駅で。", "いいえ、今回は角で。"], options_de: ["Nein, diesmal nicht.", "Nein, diesmal Bahnhof.", "Nein, diesmal Ecke."], correct: 0 },
      { npc: "食べ過ぎないようにね。", npc_de: "Nicht zu viel essen, ja?", options: ["はい、気をつけます。", "はい、気を食べます。", "はい、気を泳ぎます。"], options_de: ["Ja, ich passe auf.", "Ja, ich esse die Stimmung.", "Ja, ich schwimme die Stimmung."], correct: 0 },
      { npc: "また連絡するね。", npc_de: "Ich melde mich nochmal.", options: ["お願いします。", "泳ぎます。", "走ります。"], options_de: ["Bitte.", "Ich schwimme.", "Ich renne."], correct: 0 }
    ]
  },
  {
    id: "level-004-E",
    level: 4,
    persona: "E：店員（居酒屋）",
    title: "注文と確認",
    about: "取り皿・追加・会計",
    turns: [
      { npc: "とりあえず飲み物は？", npc_de: "Erstmal Getränke?", options: ["ウーロン茶でお願いします。", "ウーロン駅でお願いします。", "ウーロン角でお願いします."], options_de: ["Oolong-Tee bitte.", "Oolong-Bahnhof bitte.", "Oolong-Ecke bitte."], correct: 0 },
      { npc: "取り皿は何枚ですか。", npc_de: "Wie viele Tellerchen?", options: ["四枚ください。", "四人ください。", "四駅ください。"], options_de: ["Vier bitte.", "Vier Personen bitte.", "Vier Bahnhöfe bitte."], correct: 0 },
      { npc: "焼き鳥は塩とタレどちらにしますか。", npc_de: "Yakitori: Salz oder Sauce?", options: ["塩でお願いします。", "駅でお願いします。", "角でお願いします。"], options_de: ["Mit Salz, bitte.", "Mit Bahnhof, bitte.", "Mit Ecke, bitte."], correct: 0 },
      { npc: "追加のご注文は？", npc_de: "Noch etwas dazu?", options: ["枝豆をお願いします。", "枝豆を走ります。", "枝豆を泳ぎます。"], options_de: ["Edamame bitte.", "Ich renne Edamame.", "Ich schwimme Edamame."], correct: 0 },
      { npc: "ラストオーダーです。", npc_de: "Letzte Bestellung.", options: ["味噌汁をもう一つ。", "味噌汁をもう一駅。", "味噌汁をもう一角。"], options_de: ["Noch eine Miso-Suppe.", "Noch ein Bahnhof Miso.", "Noch eine Ecke Miso."], correct: 0 },
      { npc: "喫煙席でよろしいですか。", npc_de: "Raucherbereich okay?", options: ["いいえ、禁煙席で。", "いいえ、駅席で。", "いいえ、角席で。"], options_de: ["Nein, Nichtraucher bitte.", "Nein, Bahnhof-Sitz.", "Nein, Eck-Sitz."], correct: 0 },
      { npc: "お水はセルフです。", npc_de: "Wasser ist Self-Service.", options: ["わかりました。", "泳ぎました。", "走りました。"], options_de: ["Verstanden.", "Ich bin geschwommen.", "Ich bin gelaufen."], correct: 0 },
      { npc: "お会計はご一緒で？", npc_de: "Zahlen Sie zusammen?", options: ["はい、まとめてお願いします。", "はい、まとめて駅です。", "はい、まとめて角です。"], options_de: ["Ja, zusammen bitte.", "Ja, zusammen Bahnhof.", "Ja, zusammen Ecke."], correct: 0 },
      { npc: "領収書は必要ですか。", npc_de: "Brauchen Sie eine Quittung?", options: ["はい、会社名で。", "はい、会社雨で。", "はい、会社駅で。"], options_de: ["Ja, auf Firmenname.", "Ja, auf Firmen-Regen.", "Ja, auf Firmen-Bahnhof."], correct: 0 },
      { npc: "ありがとうございました。", npc_de: "Vielen Dank.", options: ["ごちそうさまでした。", "おはようございました。", "さようならでした。"], options_de: ["Danke für das Essen.", "Guten Morgen gewesen.", "Auf Wiedersehen gewesen."], correct: 0 }
    ]
  }
];
mergeLevel(4, L4);

// ---- Level 5: Feste & Veranstaltungen（お祭り・イベント）----
const L5 = [
  {
    id: "level-005-A",
    level: 5,
    persona: "A：友だち",
    title: "花火大会に行く",
    about: "日程・場所・持ち物",
    turns: [
      { npc: "今週末、花火大会に行かない？", npc_de: "Kommst du am Wochenende zum Feuerwerk?", options: ["行きたい！", "泳ぎたい！", "寝たい！"], options_de: ["Ich möchte hin!", "Ich möchte schwimmen!", "Ich möchte schlafen!"], correct: 0 },
      { npc: "日時は土曜の七時から。", npc_de: "Es ist Samstag ab 19 Uhr.", options: ["了解、六時半に集合しよう。", "了解、六角半に集合しよう。", "了解、六駅半に集合しよう。"], options_de: ["Verstanden, treffen wir uns 18:30.", "Treffen um sechs-einhalb Ecken.", "Treffen um sechs-einhalb Bahnhöfe."], correct: 0 },
      { npc: "場所は川の土手だよ。", npc_de: "Am Flussdamm.", options: ["駅から歩けます。", "雨から歩けます。", "角から歩けます。"], options_de: ["Vom Bahnhof kann man laufen.", "Vom Regen kann man laufen.", "Von der Ecke kann man laufen."], correct: 0 },
      { npc: "レジャーシート持ってる？", npc_de: "Hast du eine Picknickdecke?", options: ["はい、持っています。", "はい、読んでいます。", "はい、泳いでいます。"], options_de: ["Ja, habe ich.", "Ja, ich lese sie.", "Ja, ich schwimme sie."], correct: 0 },
      { npc: "浴衣で行こうかな。", npc_de: "Ich überlege, im Yukata zu gehen.", options: ["いいね、写真撮ろう。", "青いね、写真撮ろう。", "駅ね、写真撮ろう。"], options_de: ["Cool, lass Fotos machen.", "Blau, lass Fotos machen.", "Bahnhof, lass Fotos machen."], correct: 0 },
      { npc: "屋台で何食べたい？", npc_de: "Was möchtest du am Stand essen?", options: ["たこ焼きを食べたい。", "たこ駅を食べたい。", "たこ角を食べたい。"], options_de: ["Takoyaki.", "Tako-Bahnhof.", "Tako-Ecke."], correct: 0 },
      { npc: "雨が降ったら中止だよ。", npc_de: "Bei Regen fällt es aus.", options: ["その時は連絡して。", "その時は泳いで。", "その時は走って。"], options_de: ["Sag mir dann Bescheid.", "Dann schwimm.", "Dann renn."], correct: 0 },
      { npc: "混むから早めに行こう。", npc_de: "Wird voll, gehen wir früher.", options: ["うん、早く行こう。", "うん、速く泳ごう。", "うん、速く駅。"], options_de: ["Ja, lass früh los.", "Ja, schnell schwimmen.", "Ja, schnell Bahnhof."], correct: 0 },
      { npc: "帰りは電車で大丈夫？", npc_de: "Rückfahrt mit der Bahn ok?", options: ["はい、最終を確認します。", "はい、最終を走ります。", "はい、最終を泳ぎます。"], options_de: ["Ja, ich checke den letzten Zug.", "Ja, ich renne den letzten Zug.", "Ja, ich schwimme den letzten Zug."], correct: 0 },
      { npc: "じゃ、土曜よろしく！", npc_de: "Dann bis Samstag!", options: ["よろしく！", "おはよう！", "さようなら（今）！"], options_de: ["Bis dann!", "Guten Morgen!", "Auf Wiedersehen (jetzt)!"], correct: 0 }
    ]
  },
  {
    id: "level-005-B",
    level: 5,
    persona: "B：サークル先輩",
    title: "学園祭の準備",
    about: "役割分担・時間割",
    turns: [
      { npc: "学園祭で焼きそば屋を出します。", npc_de: "Auf dem Campusfest machen wir einen Yakisoba-Stand.", options: ["手伝います！", "泳ぎます！", "寝ます！"], options_de: ["Ich helfe!", "Ich schwimme!", "Ich schlafe!"], correct: 0 },
      { npc: "あなたは買い出し担当ね。", npc_de: "Du übernimmst den Einkauf.", options: ["わかりました。", "いただきました。", "ごちそうさまでした。"], options_de: ["Verstanden.", "Ich habe es erhalten (Essensformel).", "Danke für das Essen."], correct: 0 },
      { npc: "朝八時に集合。", npc_de: "Treffen um 8 Uhr morgens.", options: ["十分前に行きます。", "十人前に行きます。", "十角前に行きます。"], options_de: ["Ich komme 10 Min vorher.", "Ich komme vor 10 Personen.", "Ich komme 10 Ecken vorher."], correct: 0 },
      { npc: "ガスコンロに気をつけて。", npc_de: "Achte auf den Gaskocher.", options: ["はい、安全第一です。", "はい、青前第一です。", "はい、駅第一です。"], options_de: ["Ja, Sicherheit zuerst.", "Ja, Blau zuerst.", "Ja, Bahnhof zuerst."], correct: 0 },
      { npc: "呼び込みもお願いします。", npc_de: "Bitte auch Leute anlocken.", options: ["元気に声を出します。", "元気に風を出します。", "元気に駅を出します。"], options_de: ["Ich rufe laut.", "Ich gebe Wind von mir.", "Ich gebe Bahnhof von mir."], correct: 0 },
      { npc: "お釣りは小銭を多めに。", npc_de: "Für Wechselgeld viele Münzen mitnehmen.", options: ["準備します。", "準備を食べます。", "準備を泳ぎます。"], options_de: ["Ich bereite es vor.", "Ich esse die Vorbereitung.", "Ich schwimme die Vorbereitung."], correct: 0 },
      { npc: "昼は交代で休憩しましょう。", npc_de: "Mittagspause im Wechsel.", options: ["はい、三十分ずつ。", "はい、三十角ずつ。", "はい、三十駅ずつ。"], options_de: ["Ja, je 30 Minuten.", "Je 30 Ecken.", "Je 30 Bahnhöfe."], correct: 0 },
      { npc: "雨天でもやります。", npc_de: "Findet auch bei Regen statt.", options: ["カッパを用意します。", "カッパを走ります。", "カッパを泳ぎます。"], options_de: ["Ich bringe Regenjacken.", "Ich renne Regenmantel.", "Ich schwimme Regenmantel."], correct: 0 },
      { npc: "終了後は片づけ。", npc_de: "Nach Schluss räumen wir auf.", options: ["最後まで手伝います。", "最後まで泳ぎます。", "最後まで寝ます。"], options_de: ["Ich helfe bis zum Ende.", "Ich schwimme bis zum Ende.", "Ich schlafe bis zum Ende."], correct: 0 },
      { npc: "みんな、ありがとう！", npc_de: "Danke an alle!", options: ["こちらこそ！", "おはよう！", "さようなら！"], options_de: ["Ebenso!", "Guten Morgen!", "Tschüss!"], correct: 0 }
    ]
  },
  {
    id: "level-005-C",
    level: 5,
    persona: "C：イベントスタッフ",
    title: "ライブ会場で",
    about: "入場・席・注意事項",
    turns: [
      { npc: "チケットを拝見します。", npc_de: "Bitte Ticket zeigen.", options: ["はい、どうぞ。", "はい、どうぞ駅。", "はい、どうぞ角。"], options_de: ["Hier, bitte.", "Bitte Bahnhof.", "Bitte Ecke."], correct: 0 },
      { npc: "入場は左のゲートです。", npc_de: "Einlass links am Gate.", options: ["わかりました。", "いただきました。", "ごちそうさまでした。"], options_de: ["Verstanden.", "Ich habe es erhalten.", "Danke für das Essen."], correct: 0 },
      { npc: "荷物検査にご協力ください。", npc_de: "Bitte Gepäckkontrolle.", options: ["はい、協力します。", "はい、強力します。", "はい、恐竜します。"], options_de: ["Ja, ich mache mit.", "Ja, ich mache es stark.", "Ja, ich dinosauere."], correct: 0 },
      { npc: "あなたの席はA-12です。", npc_de: "Ihr Platz ist A-12.", options: ["ありがとうございます。", "おはようございます。", "こんばんは。"], options_de: ["Danke schön.", "Guten Morgen.", "Guten Abend."], correct: 0 },
      { npc: "撮影は一部禁止です。", npc_de: "Teils Fotoverbot.", options: ["了解しました。", "了解しました駅。", "了解しました角。"], options_de: ["Verstanden.", "Verstanden Bahnhof.", "Verstanden Ecke."], correct: 0 },
      { npc: "再入場はできません。", npc_de: "Kein Wiedereinlass.", options: ["注意します。", "遅刻します。", "寝坊します。"], options_de: ["Ich beachte es.", "Ich komme zu spät.", "Ich verschlafe."], correct: 0 },
      { npc: "飲食はロビーでお願いします。", npc_de: "Essen/Trinken bitte im Foyer.", options: ["はい、ロビーで。", "はい、ロビー駅。", "はい、ロビー角。"], options_de: ["Ja, im Foyer.", "Ja, Foyer-Bahnhof.", "Ja, Foyer-Ecke."], correct: 0 },
      { npc: "開演は七時ぴったりです。", npc_de: "Beginn exakt 19:00.", options: ["遅れないようにします。", "遅れないように泳ぎます。", "遅れないように走ります。"], options_de: ["Ich komme pünktlich.", "Ich schwimme pünktlich.", "Ich renne pünktlich."], correct: 0 },
      { npc: "終演後、出口は右側です。", npc_de: "Nach Ende Ausgang rechts.", options: ["ありがとうございます。", "ごちそうさまです。", "いただきます。"], options_de: ["Vielen Dank.", "Danke für das Essen.", "Guten Appetit."], correct: 0 },
      { npc: "楽しんでください。", npc_de: "Viel Spaß!", options: ["はい、楽しみます！", "はい、寝ます！", "はい、泳ぎます！"], options_de: ["Ja, ich freue mich!", "Ja, ich schlafe!", "Ja, ich schwimme!"], correct: 0 }
    ]
  },
  {
    id: "level-005-D",
    level: 5,
    persona: "D：近所の人",
    title: "夏祭りの手伝い",
    about: "集合・屋台・片づけ",
    turns: [
      { npc: "町内の夏祭りを手伝いませんか。", npc_de: "Hilfst du beim Sommerfest im Viertel?", options: ["はい、ぜひ。", "はい、雨。", "はい、駅。"], options_de: ["Ja, gern.", "Ja, Regen.", "Ja, Bahnhof."], correct: 0 },
      { npc: "集合は神社の前です。", npc_de: "Treffpunkt vor dem Schrein.", options: ["十分前に行きます。", "十角前に行きます。", "十駅前に行きます。"], options_de: ["Ich bin 10 Min vorher da.", "10 Ecken vorher.", "10 Bahnhöfe vorher."], correct: 0 },
      { npc: "金魚すくいを担当してください。", npc_de: "Übernimm das Goldfisch-Angeln.", options: ["わかりました。", "いただきました。", "泳ぎました。"], options_de: ["Verstanden.", "Ich habe es erhalten.", "Ich bin geschwommen."], correct: 0 },
      { npc: "子どもに優しくね。", npc_de: "Sei nett zu Kindern.", options: ["もちろんです。", "もちろん駅。", "もちろん角。"], options_de: ["Natürlich.", "Natürlich Bahnhof.", "Natürlich Ecke."], correct: 0 },
      { npc: "休憩は交代で。", npc_de: "Pause im Wechsel.", options: ["はい、二十分ずつ。", "はい、二十角ずつ。", "はい、二十駅ずつ。"], options_de: ["Je 20 Minuten.", "Je 20 Ecken.", "Je 20 Bahnhöfe."], correct: 0 },
      { npc: "飲み物は本部で配ります。", npc_de: "Getränke am HQ.", options: ["あとでもらいます。", "あとで走ります。", "あとで泳ぎます。"], options_de: ["Ich hole sie später.", "Ich renne später.", "Ich schwimme später."], correct: 0 },
      { npc: "迷子の案内もお願いします。", npc_de: "Bitte auch Fundbüro/Infos für Verirrte.", options: ["アナウンスします。", "アニメします。", "アメします。"], options_de: ["Ich mache eine Ansage.", "Ich mache Anime.", "Ich mache Regen."], correct: 0 },
      { npc: "終了は九時ごろです。", npc_de: "Ende gegen 21 Uhr.", options: ["片づけを手伝います。", "寝るのを手伝います。", "走るのを手伝います。"], options_de: ["Ich helfe beim Aufräumen.", "Ich helfe beim Schlafen.", "Ich helfe beim Rennen."], correct: 0 },
      { npc: "ゴミは分別してください。", npc_de: "Bitte Müll trennen.", options: ["はい、燃えるゴミはこちら。", "はい、燃える駅はこちら。", "はい、燃える角はこちら。"], options_de: ["Ja, Restmüll hier.", "Brennender Bahnhof hier.", "Brennende Ecke hier."], correct: 0 },
      { npc: "おつかれさまでした。", npc_de: "Gute Arbeit!", options: ["ありがとうございました。", "おはようございました。", "さようならでした。"], options_de: ["Vielen Dank.", "Guten Morgen gewesen.", "Auf Wiedersehen gewesen."], correct: 0 }
    ]
  },
  {
    id: "level-005-E",
    level: 5,
    persona: "E：クラスメイト",
    title: "誕生日パーティー",
    about: "招待・準備・サプライズ",
    turns: [
      { npc: "日曜日、誕生日パーティーします。", npc_de: "Am Sonntag ist meine Geburtstagsparty.", options: ["おめでとう！行きます。", "おめでとう！泳ぎます。", "おめでとう！寝ます。"], options_de: ["Glückwunsch! Ich komme.", "Glückwunsch! Ich schwimme.", "Glückwunsch! Ich schlafe."], correct: 0 },
      { npc: "時間は三時からです。", npc_de: "Ab 15 Uhr.", options: ["十分前に着きます。", "十角前に着きます。", "十駅前に着きます。"], options_de: ["Ich bin 10 Min vorher da.", "10 Ecken vorher.", "10 Bahnhöfe vorher."], correct: 0 },
      { npc: "プレゼントはいりません。", npc_de: "Geschenke sind nicht nötig.", options: ["じゃ、カードだけ。", "じゃ、駅だけ。", "じゃ、角だけ。"], options_de: ["Dann nur eine Karte.", "Dann nur Bahnhof.", "Dann nur Ecke."], correct: 0 },
      { npc: "ケーキを用意します。", npc_de: "Ich besorge den Kuchen.", options: ["手伝いましょうか。", "泳ぎましょうか。", "走りましょうか。"], options_de: ["Soll ich helfen?", "Sollen wir schwimmen?", "Sollen wir rennen?"], correct: 0 },
      { npc: "サプライズも考えています。", npc_de: "Ich plane auch eine Überraschung.", options: ["秘密にしておきます。", "秘密にして泳ぎます。", "秘密にして走ります。"], options_de: ["Ich behalte es geheim.", "Ich halte es geheim und schwimme.", "Ich halte es geheim und renne."], correct: 0 },
      { npc: "場所はうちのリビング。", npc_de: "Bei mir im Wohnzimmer.", options: ["住所を送ってください。", "住所を食べてください。", "住所を泳いでください。"], options_de: ["Bitte schick mir die Adresse.", "Bitte iss die Adresse.", "Bitte schwimm die Adresse."], correct: 0 },
      { npc: "飲み物は各自でお願いします。", npc_de: "Getränke bitte selbst mitbringen.", options: ["わかりました。", "いただきました。", "ごちそうさまでした。"], options_de: ["Verstanden.", "Ich habe es erhalten.", "Danke für das Essen."], correct: 0 },
      { npc: "近所に迷惑をかけないように。", npc_de: "Bitte die Nachbarn nicht stören.", options: ["音量に気をつけます。", "音量を食べます。", "音量を泳ぎます。"], options_de: ["Ich achte auf die Lautstärke.", "Ich esse die Lautstärke.", "Ich schwimme die Lautstärke."], correct: 0 },
      { npc: "片づけも手伝ってね。", npc_de: "Hilf bitte beim Aufräumen.", options: ["もちろんです。", "もちろん駅。", "もちろん角。"], options_de: ["Natürlich.", "Natürlich Bahnhof.", "Natürlich Ecke."], correct: 0 },
      { npc: "来てくれてありがとう。", npc_de: "Danke fürs Kommen.", options: ["こちらこそ、楽しかった！", "おはよう、楽しかった！", "さようなら、楽しかった！"], options_de: ["Ganz meinerseits, war toll!", "Guten Morgen, war toll!", "Tschüss, war toll!"], correct: 0 }
    ]
  }
];
mergeLevel(5, L5);

// ---- Level 6: Schule & Freunde（学校・友だち）----
const L6 = [
  {
    id: "level-006-A",
    level: 6,
    persona: "A：クラスメイト",
    title: "授業と宿題",
    about: "科目・提出・質問",
    turns: [
      { npc: "どの科目が一番好き？", npc_de: "Welches Fach magst du am meisten?", options: ["歴史が好きです。", "駅史が好きです。", "角史が好きです。"], options_de: ["Ich mag Geschichte.", "Ich mag Bahnhofskunde.", "Ich mag Eckenkunde."], correct: 0 },
      { npc: "今日の宿題は出しましたか。", npc_de: "Hast du die Hausaufgaben abgegeben?", options: ["はい、オンラインで提出しました。", "はい、オンラインで走りました。", "はい、オンラインで泳ぎました。"], options_de: ["Ja, online eingereicht.", "Ja, online gerannt.", "Ja, online geschwommen."], correct: 0 },
      { npc: "レポートは何ページ？", npc_de: "Wie viele Seiten hat der Bericht?", options: ["三ページです。", "三人です。", "三角です。"], options_de: ["Drei Seiten.", "Drei Personen.", "Dreieck."], correct: 0 },
      { npc: "先生の説明は分かりやすい？", npc_de: "Erklärt die Lehrkraft gut?", options: ["はい、とても分かりやすいです。", "はい、とても青いです。", "はい、とても駅です。"], options_de: ["Ja, sehr verständlich.", "Ja, sehr blau.", "Ja, sehr Bahnhof."], correct: 0 },
      { npc: "テストはいつですか。", npc_de: "Wann ist die Prüfung?", options: ["来週の火曜日です。", "来週の角曜日です。", "来週の駅曜日です。"], options_de: ["Nächsten Dienstag.", "Nächsten Eckstag.", "Nächsten Bahnhofstag."], correct: 0 },
      { npc: "教科書を見せてもらえる？", npc_de: "Kannst du mir das Lehrbuch zeigen?", options: ["はい、どうぞ。", "はい、どうぞ駅。", "はい、どうぞ角。"], options_de: ["Klar, bitte.", "Bitte Bahnhof.", "Bitte Ecke."], correct: 0 },
      { npc: "ノートをコピーしてもいい？", npc_de: "Darf ich deine Mitschrift kopieren?", options: ["いいよ、あとで送るね。", "いいよ、あとで走るね。", "いいよ、あとで泳ぐね。"], options_de: ["Klar, ich schicke sie später.", "Klar, ich renne später.", "Klar, ich schwimme später."], correct: 0 },
      { npc: "わからないところがある。", npc_de: "Ich habe eine Verständnisfrage.", options: ["一緒に復習しよう。", "一緒に風しよう。", "一緒に駅しよう。"], options_de: ["Lass uns zusammen wiederholen.", "Lass uns zusammen Wind machen.", "Lass uns zusammen Bahnhof machen."], correct: 0 },
      { npc: "図書館で勉強しない？", npc_de: "Lernen wir in der Bibliothek?", options: ["うん、放課後に。", "うん、放課後駅。", "うん、放課後角。"], options_de: ["Ja, nach der Schule.", "Ja, Bahnhof nach der Schule.", "Ja, Ecke nach der Schule."], correct: 0 },
      { npc: "ありがとう、助かった。", npc_de: "Danke, das hat geholfen.", options: ["どういたしまして。", "さようなら（今）。", "おはようございます。"], options_de: ["Gern geschehen.", "Auf Wiedersehen (jetzt).", "Guten Morgen."], correct: 0 }
    ]
  },
  {
    id: "level-006-B",
    level: 6,
    persona: "B：先生",
    title: "グループワーク",
    about: "役割・時間・発表",
    turns: [
      { npc: "四人一組になってください。", npc_de: "Bitte bildet Vierergruppen.", options: ["はい、分かれます。", "はい、別れます。", "はい、別荘します。"], options_de: ["Ja, wir teilen uns auf.", "Ja, wir trennen uns (Beziehung).", "Ja, wir machen Ferienhaus."], correct: 0 },
      { npc: "あなたは司会をお願いします。", npc_de: "Du moderierst, bitte.", options: ["承知しました。", "少々しました。", "消耗しました。"], options_de: ["Einverstanden.", "Ich habe ein bisschen getan.", "Ich bin erschöpft."], correct: 0 },
      { npc: "時間は二十分です。", npc_de: "Ihr habt 20 Minuten.", options: ["配分に気をつけます。", "配分を食べます。", "配分を泳ぎます。"], options_de: ["Ich achte auf die Zeitverteilung.", "Ich esse die Verteilung.", "Ich schwimme die Verteilung."], correct: 0 },
      { npc: "資料は配りましたか。", npc_de: "Habt ihr die Handouts verteilt?", options: ["はい、配りました。", "はい、泳ぎました。", "はい、走りました。"], options_de: ["Ja, verteilt.", "Ja, geschwommen.", "Ja, gelaufen."], correct: 0 },
      { npc: "発表はだれがしますか。", npc_de: "Wer präsentiert?", options: ["私が発表します。", "私が発表を食べます。", "私が発表を泳ぎます。"], options_de: ["Ich präsentiere.", "Ich esse die Präsentation.", "Ich schwimme die Präsentation."], correct: 0 },
      { npc: "質問は三つまでです。", npc_de: "Maximal drei Fragen.", options: ["わかりました。", "いただきました。", "ごちそうさまでした。"], options_de: ["Verstanden.", "Ich habe es erhalten.", "Danke für das Essen."], correct: 0 },
      { npc: "静かに聞いてください。", npc_de: "Bitte ruhig zuhören.", options: ["はい、気をつけます。", "はい、気を食べます。", "はい、気を泳ぎます."], options_de: ["Ja, ich passe auf.", "Ja, ich esse die Stimmung.", "Ja, ich schwimme die Stimmung."], correct: 0 },
      { npc: "時間になりました。", npc_de: "Die Zeit ist um.", options: ["発表を終わります。", "発表を始めます。", "発表を走ります。"], options_de: ["Wir beenden die Präsentation.", "Wir beginnen die Präsentation.", "Wir rennen die Präsentation."], correct: 0 },
      { npc: "感想を一言どうぞ。", npc_de: "Kurzes Feedback, bitte.", options: ["わかりやすかったです。", "青かったです。", "駅だったです。"], options_de: ["War gut verständlich.", "War blau.", "War Bahnhof."], correct: 0 },
      { npc: "よくできました。", npc_de: "Gut gemacht.", options: ["ありがとうございます。", "おはようございます。", "さようなら（今）。"], options_de: ["Danke schön.", "Guten Morgen.", "Auf Wiedersehen (jetzt)."], correct: 0 }
    ]
  },
  {
    id: "level-006-C",
    level: 6,
    persona: "C：先輩",
    title: "進路の相談",
    about: "将来・インターン・助言",
    turns: [
      { npc: "将来は何をしたい？", npc_de: "Was möchtest du in Zukunft machen?", options: ["IT関係の仕事です。", "糸関係の仕事です。", "板関係の仕事です。"], options_de: ["Etwas im IT-Bereich.", "Etwas im Fadenbereich.", "Etwas im Brettbereich."], correct: 0 },
      { npc: "インターンは探した？", npc_de: "Hast du nach Praktika gesucht?", options: ["はい、二社応募しました。", "はい、二駅応募しました。", "はい、二角応募しました。"], options_de: ["Ja, bei zwei Firmen beworben.", "Bei zwei Bahnhöfen beworben.", "Bei zwei Ecken beworben."], correct: 0 },
      { npc: "履歴書を見てあげようか。", npc_de: "Soll ich deinen Lebenslauf anschauen?", options: ["お願いします。", "泳ぎます。", "走ります。"], options_de: ["Bitte.", "Ich schwimme.", "Ich renne."], correct: 0 },
      { npc: "自己PRは短く分かりやすく。", npc_de: "Selbstpräsentation kurz & klar.", options: ["はい、直します。", "はい、直進します。", "はい、直飲します。"], options_de: ["Ja, ich überarbeite es.", "Ja, ich fahre geradeaus.", "Ja, ich trinke direkt."], correct: 0 },
      { npc: "面接はいつ？", npc_de: "Wann ist das Vorstellungsgespräch?", options: ["来月の初めです。", "来月の角です。", "来月の駅です。"], options_de: ["Anfang nächsten Monats.", "Ecke nächsten Monats.", "Bahnhof nächsten Monats."], correct: 0 },
      { npc: "服装はスーツがいいね。", npc_de: "Ein Anzug ist passend.", options: ["そうします。", "そう泳ぎます。", "そう走ります。"], options_de: ["So mache ich’s.", "So schwimme ich.", "So renne ich."], correct: 0 },
      { npc: "質問を用意しておくと良いよ。", npc_de: "Bereite eigene Fragen vor.", options: ["考えておきます。", "考えて泳ぎます。", "考えて走ります。"], options_de: ["Ich überlege mir welche.", "Ich überlege schwimmend.", "Ich überlege rennend."], correct: 0 },
      { npc: "結果が出たら教えてね。", npc_de: "Sag Bescheid, wenn es Ergebnisse gibt.", options: ["すぐ連絡します。", "すぐ連絡を食べます。", "すぐ連絡を泳ぎます。"], options_de: ["Ich melde mich sofort.", "Ich esse die Nachricht.", "Ich schwimme die Nachricht."], correct: 0 },
      { npc: "焦らずにがんばって。", npc_de: "Ohne Hektik, gib dein Bestes.", options: ["ありがとうございます。", "おはようございます。", "さようなら。"], options_de: ["Vielen Dank.", "Guten Morgen.", "Auf Wiedersehen."], correct: 0 },
      { npc: "応援しているよ。", npc_de: "Ich drücke dir die Daumen.", options: ["うれしいです。", "あおいです。", "えきです。"], options_de: ["Ich freue mich.", "Es ist blau.", "Es ist Bahnhof."], correct: 0 }
    ]
  },
  {
    id: "level-006-D",
    level: 6,
    persona: "D：友だち",
    title: "部活・サークル",
    about: "練習・試合・応援",
    turns: [
      { npc: "今日、練習来られる？", npc_de: "Kannst du heute zum Training kommen?", options: ["はい、行けます。", "はい、泳げます。", "はい、寝られます。"], options_de: ["Ja, ich kann.", "Ja, ich kann schwimmen.", "Ja, ich kann schlafen."], correct: 0 },
      { npc: "集合は体育館前。", npc_de: "Treffpunkt vor der Turnhalle.", options: ["わかった、早めに行く。", "わかった、早めに泳ぐ。", "わかった、早めに駅。"], options_de: ["Alles klar, ich komme früher.", "Alles klar, ich schwimme früher.", "Alles klar, ich Bahnhof früher."], correct: 0 },
      { npc: "ウォームアップしてね。", npc_de: "Bitte warm laufen.", options: ["十分やります。", "十分食べます。", "十分泳ぎます。"], options_de: ["Ich mache 10 Minuten.", "Ich esse 10 Minuten.", "Ich schwimme 10 Minuten."], correct: 0 },
      { npc: "明日は練習試合です。", npc_de: "Morgen ist ein Freundschaftsspiel.", options: ["応援してね。", "公園してね。", "方円してね。"], options_de: ["Feuer uns an!", "Mach einen Park!", "Mach ein Quadrat!"], correct: 0 },
      { npc: "ポジションはどこ？", npc_de: "Welche Position spielst du?", options: ["ミッドです。", "ミットです。", "ミツです。"], options_de: ["Mid.", "Handschuh.", "Honig."], correct: 0 },
      { npc: "水分補給を忘れずに。", npc_de: "Vergiss das Trinken nicht.", options: ["はい、ボトルを持ちます。", "はい、ボトルを持ち物です。", "はい、ボトルを駅です。"], options_de: ["Ja, ich nehme die Flasche mit.", "Ja, die Flasche ist Gegenstand.", "Ja, die Flasche ist Bahnhof."], correct: 0 },
      { npc: "ケガには気をつけて。", npc_de: "Pass auf Verletzungen auf.", options: ["ストレッチします。", "ストレッチを食べます。", "ストレッチを泳ぎます。"], options_de: ["Ich dehne mich.", "Ich esse Stretch.", "Ich schwimme Stretch."], correct: 0 },
      { npc: "終わったら反省会。", npc_de: "Nachher kurze Nachbesprechung.", options: ["参加します。", "散火します。", "酸化します。"], options_de: ["Ich nehme teil.", "Ich lösche Feuer.", "Ich oxidieren."], correct: 0 },
      { npc: "次の大会もがんばろう。", npc_de: "Lass uns auch beim nächsten Turnier Gas geben.", options: ["うん、がんばる。", "うん、がまガル。", "うん、がま口。"], options_de: ["Ja, ich gebe mein Bestes.", "Ja, Krötenmann.", "Ja, Geldbeutel."], correct: 0 },
      { npc: "今日はありがとう。", npc_de: "Danke für heute.", options: ["こちらこそ。", "おはよう。", "さようなら（今）。"], options_de: ["Ganz meinerseits.", "Guten Morgen.", "Auf Wiedersehen (jetzt)."], correct: 0 }
    ]
  },
  {
    id: "level-006-E",
    level: 6,
    persona: "E：保健室の先生",
    title: "体調の相談",
    about: "けが・熱・連絡",
    turns: [
      { npc: "どこが痛いですか。", npc_de: "Wo tut es weh?", options: ["右足です。", "右駅です。", "右角です。"], options_de: ["Am rechten Bein.", "Rechter Bahnhof.", "Rechte Ecke."], correct: 0 },
      { npc: "いつから痛いですか。", npc_de: "Seit wann?", options: ["昨日からです。", "昨日駅です。", "昨日角です。"], options_de: ["Seit gestern.", "Gestern Bahnhof.", "Gestern Ecke."], correct: 0 },
      { npc: "熱はありますか。", npc_de: "Hast du Fieber?", options: ["少しあります。", "少し駅です。", "少し角です。"], options_de: ["Ein wenig.", "Ein wenig Bahnhof.", "Ein wenig Ecke."], correct: 0 },
      { npc: "今日は無理しないで。", npc_de: "Schone dich heute.", options: ["はい、休みます。", "はい、泳ぎます。", "はい、走ります。"], options_de: ["Ja, ich ruhe mich aus.", "Ja, ich schwimme.", "Ja, ich renne."], correct: 0 },
      { npc: "水をたくさん飲んでね。", npc_de: "Trink viel Wasser.", options: ["はい、気をつけます。", "はい、気を食べます。", "はい、気を泳ぎます。"], options_de: ["Ja, ich achte darauf.", "Ja, ich esse die Stimmung.", "Ja, ich schwimme die Stimmung."], correct: 0 },
      { npc: "病院に行ったほうがいい。", npc_de: "Geh besser ins Krankenhaus.", options: ["放課後に行きます。", "放課後に泳ぎます。", "放課後に走ります。"], options_de: ["Ich gehe nach der Schule.", "Ich schwimme nach der Schule.", "Ich renne nach der Schule."], correct: 0 },
      { npc: "連絡先を教えてください。", npc_de: "Bitte deine Kontaktdaten.", options: ["メールを送ります。", "メルを送ります。", "メロンを送ります。"], options_de: ["Ich schicke eine Mail.", "Ich schicke eine ‚Meru’.", "Ich schicke eine Melone."], correct: 0 },
      { npc: "ご家族にも知らせますか。", npc_de: "Sollen wir auch deine Familie informieren?", options: ["はい、お願いします。", "はい、泳ぎます。", "はい、走ります。"], options_de: ["Ja, bitte.", "Ja, ich schwimme.", "Ja, ich renne."], correct: 0 },
      { npc: "保健室で少し休んで。", npc_de: "Ruh dich kurz im Krankenzimmer aus.", options: ["ありがとうございます。", "おはようございます。", "さようなら。"], options_de: ["Danke schön.", "Guten Morgen.", "Auf Wiedersehen."], correct: 0 },
      { npc: "お大事に。", npc_de: "Gute Besserung.", options: ["はい、気をつけます。", "はい、駅をつけます。", "はい、角をつけます。"], options_de: ["Ja, ich passe auf.", "Ja, ich befestige einen Bahnhof.", "Ja, ich befestige eine Ecke."], correct: 0 }
    ]
  }
];
mergeLevel(6, L6);

  // ---- Level 7: Stadt & Wege（町・道案内）----
  const L7 = [
    {
      id: "level-007-A",
      level: 7,
      persona: "A：通行人",
      title: "道をたずねる",
      about: "方向・地図・目印",
      turns: [
        { npc: "すみません、駅はどちらですか。", npc_de: "Entschuldigung, wo ist der Bahnhof?", options: ["この道をまっすぐです。", "この道をまっさかさまです。", "この道をまっしろです。"], options_de: ["Geradeaus diese Straße.", "Kopfüber diese Straße.", "Schneeweiß diese Straße."], correct: 0 },
        { npc: "遠いですか。", npc_de: "Ist es weit?", options: ["歩いて十分くらいです。", "泳いで十分くらいです。", "飛んで十分くらいです。"], options_de: ["Zu Fuß ca. 10 Min.", "Schwimmend ca. 10 Min.", "Fliegend ca. 10 Min."], correct: 0 },
        { npc: "信号はいくつありますか。", npc_de: "Wie viele Ampeln gibt es?", options: ["二つあります。", "二人あります。", "二角あります。"], options_de: ["Zwei.", "Zwei Personen.", "Zwei Ecken."], correct: 0 },
        { npc: "地図を見てもいいですか。", npc_de: "Darf ich auf die Karte schauen?", options: ["どうぞ、ここです。", "どうぞ、雲です。", "どうぞ、角です。"], options_de: ["Gern, hier.", "Gern, die Wolke.", "Gern, die Ecke."], correct: 0 },
        { npc: "この先、右ですか左ですか。", npc_de: "Weiter vorn, rechts oder links?", options: ["右に曲がってください。", "右に歌ってください。", "右に泳いでください。"], options_de: ["Bitte rechts abbiegen.", "Bitte rechts singen.", "Bitte rechts schwimmen."], correct: 0 },
        { npc: "目印はありますか。", npc_de: "Gibt es ein Wahrzeichen?", options: ["青い看板があります。", "青い乾杯があります。", "青い乾燥があります。"], options_de: ["Es gibt ein blaues Schild.", "Es gibt einen blauen Toast.", "Es gibt blaue Trocknung."], correct: 0 },
        { npc: "地下道でも行けますか。", npc_de: "Geht es auch durch die Unterführung?", options: ["はい、近道です。", "はい、近火です。", "はい、近風です。"], options_de: ["Ja, das ist eine Abkürzung.", "Ja, nahe am Feuer.", "Ja, nahe am Wind."], correct: 0 },
        { npc: "このバスは駅に行きますか。", npc_de: "Fährt dieser Bus zum Bahnhof?", options: ["行きますが、遠回りです。", "行きますが、遠祭りです。", "行きますが、遠お腹です。"], options_de: ["Ja, aber Umweg.", "Ja, aber fernes Fest.", "Ja, aber ferner Bauch."], correct: 0 },
        { npc: "ありがとうございます。", npc_de: "Vielen Dank.", options: ["いえいえ、気をつけて。", "いえいえ、気を食べて。", "いえいえ、気を泳いで。"], options_de: ["Gern, passen Sie auf.", "Gern, essen Sie Luft.", "Gern, schwimmen Sie Luft."], correct: 0 },
        { npc: "おかげで助かりました。", npc_de: "Sie haben mir geholfen.", options: ["よかったです。", "よこったです。", "よこづなです。"], options_de: ["Freut mich.", "Seitwärts gut.", "Sumo-Großmeister."], correct: 0 }
      ]
    },
    {
      id: "level-007-B",
      level: 7,
      persona: "B：駅員",
      title: "乗り換え案内",
      about: "ホーム・路線・時刻",
      turns: [
        { npc: "空港へはどの路線ですか。", npc_de: "Welche Linie zum Flughafen?", options: ["青い線です。", "青い線ですか。", "青い線でしたか。"], options_de: ["Die blaue Linie.", "Die blaue Linie?", "War es die blaue Linie?"], correct: 0 },
        { npc: "何番ホームですか。", npc_de: "Gleisnummer?", options: ["三番ホームです。", "三番ホームですか。", "三番ホームでした。"], options_de: ["Gleis 3.", "Gleis 3?", "Es war Gleis 3."], correct: 0 },
        { npc: "急行は止まりますか。", npc_de: "Hält der Express?", options: ["はい、この駅に止まります。", "はい、この駅に泊まります。", "はい、この駅に止血します。"], options_de: ["Ja, er hält hier.", "Ja, er übernachtet hier.", "Ja, er stillt hier Blutungen."], correct: 0 },
        { npc: "次は何時発ですか。", npc_de: "Wann fährt der nächste?", options: ["10時15分です。", "10時15文です。", "10時15門です。"], options_de: ["Um 10:15.", "10:15 Satz.", "10:15 Tor."], correct: 0 },
        { npc: "乗り換えは必要ですか。", npc_de: "Muss ich umsteigen?", options: ["はい、一回だけです。", "はい、一階だけです。", "はい、一介だけです。"], options_de: ["Ja, nur einmal.", "Ja, nur im 1. Stock.", "Ja, nur ein Laie."], correct: 0 },
        { npc: "ICカードは使えますか。", npc_de: "Kann ich IC-Karte nutzen?", options: ["はい、全線で使えます。", "はい、全然で使えます。", "はい、前線で使えます。"], options_de: ["Ja, auf allen Linien.", "Ja, überhaupt.", "Ja, an der Front."], correct: 0 },
        { npc: "指定席はありますか。", npc_de: "Gibt es reservierte Plätze?", options: ["窓口で買えます。", "窓辺で買えます。", "窓拭きで買えます。"], options_de: ["Am Schalter erhältlich.", "Am Fensterbrett erhältlich.", "Mit Fensterputz erhältlich."], correct: 0 },
        { npc: "遅延していますか。", npc_de: "Gibt es Verspätungen?", options: ["今は平常運転です。", "今は平常雲転です。", "今は平常運天です。"], options_de: ["Derzeit regulär.", "Derzeit reguläre Wolkendrehung.", "Derzeit regulärer Himmelsbetrieb."], correct: 0 },
        { npc: "スーツケースはどこに置けば？", npc_de: "Wo stelle ich den Koffer ab?", options: ["足元にお願いします。", "足元にお願いしますか。", "足元にお願いしました。"], options_de: ["Bitte zu Ihren Füßen.", "Bitte zu Ihren Füßen?", "Ich bat zu Ihren Füßen."], correct: 0 },
        { npc: "助かりました。", npc_de: "Das hilft sehr.", options: ["よいご旅行を。", "よいご録音を。", "よいご六本を。"], options_de: ["Gute Reise!", "Gute Aufnahme!", "Gute sechs Bücher!"], correct: 0 }
      ]
    },
    {
      id: "level-007-C",
      level: 7,
      persona: "C：バス運転手",
      title: "車内アナウンス",
      about: "停留所・両替・降車ボタン",
      turns: [
        { npc: "次は市役所前です。", npc_de: "Nächster Halt: vor dem Rathaus.", options: ["降ります。", "踊ります。", "驚きます。"], options_de: ["Ich steige aus.", "Ich tanze aus.", "Ich erschrecke aus."], correct: 0 },
        { npc: "両替はできますか。", npc_de: "Kann ich wechseln?", options: ["車内で千円までです。", "車内で千年までです。", "車内で千本までです。"], options_de: ["Im Bus bis 1000 Yen.", "Im Bus bis 1000 Jahre.", "Im Bus bis 1000 Stück."], correct: 0 },
        { npc: "整理券をお取りください。", npc_de: "Bitte nehmen Sie eine Abschnittkarte.", options: ["はい、取りました。", "はい、撮りました。", "はい、獲りました。"], options_de: ["Ja, genommen.", "Ja, fotografiert.", "Ja, erbeutet."], correct: 0 },
        { npc: "降車ボタンはいつ押しますか。", npc_de: "Wann drücke ich den Halteknopf?", options: ["次の停留所の手前で。", "次の停留所の手紙で。", "次の停留所の手品で。"], options_de: ["Kurz vor der Haltestelle.", "Mit einem Brief.", "Mit einem Zaubertrick."], correct: 0 },
        { npc: "この路線は循環です。", npc_de: "Diese Linie ist eine Ringlinie.", options: ["同じ場所に戻ります。", "同じ場所に踊ります。", "同じ場所に香ります。"], options_de: ["Sie kommt zum Start zurück.", "Sie tanzt zurück.", "Sie duftet zurück."], correct: 0 },
        { npc: "優先席は空いていますか。", npc_de: "Ist ein Prioritätssitz frei?", options: ["前方に一席あります。", "前方に一石あります。", "前方に一析あります。"], options_de: ["Vorn ist einer frei.", "Vorn gibt’s einen Stein.", "Vorn gibt’s eine Analyse."], correct: 0 },
        { npc: "ベビーカーは畳んだほうがいい？", npc_de: "Kinderwagen besser zusammenklappen?", options: ["混雑時はお願いします。", "混雑時はお願いしますか。", "混雑時はお願いしました。"], options_de: ["Bei Andrang bitte ja.", "Bei Andrang bitte?", "Bei Andrang bat ich."], correct: 0 },
        { npc: "終点はどこですか。", npc_de: "Wo ist die Endhaltestelle?", options: ["中央ターミナルです。", "中央ターミネーターです。", "中央ターミヤミヤです。"], options_de: ["Am Zentralknoten.", "Am Terminator.", "Am Tamyamya."], correct: 0 },
        { npc: "ICカードをタッチしてください。", npc_de: "Bitte Karte an das Lesegerät halten.", options: ["ピッと鳴ります。", "ピアノが鳴ります。", "ピーマンが鳴ります。"], options_de: ["Es piept.", "Das Klavier klingelt.", "Die Paprika klingelt."], correct: 0 },
        { npc: "ご利用ありがとうございました。", npc_de: "Danke für die Fahrt.", options: ["おつかれさまでした。", "おつかれサラダでした。", "おつかれサメでした。"], options_de: ["Gute Fahrt noch.", "Es war Salat.", "Es war ein Hai."], correct: 0 }
      ]
    },
    {
      id: "level-007-D",
      level: 7,
      persona: "D：ナビアプリ",
      title: "経路検索",
      about: "徒歩・所要時間・混雑",
      turns: [
        { npc: "最短経路を表示します。", npc_de: "Ich zeige die kürzeste Route.", options: ["徒歩15分です。", "徒手15分です。", "徒詩15分です."], options_de: ["15 Min zu Fuß.", "15 Min mit bloßen Händen.", "15 Min mit Gedichten."], correct: 0 },
        { npc: "坂道があります。", npc_de: "Es gibt eine Steigung.", options: ["自転車は注意してください。", "自転車は注射してください。", "自転車は注視してください。"], options_de: ["Mit dem Rad bitte aufpassen.", "Bitte injizieren Sie Ihr Rad.", "Bitte starren Sie Ihr Rad an."], correct: 0 },
        { npc: "近道を使いますか。", npc_de: "Abkürzung verwenden?", options: ["はい、お願いします。", "はい、泳ぎます。", "はい、香ります。"], options_de: ["Ja, bitte.", "Ja, ich schwimme.", "Ja, es duftet."], correct: 0 },
        { npc: "現在地を更新しました。", npc_de: "Standort aktualisiert.", options: ["道なりに進みます。", "道なりに沈みます。", "道なりに炊きます。"], options_de: ["Der Straße folgen.", "Der Straße sinken.", "Die Straße kochen."], correct: 0 },
        { npc: "混雑エリアを回避します。", npc_de: "Ich umgehe überfüllte Bereiche.", options: ["助かります。", "溶かします。", "咲かします。"], options_de: ["Das hilft.", "Ich schmelze.", "Ich lasse blühen."], correct: 0 },
        { npc: "音声案内を開始します。", npc_de: "Starte Sprachnavigation.", options: ["音量を上げます。", "音量を揚げます。", "音量を浴びます。"], options_de: ["Ich erhöhe die Lautstärke.", "Ich frittiere die Lautstärke.", "Ich bade die Lautstärke."], correct: 0 },
        { npc: "トンネルに入ります。", npc_de: "Sie fahren in einen Tunnel.", options: ["GPSが弱くなります。", "GPSが若くなります。", "GPSが和くなります。"], options_de: ["GPS wird schwächer.", "GPS wird jünger.", "GPS wird japanisch."], correct: 0 },
        { npc: "目的地に到着しました。", npc_de: "Ziel erreicht.", options: ["ナビを終了します。", "ナビを就労します。", "ナビを収穫します。"], options_de: ["Navigation beenden.", "Navigation arbeitet.", "Navigation ernten."], correct: 0 },
        { npc: "レビューをお願いします。", npc_de: "Bitte bewerten.", options: ["星5にします。", "星5にしますか。", "星5にしましたか。"], options_de: ["Ich gebe 5 Sterne.", "Gebe ich 5 Sterne?", "Hast du 5 Sterne gegeben?"], correct: 0 },
        { npc: "ご利用ありがとうございました。", npc_de: "Danke für die Nutzung.", options: ["また使います。", "また吸います。", "また救います。"], options_de: ["Ich nutze es wieder.", "Ich sauge wieder.", "Ich rette wieder."], correct: 0 }
      ]
    },
    {
      id: "level-007-E",
      level: 7,
      persona: "E：観光案内所",
      title: "市内観光",
      about: "見どころ・パス・営業時間",
      turns: [
        { npc: "市内のおすすめは？", npc_de: "Was empfehlen Sie in der Stadt?", options: ["城と美術館です。", "城と美術缶です。", "城と美術巻です。"], options_de: ["Die Burg und das Museum.", "Die Burg und die Kunstdose.", "Die Burg und die Kunstrolle."], correct: 0 },
        { npc: "一日パスはありますか。", npc_de: "Gibt es einen Tagespass?", options: ["はい、バスと地下鉄用です。", "はい、バスと地下雪用です。", "はい、バスと地下絶用です。"], options_de: ["Ja, für Bus und U-Bahn.", "Ja, für Bus und Unter-Schnee.", "Ja, für Bus und Unter-Absolut."], correct: 0 },
        { npc: "営業時間は何時まで？", npc_de: "Bis wann sind die Öffnungszeiten?", options: ["午後6時までです。", "午後6詩までです。", "午後6紙までです。"], options_de: ["Bis 18 Uhr.", "Bis 18 Uhr Gedicht.", "Bis 18 Uhr Papier."], correct: 0 },
        { npc: "英語ガイドはありますか。", npc_de: "Gibt es englische Führungen?", options: ["土日にあります。", "土砂にあります。", "土星にあります。"], options_de: ["Am Wochenende.", "Im Erdrutsch.", "Auf dem Saturn."], correct: 0 },
        { npc: "雨でも楽しめますか。", npc_de: "Macht es auch bei Regen Spaß?", options: ["屋内施設が多いです。", "屋内失策が多いです。", "屋内失踪が多いです。"], options_de: ["Viele Indoor-Orte.", "Viele Indoor-Fehlgriffe.", "Viele Indoor-Verschwundene."], correct: 0 },
        { npc: "写真スポットはどこ？", npc_de: "Wo sind Fotospots?", options: ["川沿いがきれいです。", "皮沿いがきれいです。", "革沿いがきれいです。"], options_de: ["Am Flussufer.", "Am Hautufer.", "Am Lederufer."], correct: 0 },
        { npc: "混む時間帯は？", npc_de: "Wann ist es voll?", options: ["午後が混みます。", "午後が込みます。", "午後がゴミます。"], options_de: ["Nachmittags ist viel los.", "Nachmittags passt es hinein.", "Nachmittags wird es Müll."], correct: 0 },
        { npc: "割引はありますか。", npc_de: "Gibt es Rabatte?", options: ["学生証で10%です。", "学生層で10%です。", "学生想で10%です。"], options_de: ["Mit Studentenausweis 10 %.", "Mit Studentenschicht 10 %.", "Mit Studentengedanke 10 %."], correct: 0 },
        { npc: "パンフレットください。", npc_de: "Bitte einen Prospekt.", options: ["日本語と英語があります。", "日本語と塩語があります。", "日本語と園語があります。"], options_de: ["Es gibt JP/EN.", "Es gibt JP/Salz.", "Es gibt JP/Garten."], correct: 0 },
        { npc: "良い旅を！", npc_de: "Gute Reise!", options: ["ありがとうございます！", "ありが問います！", "ありが燃えます！"], options_de: ["Vielen Dank!", "Vielen Frage!", "Vielen Brand!"], correct: 0 }
      ]
    }
  ];
  mergeLevel(7, L7);

  // ---- Level 8: Hobbys（趣味）----
  const L8 = [
    {
      id: "level-008-A",
      level: 8,
      persona: "A：音楽好きの友だち",
      title: "ライブの計画",
      about: "チケット・ジャンル・音量",
      turns: [
        { npc: "今週ライブ行かない？", npc_de: "Kommen wir diese Woche aufs Konzert?", options: ["行こう！", "泳ごう！", "飛ぼう！"], options_de: ["Lass uns gehen!", "Lass uns schwimmen!", "Lass uns fliegen!"], correct: 0 },
        { npc: "どんなジャンルが好き？", npc_de: "Welche Genres magst du?", options: ["ロックが好き。", "ロックが石。", "ロックが鍵。"], options_de: ["Ich mag Rock.", "Rock ist Stein.", "Rock ist Schloss."], correct: 0 },
        { npc: "チケットは取れた？", npc_de: "Hast du Tickets bekommen?", options: ["先行で取ったよ。", "閃光で取ったよ。", "選考で取ったよ？"], options_de: ["Im Vorverkauf.", "Mit Blitz.", "Im Auswahlverfahren?"], correct: 0 },
        { npc: "スタンディングだけど大丈夫？", npc_de: "Stehplätze, ok?", options: ["うん、平気。", "うん、兵器。", "うん、平気？"], options_de: ["Ja, passt.", "Ja, Waffe.", "Ja, passt?"], correct: 0 },
        { npc: "音量が大きいかも。", npc_de: "Es könnte laut sein.", options: ["耳栓持っていく。", "耳線持っていく。", "耳船持っていく。"], options_de: ["Ich nehme Ohrstöpsel mit.", "Ich nehme Ohrleitung mit.", "Ich nehme Ohrenboot mit."], correct: 0 },
        { npc: "開演は19時だよ。", npc_de: "Beginn ist 19 Uhr.", options: ["18時に集合しよう。", "18時に就業しよう。", "18時に収業しよう。"], options_de: ["Treffen wir uns um 18 Uhr.", "Lass um 18 Uhr arbeiten.", "Lass um 18 Uhr fertig ernten."], correct: 0 },
        { npc: "物販も見たい。", npc_de: "Ich will auch zum Merch.", options: ["先に並ぼう。", "先に鳴ろう。", "先に習おう。"], options_de: ["Stellen wir uns vorher an.", "Lass vorher klingen.", "Lass vorher lernen."], correct: 0 },
        { npc: "終演後にごはん行く？", npc_de: "Nach dem Konzert essen?", options: ["近くのラーメンで。", "近くのラーメン？", "近くのラーメン！駅。"], options_de: ["Ramen in der Nähe.", "Ramen in der Nähe?", "Ramen in der Nähe! Bahnhof."], correct: 0 },
        { npc: "現地で合流ね。", npc_de: "Treffen vor Ort.", options: ["了解！", "涼快！", "良怪！"], options_de: ["Alles klar!", "Erfrischend!", "Guter Spuk!"], correct: 0 },
        { npc: "楽しもう！", npc_de: "Lass es krachen!", options: ["最高！", "再考！", "栽培！"], options_de: ["Mega!", "Nochmal nachdenken!", "Anbau!"], correct: 0 }
      ]
    },
    {
      id: "level-008-B",
      level: 8,
      persona: "B：スポーツ仲間",
      title: "ジョギング",
      about: "ペース・距離・水分",
      turns: [
        { npc: "今日は走る？", npc_de: "Laufen wir heute?", options: ["5キロだけね。", "5色だけね。", "5塔だけね。"], options_de: ["Nur 5 km.", "Nur 5 Farben.", "Nur 5 Türme."], correct: 0 },
        { npc: "ペースはどれくらい？", npc_de: "Welche Pace?", options: ["1kmを6分で。", "1kmを6文で。", "1kmを6粉で。"], options_de: ["6 Min pro km.", "6 Sätze pro km.", "6 Pulver pro km."], correct: 0 },
        { npc: "ストレッチした？", npc_de: "Hast du gedehnt?", options: ["軽くやった。", "軽くやった？", "軽くやったね？"], options_de: ["Kurz ja.", "Kurz ja?", "Kurz, nicht?"], correct: 0 },
        { npc: "今日は暑いね。", npc_de: "Heute ist es heiß.", options: ["水を多めに持つ。", "水を多めに持つ？", "水を多めに持つね？"], options_de: ["Ich nehme mehr Wasser mit.", "Nehme ich mehr Wasser mit?", "Ich nehme mehr Wasser mit, oder?"], correct: 0 },
        { npc: "どのコースにする？", npc_de: "Welche Strecke?", options: ["川沿いの周回。", "皮沿いの周回。", "革沿いの周回。"], options_de: ["Runde am Fluss.", "Runde an der Haut.", "Runde am Leder."], correct: 0 },
        { npc: "途中で歩いてもOK？", npc_de: "Zwischendurch gehen ok?", options: ["もちろん、無理しないで。", "もちろん、無理しないで？", "もちろん、無理しないでね？"], options_de: ["Klar, nicht übertreiben.", "Klar, nicht übertreiben?", "Klar, gell?"], correct: 0 },
        { npc: "ラスト1km上げよう。", npc_de: "Letzter km schneller.", options: ["やってみる！", "やってみる？", "やってみるね？"], options_de: ["Ich versuch’s!", "Versuch ich’s?", "Ich versuch’s, oder?"], correct: 0 },
        { npc: "記録つけてる？", npc_de: "Trackst du?", options: ["アプリで管理してる。", "アプリで甘味してる。", "アプリで乾燥してる。"], options_de: ["Ja, per App.", "Mit Süßigkeiten-App.", "Mit Trocken-App."], correct: 0 },
        { npc: "次は大会出ようよ。", npc_de: "Lass nächstes Mal einen Lauf machen.", options: ["5Kなら行ける。", "5Kなら池る。", "5Kなら負ける。"], options_de: ["5K schaffe ich.", "5K Teich.", "Bei 5K verliere ich."], correct: 0 },
        { npc: "おつかれ！", npc_de: "Gute Einheit!", options: ["ストレッチして解散。", "ストレッチして解散？", "ストレッチして計算。"], options_de: ["Stretch, dann Schluss.", "Stretch, dann Schluss?", "Stretch, dann rechnen."], correct: 0 }
      ]
    },
    {
      id: "level-008-C",
      level: 8,
      persona: "C：書店員",
      title: "読書の趣味",
      about: "ジャンル・在庫・取り寄せ",
      turns: [
        { npc: "どんな本をお探しですか。", npc_de: "Welche Bücher suchen Sie?", options: ["ミステリーです。", "ミステリーですか。", "ミステリーでした。"], options_de: ["Mystery.", "Mystery?", "War Mystery."], correct: 0 },
        { npc: "新刊と文庫、どちらにしますか。", npc_de: "Neuauflage oder Taschenbuch?", options: ["文庫でお願いします。", "文庫でお願いしますか。", "文庫でお願いしました。"], options_de: ["Taschenbuch bitte.", "Taschenbuch bitte?", "Ich bat um Taschenbuch."], correct: 0 },
        { npc: "在庫を確認します。", npc_de: "Ich prüfe den Bestand.", options: ["一冊だけあります。", "一皿だけあります。", "一猿だけあります。"], options_de: ["Nur ein Exemplar.", "Nur ein Teller.", "Nur ein Affe."], correct: 0 },
        { npc: "取り置きしますか。", npc_de: "Soll ich es zurücklegen?", options: ["お願いします。", "お願いしました？", "お願いしません。"], options_de: ["Bitte ja.", "Haben Sie gebeten?", "Bitte nicht."], correct: 0 },
        { npc: "電子版もあります。", npc_de: "Es gibt auch eine E-Book-Version.", options: ["紙で読みたいです。", "神で読みたいです。", "髪で読みたいです。"], options_de: ["Ich lese lieber auf Papier.", "Ich lese bei Gott.", "Ich lese mit Haaren."], correct: 0 },
        { npc: "ポイントはつけますか。", npc_de: "Punkte gutschreiben?", options: ["会員です。", "海員です。", "下位んです。"], options_de: ["Ich bin Mitglied.", "Ich bin Matrose.", "Ich bin untere Stufe."], correct: 0 },
        { npc: "お取り寄せも可能です。", npc_de: "Wir können auch bestellen.", options: ["一週間ほどかかります。", "一週間ほど書かります。", "一週間ほど輝きます。"], options_de: ["Es dauert ca. eine Woche.", "Es schreibt ca. eine Woche.", "Es glänzt ca. eine Woche."], correct: 0 },
        { npc: "おすすめありますか。", npc_de: "Haben Sie Empfehlungen?", options: ["受賞作が人気です。", "受章作が人気です。", "受傷作が人気です。"], options_de: ["Preisgekrönte Titel sind beliebt.", "Ordenstitel sind beliebt.", "Verletzungswerke sind beliebt."], correct: 0 },
        { npc: "紙袋いりますか。", npc_de: "Brauchen Sie eine Tüte?", options: ["いりません。", "いりますか。", "いりました。"], options_de: ["Nein, danke.", "Brauchen Sie?", "Ich brauchte sie."], correct: 0 },
        { npc: "ごゆっくりどうぞ。", npc_de: "Viel Spaß beim Stöbern.", options: ["ありがとうございます。", "ありがとう御膳。", "ありがとう午前。"], options_de: ["Vielen Dank.", "Danke, Mahlzeit.", "Danke, Vormittag."], correct: 0 }
      ]
    },
    {
      id: "level-008-D",
      level: 8,
      persona: "D：写真サークル",
      title: "撮影会",
      about: "構図・光・共有",
      turns: [
        { npc: "今日は街角を撮ろう。", npc_de: "Heute Street-Fotografie.", options: ["広角で攻めよう。", "広角で攻めよう？", "広角で責めよう。"], options_de: ["Mit Weitwinkel.", "Mit Weitwinkel?", "Mit Vorwürfen."], correct: 0 },
        { npc: "逆光だけど大丈夫？", npc_de: "Gegenlicht okay?", options: ["シルエットで狙う。", "シルエットで習う。", "シルエットで洗う。"], options_de: ["Ich gehe auf Silhouetten.", "Ich lerne mit Silhouetten.", "Ich wasche mit Silhouetten."], correct: 0 },
        { npc: "構図は三分割でいこう。", npc_de: "Drittelregel nutzen.", options: ["了解。", "涼快。", "妖怪。"], options_de: ["Alles klar.", "Erfrischend.", "Geistwesen."], correct: 0 },
        { npc: "RAWで撮ってる？", npc_de: "Fotografierst du in RAW?", options: ["はい、編集しやすい。", "はい、演出しやすい。", "はい、炎術しやすい。"], options_de: ["Ja, gut zu bearbeiten.", "Ja, gut zu inszenieren.", "Ja, gut für Feuerkunst."], correct: 0 },
        { npc: "ホワイトバランスは？", npc_de: "Weißabgleich?", options: ["オートで。", "オートドアで。", "オート麦で。"], options_de: ["Auf Auto.", "Mit Automatiktür.", "Mit Hafer."], correct: 0 },
        { npc: "SNSに上げよう。", npc_de: "Lass es posten.", options: ["タグを統一しよう。", "タグを統率しよう。", "タグを糖質しよう。"], options_de: ["Hashtag einheitlich.", "Hashtag kommandieren.", "Hashtag Zucker."], correct: 0 },
        { npc: "モデルさんにお礼を。", npc_de: "Bedank dich beim Model.", options: ["差し入れ持っていく。", "差し入れ持っていく？", "差し入れ持っていくね？"], options_de: ["Ich bringe Snacks mit.", "Bringe ich Snacks mit?", "Ich bringe Snacks, oder?"], correct: 0 },
        { npc: "雨が降ってきた。", npc_de: "Es fängt an zu regnen.", options: ["屋根のある所へ。", "屋根のある虎へ。", "屋根のあるところ？"], options_de: ["Unter ein Dach.", "Unter einen Dach-Tiger.", "Unter ein Dach?"], correct: 0 },
        { npc: "データ共有どうする？", npc_de: "Wie teilen wir die Dateien?", options: ["クラウドに上げる。", "クラウドに揚げる。", "クラウドに挙げる？"], options_de: ["In die Cloud laden.", "In der Cloud frittieren.", "In der Cloud erheben?"], correct: 0 },
        { npc: "おつかれ、また来週。", npc_de: "Gut gemacht, bis nächste Woche.", options: ["楽しみにしてる。", "楽譜みにしてる。", "楽器みにしてる。"], options_de: ["Ich freu mich drauf.", "Ich schaue Noten.", "Ich schaue Instrumente."], correct: 0 }
      ]
    },
    {
      id: "level-008-E",
      level: 8,
      persona: "E：ゲーム仲間",
      title: "オンラインプレイ",
      about: "招待・役割・ボイスチャット",
      turns: [
        { npc: "今夜レイドどう？", npc_de: "Raid heute Abend?", options: ["招待送って。", "正体送って。", "状態送って。"], options_de: ["Schick eine Einladung.", "Schick die wahre Identität.", "Schick den Zustand."], correct: 0 },
        { npc: "役割は何がいい？", npc_de: "Welche Rolle?", options: ["ヒーラーやる。", "ヒーターやる。", "ヒーローやる。"], options_de: ["Ich mach Healer.", "Ich mach Heizung.", "Ich mach Held."], correct: 0 },
        { npc: "ボイチャ入れる？", npc_de: "Voice-Chat an?", options: ["ミュート外す。", "ミュート外す？", "ミュート外しません。"], options_de: ["Ich mute ab.", "Mute ich ab?", "Ich mute nicht ab."], correct: 0 },
        { npc: "Ping高い？", npc_de: "Hoher Ping?", options: ["回線は安定。", "回線は安泰。", "回線は安堵。"], options_de: ["Verbindung stabil.", "Verbindung friedlich.", "Verbindung Erleichterung."], correct: 0 },
        { npc: "準備OK？", npc_de: "Bereit?", options: ["バフかけた。", "バフ掛けた？", "バフ欠けた。"], options_de: ["Buffs aktiv.", "Buffs aktiv?", "Buff fehlt."], correct: 0 },
        { npc: "ボス二段階目！", npc_de: "Boss Phase 2!", options: ["ギミック処理する。", "ギミック処理する？", "ギミック書類する。"], options_de: ["Mechanik handle ich.", "Handle ich die Mechanik?", "Ich mechanik-dokumentiere."], correct: 0 },
        { npc: "ナイスクリア！", npc_de: "Starker Clear!", options: ["GG！", "GJ！", "GPS！"], options_de: ["GG!", "GJ!", "GPS!"], correct: 0 },
        { npc: "報酬どうだった？", npc_de: "Loot okay?", options: ["神引きした。", "紙引きした。", "髪引きした。"], options_de: ["Mega Drop!", "Papierzug.", "Haarzug."], correct: 0 },
        { npc: "スクショ撮った？", npc_de: "Screenshot gemacht?", options: ["あとで共有する。", "あとで郷有する。", "あとで業務する。"], options_de: ["Ich teile später.", "Ich werde Heimat haben.", "Ich mache später Arbeit."], correct: 0 },
        { npc: "また組もう。", npc_de: "Lass wieder zusammenspielen.", options: ["いつでも！", "いずでも！", "いずれも！"], options_de: ["Jederzeit!", "Izu auch!", "Beides!"], correct: 0 }
      ]
    }
  ];
  mergeLevel(8, L8);

  // ---- Level 9: Wetter & Jahreszeiten（天気・季節）----
  const L9 = [
    {
      id: "level-009-A",
      level: 9,
      persona: "A：天気予報士",
      title: "予報を聞く",
      about: "降水確率・風・気温",
      turns: [
        { npc: "今日の降水確率は？", npc_de: "Wie hoch ist die Regenwahrscheinlichkeit heute?", options: ["50パーセントです。", "50パーセントですか。", "50パーセントでした。"], options_de: ["50 %.", "50 %?", "Es waren 50 %."], correct: 0 },
        { npc: "風は強いですか。", npc_de: "Ist es windig?", options: ["午後から強まります。", "午後から強がります。", "午後から強みます。"], options_de: ["Nachmittags nimmt er zu.", "Nachmittags prahlt er.", "Nachmittags wird er stark trinken."], correct: 0 },
        { npc: "最高気温は？", npc_de: "Wie hoch ist die Höchsttemperatur?", options: ["28度の予想です。", "28土の予想です。", "28戸の予想です。"], options_de: ["Erwartet sind 28 °C.", "Erwartet sind 28 Böden.", "Erwartet sind 28 Türen."], correct: 0 },
        { npc: "洗濯は乾きますか。", npc_de: "Trocknet die Wäsche?", options: ["午前中がチャンス。", "午前中がチーズ。", "午前中がチーフ。"], options_de: ["Vormittags ist gut.", "Vormittags ist Käse.", "Vormittags ist Chef."], correct: 0 },
        { npc: "雷注意報が出ています。", npc_de: "Gewitterwarnung aktiv.", options: ["外出を控えて。", "外出を抱えて。", "外出を測って。"], options_de: ["Bleib lieber drin.", "Halte den Ausgang im Arm.", "Miss den Ausgang."], correct: 0 },
        { npc: "花粉はどうですか。", npc_de: "Wie ist der Pollenflug?", options: ["多い見込みです。", "重い見込みです。", "青い見込みです。"], options_de: ["Voraussichtlich stark.", "Voraussichtlich schwer.", "Voraussichtlich blau."], correct: 0 },
        { npc: "紫外線は？", npc_de: "Wie stark ist UV?", options: ["午後は非常に強いです。", "午後は非常に強がりです。", "午後は非常に強火です。"], options_de: ["Nachmittags sehr stark.", "Nachmittags sehr prahlerisch.", "Nachmittags sehr starke Flamme."], correct: 0 },
        { npc: "傘は必要？", npc_de: "Brauche ich einen Schirm?", options: ["折りたたみを持って。", "折りたたみを持って？", "折りたたみを持ってね？"], options_de: ["Nimm einen Knirps mit.", "Nehme ich einen Knirps?", "Nimm einen, ja?"], correct: 0 },
        { npc: "明日は回復します。", npc_de: "Morgen wird es besser.", options: ["晴れ間が出ます。", "晴れ間が出ますか。", "晴れ間が出ました。"], options_de: ["Es gibt Auflockerungen.", "Gibt es Auflockerungen?", "Es gab Auflockerungen."], correct: 0 },
        { npc: "安全第一で。", npc_de: "Sicherheit geht vor.", options: ["ありがとうございます。", "ありがとう雷ざいます。", "ありがとう材ざいます。"], options_de: ["Danke.", "Danke, Donner.", "Danke, Material."], correct: 0 }
      ]
    },
    {
      id: "level-009-B",
      level: 9,
      persona: "B：近所の人",
      title: "季節の挨拶",
      about: "暑さ寒さ・衣替え・行事",
      turns: [
        { npc: "だいぶ涼しくなりましたね。", npc_de: "Es ist deutlich kühler geworden.", options: ["秋ですね。", "空ですね。", "机ですね。"], options_de: ["Herbstlich, nicht?", "Himmel, nicht?", "Tisch, nicht?"], correct: 0 },
        { npc: "衣替えはしましたか。", npc_de: "Haben Sie schon auf Herbstkleidung gewechselt?", options: ["もう長袖です。", "もう長船です。", "もう長線です。"], options_de: ["Ich trage schon Langarm.", "Ich trage schon Langschiff.", "Ich trage schon Langlinie."], correct: 0 },
        { npc: "今年は猛暑でしたね。", npc_de: "Es war dieses Jahr sehr heiß.", options: ["冷房に助けられました。", "冷棒に助けられました。", "冷帽に助けられました。"], options_de: ["AC hat gerettet.", "Kalter Stock half.", "Kalte Mütze half."], correct: 0 },
        { npc: "紅葉は見に行きますか。", npc_de: "Schauen Sie sich das Herbstlaub an?", options: ["来週行く予定です。", "来週行く用手です。", "来週行く要請です。"], options_de: ["Nächste Woche geplant.", "Manuell geplant.", "Per Anforderung geplant."], correct: 0 },
        { npc: "冬は雪が多いですか。", npc_de: "Gibt es im Winter viel Schnee?", options: ["今年は平年並みかも。", "今年は平年波かも。", "今年は平年涙かも。"], options_de: ["Vielleicht etwa durchschnittlich.", "Vielleicht Durchschnittswellen.", "Vielleicht Durchschnittstränen."], correct: 0 },
        { npc: "春は花見ですね。", npc_de: "Im Frühling gibt’s Hanami.", options: ["場所取りが大変です。", "場所取りが大変ですか。", "場所取りが大変でした。"], options_de: ["Platz sichern ist schwer.", "Platz sichern schwer?", "Platz sichern war schwer."], correct: 0 },
        { npc: "季節の挨拶状を書きます。", npc_de: "Ich schreibe saisonale Grüße.", options: ["素敵ですね。", "素敵ですか。", "素敵でしたか。"], options_de: ["Wie schön!", "Ist es schön?", "War es schön?"], correct: 0 },
        { npc: "鍋の季節だ。", npc_de: "Eintopf-Zeit!", options: ["白菜を買います。", "白才を買います。", "白妻を買います。"], options_de: ["Ich kaufe Chinakohl.", "Ich kaufe weißen Verdienst.", "Ich kaufe weiße Ehefrau."], correct: 0 },
        { npc: "体調に気をつけて。", npc_de: "Pass auf deine Gesundheit auf.", options: ["ありがとうございます。", "ありがとう在ります。", "ありがとう在宅。"], options_de: ["Danke dir.", "Danke, existiert.", "Danke, Homeoffice."], correct: 0 },
        { npc: "またお会いしましょう。", npc_de: "Bis bald.", options: ["はい、また。", "はい、俣。", "はい、股。"], options_de: ["Ja, bis dann.", "Ja, Gabelung.", "Ja, Oberschenkel."], correct: 0 }
      ]
    },
    {
      id: "level-009-C",
      level: 9,
      persona: "C：アウトドア仲間",
      title: "天気と予定",
      about: "キャンプ・風向・予備日",
      turns: [
        { npc: "週末キャンプ行ける？", npc_de: "Kannst du am Wochenende campen?", options: ["天気次第かな。", "天気資材かな。", "天気自在かな。"], options_de: ["Kommt aufs Wetter an.", "Kommt auf Material an.", "Kommt auf Freiheit an."], correct: 0 },
        { npc: "風向きはどう？", npc_de: "Wie ist die Windrichtung?", options: ["北風みたい。", "北笛みたい。", "北船みたい。"], options_de: ["Scheint Nordwind.", "Scheint Nordflöte.", "Scheint Nordschiff."], correct: 0 },
        { npc: "タープ必要？", npc_de: "Brauchen wir ein Tarp?", options: ["念のため持っていこう。", "念のため持っていこう？", "念のため持っていこー。"], options_de: ["Sicherheits halber mitnehmen.", "Mitnehmen?", "Mitnehmeeen."], correct: 0 },
        { npc: "予備日はある？", npc_de: "Gibt es einen Ausweichtermin?", options: ["日曜に変更可。", "日曜に変更歌。", "日曜に変更蚊。"], options_de: ["Sonntag ginge.", "Sonntag Lied.", "Sonntag Mücke."], correct: 0 },
        { npc: "焚き火できるかな。", npc_de: "Dürfen wir Feuer machen?", options: ["風次第で判断。", "風次第で犯人。", "風次第で反応。"], options_de: ["Hängt vom Wind ab.", "Hängt vom Täter ab.", "Hängt von der Reaktion ab."], correct: 0 },
        { npc: "夜は冷える？", npc_de: "Wird es nachts kühl?", options: ["寝袋は厚めで。", "寝袋は熱めで。", "寝袋は集めで。"], options_de: ["Nimm einen warmen Schlafsack.", "Nimm einen heißen Schlafsack.", "Nimm einen Sammelschlafsack."], correct: 0 },
        { npc: "虫は多い？", npc_de: "Viele Insekten?", options: ["スプレー持参で。", "スプレー自賛で。", "スプレー時差で。"], options_de: ["Insektenspray mitnehmen.", "Spray selbst loben.", "Spray mit Jetlag."], correct: 0 },
        { npc: "川の水位は？", npc_de: "Wie ist der Flusspegel?", options: ["最近は安定。", "最近は安泰。", "最近は案内。"], options_de: ["In letzter Zeit stabil.", "In letzter Zeit friedlich.", "In letzter Zeit Auskunft."], correct: 0 },
        { npc: "撤収は何時？", npc_de: "Wann bauen wir ab?", options: ["午前10時目安。", "午前10時目安？", "午前10時目安ね？"], options_de: ["Ziel: 10 Uhr.", "Ziel: 10 Uhr?", "Ziel: 10 Uhr, ok?"], correct: 0 },
        { npc: "じゃ、決行で。", npc_de: "Dann ziehen wir’s durch.", options: ["了解！", "涼快！", "妖怪！"], options_de: ["Alles klar!", "Erfrischend!", "Yōkai!"], correct: 0 }
      ]
    },
    {
      id: "level-009-D",
      level: 9,
      persona: "D：店員（衣料品）",
      title: "季節の服選び",
      about: "素材・重ね着・サイズ",
      turns: [
        { npc: "何をお探しですか。", npc_de: "Wonach suchen Sie?", options: ["春用の薄手のコート。", "春用の薄手のコート？", "春用の薄手のコート！"], options_de: ["Einen leichten Frühlingsmantel.", "Einen leichten Frühlingsmantel?", "Leichter Frühlingsmantel!"], correct: 0 },
        { npc: "サイズは？", npc_de: "Welche Größe?", options: ["Mサイズです。", "Nサイズです。", "夢サイズです。"], options_de: ["Größe M.", "Größe N.", "Traumgröße."], correct: 0 },
        { npc: "素材は綿と麻があります。", npc_de: "Baumwolle oder Leinen.", options: ["麻でお願いします。", "朝でお願いします。", "脚でお願いします。"], options_de: ["Leinen bitte.", "Morgens bitte.", "Mit dem Bein bitte."], correct: 0 },
        { npc: "重ね着もしやすいです。", npc_de: "Gut zum Layern.", options: ["試着してみます。", "試食してみます。", "試読してみます。"], options_de: ["Ich probiere es an.", "Ich koste es.", "Ich probelesen es."], correct: 0 },
        { npc: "色はどうしますか。", npc_de: "Welche Farbe?", options: ["明るいベージュで。", "明るい米汁で。", "明るい兵士で。"], options_de: ["Helles Beige.", "Helle Reissuppe.", "Heller Soldat."], correct: 0 },
        { npc: "洗濯は手洗い推奨です。", npc_de: "Handwäsche empfohlen.", options: ["気をつけます。", "気を食べます。", "気を泳ぎます。"], options_de: ["Ich achte darauf.", "Ich esse Luft.", "Ich schwimme Luft."], correct: 0 },
        { npc: "雨の日は撥水加工が便利。", npc_de: "Im Regen ist Imprägnierung praktisch.", options: ["スプレーを使います。", "スプーンを使います。", "スプリングを使います。"], options_de: ["Ich nutze Spray.", "Ich nutze Löffel.", "Ich nutze Feder."], correct: 0 },
        { npc: "ポイントをお付けしますか。", npc_de: "Punkte gutschreiben?", options: ["お願いします。", "お願いしません。", "お願いしましたか。"], options_de: ["Ja bitte.", "Nein danke.", "Haben Sie gebeten?"], correct: 0 },
        { npc: "お会計はレジでどうぞ。", npc_de: "Bitte an der Kasse zahlen.", options: ["はい、向かいます。", "はい、向かいますか。", "はい、向かいました。"], options_de: ["Ja, ich gehe hin.", "Gehe ich hin?", "Ich bin hingegangen."], correct: 0 },
        { npc: "ご利用ありがとうございました。", npc_de: "Danke für Ihren Einkauf.", options: ["また来ます。", "また着ます。", "また消します。"], options_de: ["Ich komme wieder.", "Ich ziehe es wieder an.", "Ich lösche wieder."], correct: 0 }
      ]
    },
    {
      id: "level-009-E",
      level: 9,
      persona: "E：旅行会社",
      title: "季節に合わせた旅",
      about: "ベストシーズン・持ち物・注意",
      turns: [
        { npc: "ベストシーズンはいつ？", npc_de: "Wann ist die beste Reisezeit?", options: ["春と秋です。", "春と空です。", "春と机です。"], options_de: ["Frühling und Herbst.", "Frühling und Himmel.", "Frühling und Tisch."], correct: 0 },
        { npc: "台風は多いですか。", npc_de: "Gibt es viele Taifune?", options: ["夏から秋にかけて。", "夏から秋に書けて。", "夏から秋に欠けて。"], options_de: ["Von Sommer bis Herbst.", "Schreibend Sommer–Herbst.", "Fehlend Sommer–Herbst."], correct: 0 },
        { npc: "持ち物は何が必要？", npc_de: "Was sollte ich mitnehmen?", options: ["薄手の羽織と雨具。", "薄手の羽織と雨牛。", "薄手の羽織と雨魚。"], options_de: ["Leichte Jacke und Regenzeug.", "Leichte Jacke und Regenkuh.", "Leichte Jacke und Regenfisch."], correct: 0 },
        { npc: "朝晩は冷えますか。", npc_de: "Wird es morgens/abends kalt?", options: ["地域によります。", "地域に寄ります。", "地域に頼ります。"], options_de: ["Kommt auf die Region an.", "Ich besuche die Region.", "Ich verlasse mich auf die Region."], correct: 0 },
        { npc: "現地の行事は？", npc_de: "Welche lokalen Feste?", options: ["収穫祭があります。", "収穫妻があります。", "収穫材があります。"], options_de: ["Es gibt ein Erntefest.", "Es gibt eine Ernte-Ehefrau.", "Es gibt Ernte-Holz."], correct: 0 },
        { npc: "人出は多い？", npc_de: "Viel los?", options: ["連休は混みます。", "連休は込ます。", "連休はゴミます。"], options_de: ["An Brücken-/Feiertagen voll.", "Bringt es zum Hineintun.", "Wird zu Müll."], correct: 0 },
        { npc: "予算は抑えたい。", npc_de: "Ich möchte das Budget niedrig halten.", options: ["平日が狙い目です。", "平日が狙い目ですか。", "平日が狙い目でした。"], options_de: ["Werktage sind gut.", "Werktage gut?", "Werktage waren gut."], correct: 0 },
        { npc: "現地SIMは買える？", npc_de: "Kann ich eine lokale SIM kaufen?", options: ["空港で手に入ります。", "空港で手に入りますか。", "空港で手に入りました。"], options_de: ["Am Flughafen erhältlich.", "Am Flughafen erhältlich?", "Gab es am Flughafen."], correct: 0 },
        { npc: "保険は必要？", npc_de: "Brauche ich eine Versicherung?", options: ["加入をおすすめします。", "加入をお勧めしますか。", "加入をお墨付きします。"], options_de: ["Wir empfehlen es.", "Empfehlen wir es?", "Wir besiegeln es."], correct: 0 },
        { npc: "良い旅を！", npc_de: "Gute Reise!", options: ["ありがとうございます！", "ありがとう雷ざいます！", "ありがとう旅ざいます！"], options_de: ["Vielen Dank!", "Danke, Donner!", "Danke, Reise!"], correct: 0 }
      ]
    }
  ];
  mergeLevel(9, L9);

const L10 = [
  {
    id: "level-010-A",
    level: 10,
    persona: "A：同僚",
    title: "日程調整",
    about: "ミーティング・予定・招待",
    turns: [
      { npc: "明日10時、打ち合わせいい？", npc_de: "Passt morgen 10 Uhr fürs Meeting?", options: ["大丈夫、カレンダー入れるね。", "大丈夫、カレンダー食べるね。", "大丈夫、カレンダー折れるね。"], options_de: ["Passt, trage es ein.", "Passt, ich esse den Kalender.", "Passt, ich knicke den Kalender."], correct: 0 },
      { npc: "オンラインか会議室かどっち？", npc_de: "Online oder Meetingraum?", options: ["会議室で。", "会議羊で。", "会議湿で。"], options_de: ["Im Raum.", "Im Sitzungs-Schaf.", "Im Sitzungs-Nass."], correct: 0 },
      { npc: "議題は共有済み？", npc_de: "Agenda schon geteilt?", options: ["今送ったよ。", "今吸ったよ。", "今沿ったよ。"], options_de: ["Gerade gesendet.", "Gerade eingeatmet.", "Gerade entlang gelaufen."], correct: 0 },
      { npc: "資料はどこにある？", npc_de: "Wo sind die Unterlagen?", options: ["共有フォルダだよ。", "共有フォークだよ。", "共有フォーマルだよ。"], options_de: ["Im Shared-Ordner.", "In der Shared-Gabel.", "In Shared-Formal."], correct: 0 },
      { npc: "招待リンク届いた？", npc_de: "Kam der Invite-Link an?", options: ["届いた、確認できた。", "届いた、確認できた？", "届いた、確認できない猫。"], options_de: ["Ja, geprüft.", "Ja, geprüft?", "Ja, nicht prüfbare Katze."], correct: 0 },
      { npc: "誰が議事録とる？", npc_de: "Wer macht das Protokoll?", options: ["僕がやるよ。", "僕がやるよ？", "僕が焼くよ。"], options_de: ["Ich übernehme.", "Ich übernehme?", "Ich backe es."], correct: 0 },
      { npc: "終わったら要点まとめて。", npc_de: "Bitte Key Points danach.", options: ["了解、共有する。", "了解、強要する。", "了解、共用する？"], options_de: ["Klar, ich teile sie.", "Klar, ich zwinge sie auf.", "Klar, Gemeinschaftsnutzung?"], correct: 0 },
      { npc: "遅れそうなら教えて。", npc_de: "Sag Bescheid, falls du dich verspätest.", options: ["すぐ連絡する。", "すぐ連絡する？", "すぐ連絡せず。"], options_de: ["Melde mich sofort.", "Melde ich mich?", "Melde mich nicht."], correct: 0 },
      { npc: "じゃ、明日よろしく。", npc_de: "Dann bis morgen.", options: ["よろしく！", "よろしく？", "よろしく魚！"], options_de: ["Bis dann!", "Bis dann?", "Bis dann, Fisch!"], correct: 0 },
      { npc: "コーヒーいる？", npc_de: "Magst du Kaffee?", options: ["ブラックでお願いします。", "ブラックでお願いしません。", "ブラックでお願いした？"], options_de: ["Schwarz bitte.", "Bitte nicht schwarz.", "Hast du schwarz gebeten?"], correct: 0 }
    ]
  },
  {
    id: "level-010-B",
    level: 10,
    persona: "B：上司",
    title: "進捗報告",
    about: "期限・優先度・課題",
    turns: [
      { npc: "今の案件の進捗は？", npc_de: "Wie ist der Stand beim Projekt?", options: ["70%まで完了です。", "70%まで感動です。", "70%まで乾燥です。"], options_de: ["Zu 70 % fertig.", "Bis 70 % gerührt.", "Bis 70 % getrocknet."], correct: 0 },
      { npc: "期限は守れそう？", npc_de: "Schaffen wir die Deadline?", options: ["予定どおりです。", "予定どおりですか。", "予定どおりです！ね？"], options_de: ["Planmäßig.", "Planmäßig?", "Planmäßig! oder?"], correct: 0 },
      { npc: "リスクはある？", npc_de: "Gibt es Risiken?", options: ["依存タスクが遅れ気味です。", "依存タスクがおくれ耳です。", "依存タスクが遅れ黄身です。"], options_de: ["Abhängige Tasks hängen nach.", "Verspätete Ohren.", "Verspätetes Eigelb."], correct: 0 },
      { npc: "優先度の見直しが必要だね。", npc_de: "Wir sollten die Prioritäten prüfen.", options: ["Aを先にやります。", "Aを先にやります？", "Aを先にやりますねね。"], options_de: ["Ich mache zuerst A.", "Mache ich zuerst A?", "Ich mache zuerst A ne-ne."], correct: 0 },
      { npc: "ステークホルダーには連絡した？", npc_de: "Stakeholder informiert?", options: ["昨日アップデートしました。", "昨日アップデートしましたか。", "昨日アップデートしましょう。"], options_de: ["Gestern upgedatet.", "Gestern upgedatet?", "Lass gestern updaten."], correct: 0 },
      { npc: "レビューはいつできる？", npc_de: "Wann ist das Review möglich?", options: ["金曜午後です。", "金曜午後ですが。", "金曜午後ですよ？"], options_de: ["Freitag Nachmittag.", "Freitag Nachmittag, aber…", "Freitag Nachmittag, oder?"], correct: 0 },
      { npc: "サマリー資料を用意して。", npc_de: "Bitte eine Zusammenfassung vorbereiten.", options: ["5枚でまとめます。", "5米でまとめます。", "5迷でまとめます。"], options_de: ["Auf 5 Folien.", "Mit 5 Reis.", "Mit 5 Verirrungen."], correct: 0 },
      { npc: "助けが必要なら言って。", npc_de: "Melde dich, wenn du Hilfe brauchst.", options: ["ありがとうございます。", "ありがとう在ります。", "ありがとう有り難う。"], options_de: ["Danke!", "Danke, existiert.", "Dank dank."], correct: 0 },
      { npc: "では引き続きよろしく。", npc_de: "Weiter so, danke.", options: ["がんばります。", "がんばります？", "がんばります魚。"], options_de: ["Ich gebe mein Bestes.", "Ich gebe mein Bestes?", "Ich gebe mein Bestes, Fisch."], correct: 0 },
      { npc: "来週1on1やろう。", npc_de: "Lass nächste Woche ein 1:1 machen.", options: ["火曜に空きがあります。", "火曜に秋があります。", "火曜に飽きがあります。"], options_de: ["Dienstag habe ich Zeit.", "Am Dienstag ist Herbst.", "Am Dienstag ist Langeweile."], correct: 0 }
    ]
  },
  {
    id: "level-010-C",
    level: 10,
    persona: "C：人事",
    title: "採用・入社",
    about: "面接・書類・オンボーディング",
    turns: [
      { npc: "面接の希望日時は？", npc_de: "Bevorzugter Interviewtermin?", options: ["木曜午前でお願いします。", "木曜午前でお願いしません。", "木曜午前でお願いした？"], options_de: ["Donnerstag Vormittag.", "Bitte nicht Donnerstag Vormittag.", "Hast du Do-Vormittag gebeten?"], correct: 0 },
      { npc: "オンライン面接で問題ない？", npc_de: "Online-Interview ok?", options: ["問題ありません。", "問題ありません？", "問題ありません猫。"], options_de: ["Kein Problem.", "Kein Problem?", "Kein Problem, Katze."], correct: 0 },
      { npc: "履歴書はPDFで送って。", npc_de: "Bitte den Lebenslauf als PDF.", options: ["今夜提出します。", "今夜提出しません。", "今夜提出しました？"], options_de: ["Reiche ich heute Abend ein.", "Reiche ich heute Abend nicht ein.", "Habe ich heute Abend eingereicht?"], correct: 0 },
      { npc: "入社手続きはオンラインで可能です。", npc_de: "Onboarding ist online möglich.", options: ["助かります。", "塗ります。", "盛ります。"], options_de: ["Sehr hilfreich.", "Ich streiche es.", "Ich häufe es an."], correct: 0 },
      { npc: "初日の集合時間は9時です。", npc_de: "Am ersten Tag Start 9 Uhr.", options: ["10分前に行きます。", "10分前にいきます？", "10分前にいきます猫。"], options_de: ["Ich bin 10 Min vorher da.", "Bin ich 10 Min vorher da?", "Ich bin 10 Min vorher da, Katze."], correct: 0 },
      { npc: "PCは貸与します。", npc_de: "Wir stellen einen Laptop.", options: ["受け取りサインします。", "受け取りサインしません。", "受け取りサインしました？"], options_de: ["Ich unterschreibe die Übergabe.", "Ich unterschreibe nicht.", "Habe ich unterschrieben?"], correct: 0 },
      { npc: "福利厚生の案内は読みました？", npc_de: "Benefits-Info gelesen?", options: ["はい、確認済みです。", "はい、確認炭です。", "はい、確認角です。"], options_de: ["Ja, geprüft.", "Ja, Prüf-Kohle.", "Ja, Prüf-Ecke."], correct: 0 },
      { npc: "給与振込口座を登録してください。", npc_de: "Bitte Kontodaten für die Überweisung.", options: ["本日登録します。", "本日盗録します。", "本日灯録します。"], options_de: ["Ich registriere heute.", "Ich registriere Diebstahl.", "Ich registriere Licht."], correct: 0 },
      { npc: "質問はありますか。", npc_de: "Haben Sie Fragen?", options: ["休暇制度について教えてください。", "休暇制度について蹴ってください。", "休暇制度について嗅いでください。"], options_de: ["Bitte erklären Sie den Urlaub.", "Bitte treten Sie Urlaub.", "Bitte riechen Sie Urlaub."], correct: 0 },
      { npc: "ようこそ！", npc_de: "Willkommen an Bord!", options: ["よろしくお願いします。", "よろしくお願いしません。", "よろしくお願いしました？"], options_de: ["Freue mich auf die Zusammenarbeit.", "Ich freue mich nicht.", "Habe ich mich gefreut?"], correct: 0 }
    ]
  },
  {
    id: "level-010-D",
    level: 10,
    persona: "D：ITサポート",
    title: "トラブル対応",
    about: "ログイン・VPN・更新",
    turns: [
      { npc: "どんな問題ですか。", npc_de: "Worum geht es genau?", options: ["ログインできません。", "ログインできます。", "ログイン食べます。"], options_de: ["Ich kann mich nicht einloggen.", "Ich kann mich einloggen.", "Ich esse Login."], correct: 0 },
      { npc: "エラーメッセージは？", npc_de: "Welche Fehlermeldung?", options: ["認証に失敗しました。", "忍者に失敗しました。", "人参に失敗しました。"], options_de: ["Authentifizierung fehlgeschlagen.", "Ninja fehlgeschlagen.", "Möhre fehlgeschlagen."], correct: 0 },
      { npc: "パスワードをリセットします。", npc_de: "Ich setze Ihr Passwort zurück.", options: ["お願いします。", "お願いしません。", "お願いしました？"], options_de: ["Bitte ja.", "Bitte nein.", "Haben Sie gebeten?"], correct: 0 },
      { npc: "VPNは接続できていますか。", npc_de: "Ist die VPN verbunden?", options: ["オフでした。今オンにしました。", "オフでした。今恩にしました。", "オフでした。今音にしました。"], options_de: ["War aus, jetzt an.", "War aus, jetzt Dankbarkeit.", "War aus, jetzt Ton."], correct: 0 },
      { npc: "再起動してみてください。", npc_de: "Bitte neu starten.", options: ["はい、再起動します。", "はい、再祈祷します。", "はい、再気筒します。"], options_de: ["Ja, starte neu.", "Ja, bete erneut.", "Ja, Zylinder erneut."], correct: 0 },
      { npc: "更新は最新ですか。", npc_de: "Sind Updates aktuell?", options: ["昨日更新しました。", "昨日行進しました。", "昨日香辛しました。"], options_de: ["Gestern aktualisiert.", "Gestern marschiert.", "Gestern gewürzt."], correct: 0 },
      { npc: "キャッシュをクリアしてください。", npc_de: "Bitte Cache leeren.", options: ["了解しました。", "涼快しました。", "妖怪しました。"], options_de: ["Verstanden.", "Erfrischt.", "Yōkai gemacht."], correct: 0 },
      { npc: "今はログインできますか。", npc_de: "Geht der Login jetzt?", options: ["できました！", "できました？", "できました猫。"], options_de: ["Es klappt!", "Hat es geklappt?", "Es klappt, Katze."], correct: 0 },
      { npc: "チケットをクローズします。", npc_de: "Ich schließe das Ticket.", options: ["ありがとうございました。", "ありがとう増しでした。", "ありがとう真っ白でした。"], options_de: ["Vielen Dank.", "Danke, mehr.", "Danke, schneeweiß."], correct: 0 },
      { npc: "アンケートにご協力ください。", npc_de: "Bitte füllen Sie die Umfrage aus.", options: ["後で回答します。", "後で怪盗します。", "後で街頭します。"], options_de: ["Antworte später.", "Später Gentleman-Dieb.", "Später Straßenstand."], correct: 0 }
    ]
  },
  {
    id: "level-010-E",
    level: 10,
    persona: "E：取引先（クライアント）",
    title: "商談",
    about: "要件・見積り・納期",
    turns: [
      { npc: "ご要件を伺えますか。", npc_de: "Können Sie die Anforderungen schildern?", options: ["Webサイトの刷新です。", "Webサイトの雑身です。", "Webサイトの雑音です。"], options_de: ["Relaunch der Website.", "Webseiten-Gemischkörper.", "Webseiten-Rauschen."], correct: 0 },
      { npc: "予算感はどのくらいですか。", npc_de: "Welche Budgetvorstellung?", options: ["上限は2万ユーロです。", "上限は2万ユーロですか。", "上限は2万ユーロでした。"], options_de: ["Obergrenze 20k EUR.", "Obergrenze 20k EUR?", "War 20k EUR."], correct: 0 },
      { npc: "納期はいつをご希望ですか。", npc_de: "Wunschtermin für die Lieferung?", options: ["3月末です。", "3月松です。", "3月待つです。"], options_de: ["Ende März.", "März-Kiefer.", "März warten."], correct: 0 },
      { npc: "見積りを送ります。", npc_de: "Ich schicke ein Angebot.", options: ["来週までにお願いします。", "来週までにお願いしません。", "来週までにお願いでした？"], options_de: ["Bitte bis nächste Woche.", "Bitte nicht bis nächste Woche.", "War es bis nächste Woche?"], correct: 0 },
      { npc: "要件定義のワークショップをしましょう。", npc_de: "Lassen Sie einen Workshop machen.", options: ["日程を調整します。", "日程を調味します。", "日程を長耳します。"], options_de: ["Ich koordiniere den Termin.", "Ich würze den Termin.", "Ich mache den Termin langohrig."], correct: 0 },
      { npc: "保守は必要ですか。", npc_de: "Brauchen Sie Wartung?", options: ["年間契約を希望します。", "年間契約を起望します。", "年間契約を気棒します。"], options_de: ["Wir möchten einen Jahresvertrag.", "Wir ersehnen ihn.", "Wir Stab der Luft.",], correct: 0 },
      { npc: "支払い条件は？", npc_de: "Zahlungsbedingungen?", options: ["月末締め翌月払い。", "月末締め翌月薔薇。", "月末締め翌月腹。"], options_de: ["Monatsende, Zahlung Folgemonat.", "Monatsende, Rose.", "Monatsende, Bauch."], correct: 0 },
      { npc: "承認フローはどうなっていますか。", npc_de: "Wie läuft der Freigabeprozess?", options: ["部長決裁です。", "武将決裁です。", "部長決済です？"], options_de: ["Genehmigung durch Abteilungsleiter.", "Genehmigung durch Feldherrn.", "Bezahlung durch Abteilungsleiter?"], correct: 0 },
      { npc: "契約書は電子でも可能です。", npc_de: "Vertrag auch elektronisch möglich.", options: ["Docuで署名します。", "Dokuで署名します。", "毒で署名します。"], options_de: ["Ich signiere via Docu.", "Ich signiere via Doku.", "Ich signiere mit Gift."], correct: 0 },
      { npc: "引き続きよろしくお願いします。", npc_de: "Freue mich auf die Zusammenarbeit.", options: ["こちらこそ。", "こちらゴソ。", "こちらコソ。"], options_de: ["Ganz meinerseits.", "Hier Rascheln.", "Hier im Geheimen."], correct: 0 }
    ]
  }
];
mergeLevel(10, L10);

// ---- Level 11: Reisen & Verkehr（旅行・交通）----
const L11 = [
  {
    id: "level-011-A",
    level: 11,
    persona: "A：空港チェックイン",
    title: "フライト手続き",
    about: "手荷物・座席・搭乗",
    turns: [
      { npc: "チェックインのお客様ですか。", npc_de: "Checken Sie ein?", options: ["はい、パスポートはこちらです。", "はい、パスポートはこっちですか。", "はい、パスポートはこっそりです。"], options_de: ["Ja, hier ist mein Pass.", "Ja, ist der Pass hier?", "Ja, der Pass heimlich."], correct: 0 },
      { npc: "お預け手荷物はありますか。", npc_de: "Aufgabegepäck?", options: ["スーツケース一つです。", "スイーツケース一つです。", "スーツ警察一つです。"], options_de: ["Ein Koffer.", "Ein Süßigkeitenkoffer.", "Eine Anzugpolizei."], correct: 0 },
      { npc: "危険物は入っていませんね。", npc_de: "Keine Gefahrgüter enthalten?", options: ["入っていません。", "入っていません？", "入っていません猫。"], options_de: ["Nein.", "Nein?", "Nein, Katze."], correct: 0 },
      { npc: "座席のご希望は？", npc_de: "Sitzwunsch?", options: ["通路側でお願いします。", "通路側でお願いしません。", "通路側でお願いでした？"], options_de: ["Gangplatz bitte.", "Bitte kein Gangplatz.", "War es Gangplatz?"], correct: 0 },
      { npc: "搭乗口はA12です。", npc_de: "Boarding Gate A12.", options: ["時間までに向かいます。", "時間までに向かわない。", "時間までに向かった？"], options_de: ["Ich gehe rechtzeitig hin.", "Ich gehe nicht hin.", "Bin ich rechtzeitig hin?"], correct: 0 },
      { npc: "手荷物は7kgまでです。", npc_de: "Handgepäck bis 7 kg.", options: ["了解しました。", "涼快しました。", "妖怪しました。"], options_de: ["Verstanden.", "Erfrischt.", "Yōkai gemacht."], correct: 0 },
      { npc: "出発は定刻です。", npc_de: "Abflug planmäßig.", options: ["助かります。", "司ります。", "疲れます。"], options_de: ["Gut zu hören.", "Ich leite es.", "Ich werde müde."], correct: 0 },
      { npc: "遅延の場合は連絡します。", npc_de: "Wir melden uns bei Verspätung.", options: ["通知をオンにします。", "通知を音にします。", "通知を斧にします。"], options_de: ["Ich aktiviere Benachrichtigungen.", "Ich mache sie zu Ton.", "Ich mache sie zur Axt."], correct: 0 },
      { npc: "荷物にタグを付けました。", npc_de: "Gepäck ist getaggt.", options: ["ありがとうございます。", "ありがとう在ります。", "ありがとう材ります。"], options_de: ["Vielen Dank.", "Danke, existiert.", "Danke, Material ist da."], correct: 0 },
      { npc: "良いご旅行を。", npc_de: "Guten Flug!", options: ["行ってきます。", "行ってきます？", "行ってきます猫。"], options_de: ["Bis später.", "Bis später?", "Bis später, Katze."], correct: 0 }
    ]
  },
  {
    id: "level-011-B",
    level: 11,
    persona: "B：ホテル受付",
    title: "チェックイン・滞在",
    about: "予約・朝食・延泊",
    turns: [
      { npc: "ご予約のお名前は。", npc_de: "Auf welchen Namen ist die Reservierung?", options: ["山田です。", "山だです。", "山だね。"], options_de: ["Yamada.", "Es ist Berg.", "Schon Berg."], correct: 0 },
      { npc: "パスポートのご提示を。", npc_de: "Bitte Ihren Pass.", options: ["どうぞ。", "どうぞ？", "どうぞ猫。"], options_de: ["Bitte sehr.", "Bitte sehr?", "Bitte Katze."], correct: 0 },
      { npc: "朝食は7時から10時です。", npc_de: "Frühstück 7–10 Uhr.", options: ["8時に行きます。", "8字に行きます。", "8児に行きます。"], options_de: ["Ich komme um 8.", "Ich gehe zu 8 Zeichen.", "Ich gehe zu 8 Kindern."], correct: 0 },
      { npc: "WIFIパスワードはこちら。", npc_de: "Hier das WLAN-Passwort.", options: ["接続してみます。", "接続して見ます。", "接続して味ます。"], options_de: ["Ich verbinde mich.", "Ich schaue Verbindung.", "Ich schmecke Verbindung."], correct: 0 },
      { npc: "お部屋は5階です。", npc_de: "Ihr Zimmer ist im 5. Stock.", options: ["エレベーターはどこですか。", "エレベーターはどこですか？", "エレベーターはどこですか猫。"], options_de: ["Wo ist der Aufzug?", "Wo ist der Aufzug?", "Wo ist der Aufzug, Katze?"], correct: 0 },
      { npc: "延泊は可能ですか。", npc_de: "Kann ich den Aufenthalt verlängern?", options: ["はい、1泊追加できます。", "はい、1拍追加できます。", "はい、1白追加できます。"], options_de: ["Ja, eine Nacht mehr.", "Ja, ein Schlag mehr.", "Ja, ein Weiß mehr."], correct: 0 },
      { npc: "ランドリーサービスは？", npc_de: "Gibt es Wäscheservice?", options: ["本日中に仕上がります。", "本日中に仕上がりますか。", "本日中に味がります。"], options_de: ["Fertig am selben Tag.", "Fertig am selben Tag?", "Geschmack am selben Tag."], correct: 0 },
      { npc: "周辺のおすすめは？", npc_de: "Tipps in der Umgebung?", options: ["旧市街がきれいです。", "旧市街がきれいですか。", "旧市街がきれいです猫。"], options_de: ["Die Altstadt ist schön.", "Ist die Altstadt schön?", "Altstadt ist schön, Katze."], correct: 0 },
      { npc: "チェックアウトは何時？", npc_de: "Wann ist Check-out?", options: ["正午です。", "正午ですか。", "正午です猫。"], options_de: ["Um 12 Uhr.", "Um 12 Uhr?", "Um 12 Uhr, Katze."], correct: 0 },
      { npc: "ご滞在をお楽しみください。", npc_de: "Einen angenehmen Aufenthalt!", options: ["ありがとうございます。", "ありがとう在ります。", "ありがとう洗います。"], options_de: ["Vielen Dank.", "Danke, existiert.", "Danke, ich wasche."], correct: 0 }
    ]
  },
  {
    id: "level-011-C",
    level: 11,
    persona: "C：レンタカー",
    title: "貸出・返却",
    about: "保険・ナビ・燃料",
    turns: [
      { npc: "ご予約はされていますか。", npc_de: "Haben Sie reserviert?", options: ["はい、コンパクトカーです。", "はい、コンパクトカレーです。", "はい、コンパクトカラスです。"], options_de: ["Ja, ein Kompaktwagen.", "Ja, Kompakt-Curry.", "Ja, Kompakt-Krähe."], correct: 0 },
      { npc: "免許証を拝見します。", npc_de: "Ihren Führerschein bitte.", options: ["こちらです。", "こちらです？", "こちらです猫。"], options_de: ["Hier.", "Hier?", "Hier, Katze."], correct: 0 },
      { npc: "保険はフルカバーにしますか。", npc_de: "Möchten Sie Vollkasko?", options: ["はい、お願いします。", "はい、お願いしません。", "はい、お願いでした？"], options_de: ["Ja bitte.", "Nein danke.", "War es bitte?"], correct: 0 },
      { npc: "カーナビは日本語対応です。", npc_de: "Das Navi hat Japanisch.", options: ["助かります。", "浸かります。", "測かります。"], options_de: ["Sehr hilfreich.", "Ich weiche ein.", "Ich messe vielleicht."], correct: 0 },
      { npc: "返却は満タン返しで。", npc_de: "Bitte vollgetankt zurück.", options: ["了解しました。", "涼快しました。", "妖怪しました。"], options_de: ["Verstanden.", "Erfrischt.", "Yōkai gemacht."], correct: 0 },
      { npc: "追加ドライバーは？", npc_de: "Zusätzlicher Fahrer?", options: ["一人登録します。", "一人盗録します。", "一人東録します。"], options_de: ["Ich registriere eine Person.", "Ich registriere Diebstahl.", "Ich registriere Ostaufzeichnung."], correct: 0 },
      { npc: "事故時の連絡先はこちら。", npc_de: "Kontakt im Schadensfall hier.", options: ["番号を保存します。", "番号を送粉します。", "番号を相撲します。"], options_de: ["Ich speichere die Nummer.", "Ich schicke Pollen.", "Ich mache Sumo."], correct: 0 },
      { npc: "返却時間は19時です。", npc_de: "Rückgabe 19 Uhr.", options: ["間に合うように戻ります。", "間に合うように踊ります。", "間に合うように盛ります。"], options_de: ["Ich bin rechtzeitig zurück.", "Ich tanze rechtzeitig.", "Ich häufe rechtzeitig an."], correct: 0 },
      { npc: "現車確認お願いします。", npc_de: "Bitte Fahrzeugcheck.", options: ["傷はありません。", "傷はあります？", "傷はありません猫。"], options_de: ["Keine Kratzer.", "Gibt es Kratzer?", "Keine Kratzer, Katze."], correct: 0 },
      { npc: "安全運転でどうぞ。", npc_de: "Gute und sichere Fahrt!", options: ["行ってきます。", "行ってきます？", "行ってきます猫。"], options_de: ["Bis später.", "Bis später?", "Bis später, Katze."], correct: 0 }
    ]
  },
  {
    id: "level-011-D",
    level: 11,
    persona: "D：鉄道カウンター",
    title: "切符・座席",
    about: "指定席・乗り換え・時刻",
    turns: [
      { npc: "どちらまで行かれますか。", npc_de: "Wohin fahren Sie?", options: ["京都までお願いします。", "京都までお願いしません。", "京都までお願いでした？"], options_de: ["Bis Kyoto bitte.", "Nicht bis Kyoto bitte.", "War es bis Kyoto?"], correct: 0 },
      { npc: "指定席にしますか。", npc_de: "Möchten Sie einen reservierten Sitz?", options: ["はい、窓側で。", "はい、窓川で。", "はい、窓皮で。"], options_de: ["Ja, Fensterseite.", "Ja, Fensterfluss.", "Ja, Fensterhaut."], correct: 0 },
      { npc: "出発は何時をご希望？", npc_de: "Wann möchten Sie abfahren?", options: ["14時台で。", "14時題で。", "14時大で。"], options_de: ["Irgendwann zwischen 14–15 Uhr.", "Thema 14 Uhr.", "Groß 14 Uhr."], correct: 0 },
      { npc: "乗り換えは一回です。", npc_de: "Einmaliges Umsteigen.", options: ["大丈夫です。", "大丈夫ですか。", "大丈夫です猫。"], options_de: ["In Ordnung.", "In Ordnung?", "In Ordnung, Katze."], correct: 0 },
      { npc: "運賃は片道で5,500円です。", npc_de: "Fahrpreis einfach 5.500 Yen.", options: ["カードで払います。", "カードで腹います。", "カードで祓います。"], options_de: ["Ich zahle mit Karte.", "Ich zahle mit Bauch.", "Ich vertreibe mit Karte."], correct: 0 },
      { npc: "車内販売はあります。", npc_de: "Es gibt Bordverkauf.", options: ["お弁当買います。", "お弁当買いますか。", "お弁当買います猫。"], options_de: ["Ich kaufe ein Bento.", "Kaufe ich ein Bento?", "Ich kaufe ein Bento, Katze."], correct: 0 },
      { npc: "遅延の可能性があります。", npc_de: "Verspätungen möglich.", options: ["余裕を見ます。", "余裕を見ます？", "余裕を観ます。"], options_de: ["Ich plane Puffer ein.", "Plane ich Puffer?", "Ich beobachte Puffer."], correct: 0 },
      { npc: "領収書は必要ですか。", npc_de: "Brauchen Sie eine Quittung?", options: ["はい、会社名で。", "はい、会社麺で。", "はい、会社面で。"], options_de: ["Ja, auf Firmenname.", "Ja, auf Firmennudeln.", "Ja, auf Firmengesicht."], correct: 0 },
      { npc: "発車番線は3番です。", npc_de: "Abfahrt von Gleis 3.", options: ["間違えないようにします。", "間違えないようにしますか。", "間違えないようにします猫。"], options_de: ["Ich pass auf.", "Passe ich auf?", "Ich pass auf, Katze."], correct: 0 },
      { npc: "良い旅を。", npc_de: "Gute Reise!", options: ["ありがとうございます。", "ありがとう在ります。", "ありがとう材ります。"], options_de: ["Vielen Dank.", "Danke, existiert.", "Danke, Material ist da."], correct: 0 }
    ]
  },
  {
    id: "level-011-E",
    level: 11,
    persona: "E：旅行プランナー",
    title: "行程づくり",
    about: "日数・移動・予約",
    turns: [
      { npc: "何日間の旅行ですか。", npc_de: "Wie viele Tage dauert die Reise?", options: ["5日間です。", "5時間です。", "5次元です。"], options_de: ["Fünf Tage.", "Fünf Stunden.", "Fünf Dimensionen."], correct: 0 },
      { npc: "移動手段はどうしますか。", npc_de: "Wie möchten Sie sich fortbewegen?", options: ["鉄道中心で。", "冶道中心で。", "手道中心で。"], options_de: ["Vorwiegend Bahn.", "Vorwiegend Metallurgieweg.", "Vorwiegend Handweg."], correct: 0 },
      { npc: "宿は決まっていますか。", npc_de: "Sind die Unterkünfte fix?", options: ["二泊は予約済みです。", "二泊は役場済みです。", "二泊は薬場済みです。"], options_de: ["Zwei Nächte sind gebucht.", "Zwei Nächte am Rathaus.", "Zwei Nächte in der Apotheke."], correct: 0 },
      { npc: "必見スポットは？", npc_de: "Must-see Orte?", options: ["城と市場です。", "城と市馬です。", "城と市魔です。"], options_de: ["Die Burg und der Markt.", "Die Burg und das Stadtpferd.", "Die Burg und der Stadtmagier."], correct: 0 },
      { npc: "混雑を避けたいです。", npc_de: "Ich möchte Menschenmassen vermeiden.", options: ["朝一で回りましょう。", "朝一で回りましょう？", "朝一で回りましょ魚。"], options_de: ["Früh starten.", "Früh starten?", "Früh starten, Fisch."], correct: 0 },
      { npc: "食事はどうしますか。", npc_de: "Wie planen Sie die Mahlzeiten?", options: ["地元の店に行きたい。", "地元の点に行きたい。", "地元の天に行きたい。"], options_de: ["Ich möchte lokale Läden.", "Ich möchte lokale Punkte.", "Ich möchte den lokalen Himmel."], correct: 0 },
      { npc: "予算は1日いくら？", npc_de: "Tagesbudget?", options: ["50ユーロ程度です。", "50ユーロ停度です。", "50ユーロ帝度です。"], options_de: ["Etwa 50 EUR.", "50 EUR Haltestellenlevel.", "50 EUR Kaiserniveau."], correct: 0 },
      { npc: "予約は私がまとめましょうか。", npc_de: "Soll ich die Buchungen bündeln?", options: ["お願いします。", "お願いしません。", "お願いしました？"], options_de: ["Ja bitte.", "Nein danke.", "Schon gebeten?"], correct: 0 },
      { npc: "最終日に空港までの交通は？", npc_de: "Transfer zum Flughafen am letzten Tag?", options: ["シャトルを手配します。", "シャトルを手杯します。", "シャトルを社トルします。"], options_de: ["Ich organisiere einen Shuttle.", "Ich organisiere eine Hand-Tasse.", "Ich organisiere Firmen-Trull."], correct: 0 },
      { npc: "素敵な旅になりますように。", npc_de: "Ich wünsche eine tolle Reise!", options: ["ありがとうございます！", "ありがとう在ります！", "ありがとう材ります！"], options_de: ["Vielen Dank!", "Danke, existiert!", "Danke, Material ist da!"], correct: 0 }
    ]
  }
];
mergeLevel(11, L11);

  // speichern (sortiert)
  const merged = [...byLevel.values()].sort((a,b)=>a.level-b.level);
  saveChats(merged);
}

// ---------- Router Hooks ----------
function renderChatsOverview(mount){
  ensureSeedChats();
  const all = loadChats().sort((a,b)=>a.level-b.level);
  mount.innerHTML = `
    <h2>Chats</h2>
    <div class="grid">
      ${all.map(lv => `
        <div class="card">
          <h3>Level ${lv.level}</h3>
          <div class="hint">${(lv.threads||[]).length} Personen</div>
          <div class="actions" style="margin-top:.5rem;">
            <button class="primary" onclick="goto('chats/level/${lv.level}')">Öffnen</button>
          </div>
        </div>
      `).join("")}
    </div>
  `;
}

function renderChatsLevel(mount, lvStr){
  const lv = Number(lvStr);
  const threads = getChatsForLevel(lv);
  mount.innerHTML = `
    <h2>Level ${lv} – Personen</h2>
    <div class="grid">
      ${threads.map(t => `
        <div class="card">
          <h3>${escapeHTML(t.persona)}</h3>
          <div class="hint">${escapeHTML(t.title||"")}</div>
          <p class="hint">${escapeHTML(t.about||"")}</p>
          <div class="actions">
            <button ${(!t.turns || !t.turns.length) ? "disabled title='Platzhalter – bald verfügbar'" : "" }
              class="${(!t.turns || !t.turns.length) ? '' : 'primary'}"
              onclick="${(!t.turns || !t.turns.length) ? '' : `goto('chat/play/${t.id}')`}">
              ${(!t.turns || !t.turns.length) ? "Demnächst" : "Chat starten"}
            </button>
            <button onclick="goto('chats')">Zurück</button>
          </div>
        </div>
      `).join("")}
    </div>
  `;
}

const CHAT_TRANSLATION_DELAY_MS = 1400;

function renderChatPlay(mount, threadId){
  const t = getThreadById(threadId);
  if (!t){ 
    mount.innerHTML = `<p>Chat nicht gefunden.</p>`;
    return;
  }

  const turns = t.turns || [];
  let i = 0;                   // aktueller Turn
  let hadMistake = false;      // mind. eine falsche Antwort gewählt
  let lastSpokenTurnIndex = -1;
  let showNpcHint = false;     // Romaji & Übersetzung des aktuellen NPC anzeigen?

  let turnSemanticOK = false;      // richtige Antwort?
  let turnPronunciationOK = false; // Aussprache gut genug?

  // Speech-Recognition-Instanz (pro Chat-Sitzung)
  let recognition = null;
  let listening = false;
  let speechBlocked = false;   // wenn Mikro-Zugriff verweigert wurde

  // ---- Hilfsfunktionen ----
  function lockAllOptions(root){
    root.querySelectorAll("button.optBtn").forEach(b => b.disabled = true);
  }

  function appendTranslationBubble(container, npcText, ansText){
    const wrap = document.createElement("div");
    wrap.style.marginTop = ".8rem";
    wrap.style.textAlign = "left";
    wrap.innerHTML = `
      <div style="max-width:520px; font-size:.95rem; line-height:1.45; color:var(--white);
                  background: rgba(42,42,42,.75); border-left:4px solid var(--lavender);
                  padding:.6rem .8rem; border-radius:.6rem; box-shadow:0 0 16px rgba(200,168,232,.12);">
        <div style="opacity:.95;">👤 ${escapeHTML(npcText||"")}</div>
        <div style="opacity:.85; margin-top:.25rem;">🧑 ${escapeHTML(ansText||"")}</div>
      </div>`;
    container.appendChild(wrap);
    try { wrap.scrollIntoView({behavior:"smooth", block:"end"}); } catch(e){}
    return wrap;
  }

  // Hole DE, fallback auf JP falls DE fehlt
  function getDE(turn, pickedIdx){
    const npcDE = (turn.npc_de || "").trim();
    const ansDE = Array.isArray(turn.options_de)
      ? String(turn.options_de[pickedIdx] || "").trim()
      : "";
    if (npcDE || ansDE) return { npc:npcDE, ans:ansDE };

    const npcJP = String(turn.npc || "");
    const ansJP = Array.isArray(turn.options) ? String(turn.options[pickedIdx] || "") : "";
    return { npc:npcJP, ans:ansJP };
  }

  // ---- Speech-Recognition aufsetzen ----
  function ensureRecognition(outEl, labelEl){
    if (!hasSpeechRecognition() || speechBlocked) return null;

    if (!recognition){
      recognition = new SpeechRec();
      recognition.lang = "ja-JP";
      recognition.interimResults = false;
      recognition.continuous = false;
      recognition.maxAlternatives = 3;

      recognition.onstart = () => {
        listening = true;
        if (labelEl){
          labelEl.textContent = "Aufnahme läuft … nach links wischen zum Verwerfen.";
        }
      };

      recognition.onend = () => {
        listening = false;
        if (labelEl && !speechBlocked){
          labelEl.textContent = "Zum Sprechen gedrückt halten, nach links wischen zum Verwerfen.";
        }
      };

      recognition.onerror = (ev) => {
        listening = false;
        const err = ev && ev.error;
        if (err === "not-allowed" || err === "service-not-allowed"){
          // Mikro dauerhaft gesperrt → in Lese-/Hörmodus wechseln
          speechBlocked = true;
          alert("Zugriff auf das Mikrofon wurde blockiert. Der Dialog läuft als Lese-/Hörübung weiter.");
          draw();
          return;
        }
        if (outEl){
          outEl.textContent = "Spracherkennung Fehler: " + (err || "unbekannt");
        }
      };

recognition.onresult = (ev) => {
  let transcript = "";
  try {
    const res = ev.results && ev.results[0];
    transcript = (res && res[0] && res[0].transcript) || "";
  } catch(e){}

  const turn = turns[i] || {};
  const expected =
    Array.isArray(turn.options) && typeof turn.correct === "number"
      ? String(turn.options[turn.correct] || "")
      : "";

  const ok = spokenMatchesExpected(transcript, expected);
  turnPronunciationOK = ok;

  if (outEl){
    outEl.innerHTML =
      `<div>Erkannt: <strong>${escapeHTML(transcript || "(nichts)")}</strong></div>` +
      `<div style="margin-top:.2rem;">${
        ok
          ? "✅ Klingt sehr nah an der Zielphrase. Super!"
          : "⚠️ Die Erkennung weicht ab – du kannst es beliebig oft neu versuchen."
      }</div>`;
  }

  // <<< Weiter-Logik nach guter Aussprache >>>
  // Nur wenn:
  // - Semantik richtig gewählt wurde (turnSemanticOK == true)
  // - Aussprache ok (ok == true)
  // → Weiter-Button einblenden
  if (ok && turnSemanticOK && i < turns.length) {
    const chatBox = document.getElementById("chatBox");
    if (chatBox) {
      // Alte Aussprache-Warnungen entfernen
      chatBox.querySelectorAll(".chatPronWarn").forEach(el => el.remove());

      // „Weiter“-Button nur einmal hinzufügen
      if (!document.getElementById("chatNextBtn")) {
        const nextWrap = document.createElement("div");
        nextWrap.className = "actions";
        nextWrap.style.marginTop = ".25rem";
        nextWrap.style.textAlign = "center";
        nextWrap.innerHTML = `<button class="primary" id="chatNextBtn">Weiter</button>`;
        chatBox.appendChild(nextWrap);

        document.getElementById("chatNextBtn").onclick = () => {
          i++;
          showNpcHint = false;
          turnSemanticOK = false;
          turnPronunciationOK = false;
          draw();
        };
      }
    }
  }
};
    }

    return recognition;
  }

  
  // ---- „Gedrückt halten + nach links wischen zum Verwerfen“ ----
  function setupHoldToTalk(btn, labelEl, outEl){
    if (!btn) return;
    btn.style.touchAction = "none";

    let pointerId = null;
    let startX = 0;
    let cancelBySwipe = false;

    function start(e){
      if (!hasSpeechRecognition() || speechBlocked) return;
      if (listening) return;

      cancelBySwipe = false;
      pointerId = e.pointerId || null;
      const touch = e.touches && e.touches[0];
      startX = (touch && touch.clientX) || e.clientX || 0;

      if (labelEl){
        labelEl.textContent = "Aufnahme läuft … nach links wischen zum Verwerfen.";
      }
      if (outEl){ outEl.textContent = ""; }

      const rec = ensureRecognition(outEl, labelEl);
      if (!rec) return;
      try { rec.start(); } catch(err){}

      e.preventDefault();
    }

    function move(e){
      if (pointerId === null) return;

      const touch = e.touches && e.touches[0];
      const x = (touch && touch.clientX) || e.clientX || 0;

      // nach links wischen → Aufnahme verwerfen
      if (!cancelBySwipe && x && startX && x < startX - 40){
        cancelBySwipe = true;
        if (labelEl){
          labelEl.textContent = "Aufnahme verworfen. Lass los, um neu zu starten.";
        }
        if (outEl){ outEl.textContent = ""; }
        if (recognition && listening){
          try { recognition.abort(); } catch(err){}
        }
      }
    }

    function end(){
      if (pointerId === null) return;
      const wasCanceled = cancelBySwipe;
      pointerId = null;

      if (wasCanceled){
        // schon verworfen → nichts mehr tun
        return;
      }

      if (recognition && listening){
        try { recognition.stop(); } catch(err){}
      }
    }

    btn.addEventListener("pointerdown", start);
    btn.addEventListener("pointermove", move);
    btn.addEventListener("pointerup", end);
    btn.addEventListener("pointercancel", end);
    btn.addEventListener("pointerleave", end);

    // klassischer Klick soll hier nichts extra tun
    btn.addEventListener("click", (e) => e.preventDefault());
  }

  // ---- Rendering ----
  function draw(){
    const done = (i >= turns.length);

    mount.innerHTML = `
      <h2>${escapeHTML(t.persona || "")} <span class="badge">Level ${escapeHTML(String(t.level || ""))}</span></h2>
      <div class="card">
        <div id="chatBox" style="min-height:240px;">
          ${
            done
              ? `<p>チャットは以上です。おつかれさま！</p>`
              : `
                <!-- NPC-Bubble -->
                <div style="margin:.4rem 0; text-align:left;">
                  <div style="display:inline-block; max-width:80%; padding:.6rem .9rem; background:#333;
                              border-radius:.9rem .9rem .9rem 0; font-size:1.05rem;">
                    ${escapeHTML(turns[i].npc)}
                  </div>

                  <!-- Button zum Ein-/Ausblenden von Romaji + Übersetzung -->
                  <div style="margin-top:.35rem; font-size:.8rem; opacity:.9;">
                    <button id="npcHintToggle"
                            style="border:none; background:transparent; color:#ccc; cursor:pointer; padding:0;">
                      🔍 Romaji &amp; Übersetzung anzeigen
                    </button>
                  </div>

                  ${
                    showNpcHint
                      ? `
                        <div id="npcHintBox"
                             style="margin-top:.25rem; font-size:.9rem; line-height:1.4; color:#ddd;
                                    background:#262626; border-radius:.5rem; padding:.4rem .6rem;">
                          ${
                            (turns[i].npc_romaji || "").trim()
                              ? `<div><strong>Romaji:</strong> ${escapeHTML(turns[i].npc_romaji)}</div>`
                              : ``
                          }
                          ${
                            (turns[i].npc_de || "").trim()
                              ? `<div><strong>Deutsch:</strong> ${escapeHTML(turns[i].npc_de)}</div>`
                              : ``
                          }
                        </div>
                      `
                      : ``
                  }
                </div>

                <!-- Antwortoptionen -->
                <div id="optBox" style="display:grid; gap:.45rem; margin-top:1.2rem;">
                  ${turns[i].options.map((txt,idx)=>`
                    <div style="text-align:right;">
                      <button class="optBtn" data-idx="${idx}"
                              style="font-size:.92rem; padding:.45rem .7rem;
                                     background:#2a2a2a; border:none; border-radius:.8rem .8rem 0 .8rem;
                                     max-width:80%; text-align:right; color:var(--white);">
                        ${escapeHTML(txt)}
                      </button>
                    </div>
                  `).join("")}
                </div>

                                <!-- Sprechbereich -->
                <div id="speechArea" style="margin-top:1rem; border-top:1px dashed #444; padding-top:.75rem;">
                  ${
                    hasSpeechRecognition() && !speechBlocked
                      ? `
                        <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap;">
                          <button id="chatRecordBtn"
        style="padding:.5rem .9rem; border-radius:999px;
               border:none; background:#444; color:#fff; font-size:.95rem;
               transition:.12s transform ease-out,.12s box-shadow ease-out,.12s background-color ease-out;">
  🎙️ Gedrückt halten
</button>

                          <div id="chatRecLabel" class="hint" style="font-size:.85rem;">
                            Zum Sprechen gedrückt halten, nach links wischen zum Verwerfen.
                          </div>
                        </div>

                        <div style="margin-top:.5rem; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;">
                          <button id="chatSkipSpeechBtn"
                                  class="mini"
                                  style="border-radius:999px; border:none; padding:.25rem .7rem; font-size:.78rem;">
                            🙊 Kann gerade nicht sprechen
                          </button>
                          <span class="hint" style="font-size:.8rem;">
                            Der Dialog läuft dann ohne Sprachaufnahme weiter.
                          </span>
                        </div>

                        <div id="chatRecResult" class="hint" style="margin-top:.5rem; font-size:.9rem;"></div>
                      `
                      : `
                        <div class="hint">
                          Sprachaufnahme auf diesem Gerät/Browser nicht verfügbar.
                          Du kannst den Chat als Lese- und Hörübung nutzen (Buttons + Vorlesen).
                        </div>
                      `
                  }
                </div>

              `
          }
        </div>
      </div>

      <div class="actions" style="margin-top:.75rem;">
        ${
          done
            ? `
              <button class="primary" onclick="goto('chats/level/${t.level}')">次の人へ</button>
              <button onclick="goto('chats')">Zur Übersicht</button>
            `
            : `
              <button onclick="goto('chats/level/${t.level}')">Abbrechen</button>
            `
        }
      </div>
    `;

    const doneNow = done;

    // NPC automatisch sprechen lassen (nur einmal pro Turn)
    if (!doneNow && lastSpokenTurnIndex !== i){
      lastSpokenTurnIndex = i;
      try { speak(turns[i].npc); } catch(e){}
    }

    // 🔍 Toggle für Romaji & Deutsch
    const hintBtn = document.getElementById("npcHintToggle");
    if (hintBtn && !doneNow){
      hintBtn.addEventListener("click", (ev) => {
        ev.preventDefault();
        showNpcHint = !showNpcHint;
        draw();
      });
    }

    if (!doneNow){
      const chatBox = document.getElementById("chatBox");
      const optBox  = document.getElementById("optBox");

      // Antwort-Buttons
      optBox.querySelectorAll(".optBtn").forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.dataset.idx);
          const correct = turns[i].correct;

          if (idx === correct){
            // richtig -> grün & sperren
            btn.style.background = "#2d5a2d";
            btn.style.color = "#dff0df";
            lockAllOptions(optBox);
            turnSemanticOK = true;
            turnSemanticOK = false;

            const { npc, ans } = getDE(turns[i], idx);

            // kleine Verzögerung wie CHAT_TRANSLATION_DELAY_MS
setTimeout(() => {
    appendTranslationBubble(chatBox, npc, ans);

// Wenn noch keine gute Aussprache: Hinweis anzeigen
if (!turnPronunciationOK){
  const warn = document.createElement("div");
  warn.className = "chatPronWarn";          // <<< WICHTIG: Klasse hinzufügen
  warn.style.marginTop = ".5rem";
  warn.style.color = "#ffc200";
  warn.style.fontSize = ".9rem";
  warn.textContent = "Bitte sprich den Satz laut nach, um fortzufahren.";
  chatBox.appendChild(warn);
  return; // Weiter erst wenn Speak OK
}

    // ✔ Semantik OK + Aussprache OK → Weiter-Button
    const nextWrap = document.createElement("div");
    nextWrap.className = "actions";
    nextWrap.style.marginTop = ".25rem";
    nextWrap.style.textAlign = "center";
    nextWrap.innerHTML = `<button class="primary" id="chatNextBtn">Weiter</button>`;
    chatBox.appendChild(nextWrap);

    document.getElementById("chatNextBtn").onclick = () => {
        i++;
        showNpcHint = false;
        turnSemanticOK = false;
        turnPronunciationOK = false;
        draw();
    };
}, CHAT_TRANSLATION_DELAY_MS);

          } else {
            // falsch -> rot, Button sperren (weitere Versuche möglich)
            hadMistake = true;
            btn.style.background = "#5a2a2a";
            btn.style.color = "#ffcccc";
            btn.disabled = true;
          }
        };
      });

      // Speech-UI initialisieren (falls verfügbar)
      // Speech-UI initialisieren (falls verfügbar)
      if (hasSpeechRecognition() && !speechBlocked){
        const recBtn   = document.getElementById("chatRecordBtn");
        const recLabel = document.getElementById("chatRecLabel");
        const recOut   = document.getElementById("chatRecResult");
        setupHoldToTalk(recBtn, recLabel, recOut);

                // Visuelles Feedback beim Gedrückthalten des Aufnahme-Buttons
        if (recBtn){
          const baseBg = recBtn.style.background || "#444";

          const setPressed = () => {
            recBtn.style.transform  = "scale(0.96)";
            recBtn.style.background = "#c62828";
            recBtn.style.boxShadow  = "0 0 0 3px rgba(198,40,40,0.4)";
          };

          const resetVisual = () => {
            recBtn.style.transform  = "";
            recBtn.style.background = baseBg;
            recBtn.style.boxShadow  = "";
          };

          // Maus / Pointer
          recBtn.addEventListener("pointerdown", () => {
            setPressed();
          });
          recBtn.addEventListener("pointerup", () => {
            resetVisual();
          });
          recBtn.addEventListener("pointerleave", () => {
            resetVisual();
          });
          recBtn.addEventListener("pointercancel", () => {
            resetVisual();
          });

          // Touch (für Smartphones)
          recBtn.addEventListener("touchstart", () => {
            setPressed();
          }, { passive: true });
          recBtn.addEventListener("touchend", () => {
            resetVisual();
          });
          recBtn.addEventListener("touchcancel", () => {
            resetVisual();
          });
        }


        // „Kann gerade nicht sprechen“ → Dialog ohne Sprachaufnahme fortsetzen
        const skipBtn = document.getElementById("chatSkipSpeechBtn");
        if (skipBtn){
          skipBtn.addEventListener("click", (ev) => {
            ev.preventDefault();
            speechBlocked = true; // für diese Chat-Sitzung in den Lese-/Hörmodus wechseln
            alert("Alles klar – dieser Dialog läuft jetzt ohne Sprachaufnahme weiter. Du kannst einfach mit den Antwort-Buttons fortfahren.");
            draw(); // UI neu zeichnen -> oben erscheint der Hinweis-Text statt Mikro
          });
        }
      }


    } else {
      // Chat fertig → nur wenn komplett ohne Fehler: Fortschritt
      if (!hadMistake && turnSemanticOK && turnPronunciationOK){
        try { addProgressIfFlawless(1); } catch(e){}
      }
    }
  }

  draw();
}



// ---------- Router-Integration ----------
(function patchRouter(){
  const _render = render;
  render = function(){
    const m = $("#app");
    if (state.route === "chats") return renderChatsOverview(m);
    if (state.route.startsWith("chats/level/")) return renderChatsLevel(m, state.route.split("/")[2]);
    if (state.route.startsWith("chat/play/")) return renderChatPlay(m, state.route.split("/")[2]);
    return _render.apply(this, arguments);
  };
})();

// ---------- Init einmalig sicherstellen ----------
try { ensureSeedChats(); } catch(e){}


// iOS Audio-Unlock
(function setupAudioUnlock(){
  const C = window.AudioContext || window.webkitAudioContext;
  if (!C) return;
  const ctx = new C();
  function unlock() {
    if (ctx.state !== 'running') ctx.resume();
    // Stiller Buffer – kein externes File nötig
    const b = ctx.createBuffer(1, 1, 22050);
    const s = ctx.createBufferSource(); s.buffer = b; s.connect(ctx.destination);
    try { s.start(0); } catch {}
    ['touchstart','pointerdown','keydown','click'].forEach(ev =>
      window.removeEventListener(ev, unlock, {passive:true})
    );
  }
  ['touchstart','pointerdown','keydown','click'].forEach(ev =>
    window.addEventListener(ev, unlock, {once:true, passive:true})
  );
  window.__audioCtx = ctx;
})();

const tapEvt = ('ontouchstart' in window) ? 'touchstart' : 'click';
document.getElementById('startBtn')
  .addEventListener(tapEvt, startGame, {passive:true});
class WritingPad {
  constructor(canvas, hintEl) {
    this.canvas = canvas;
    this.hintEl = hintEl;
    this.ctx = canvas.getContext("2d");
    this.drawing = false;
    this.baseWidth = 6;

    // Undo-Stack
    this._history = [];
    this._maxHistory = 50;

    this.resize();
    this._bind();
    window.addEventListener("resize", () => this.resize());
  }

  resize() {
    const rect = this.canvas.getBoundingClientRect();
    this.canvas.width  = rect.width;
    this.canvas.height = rect.height;
    this.ctx.lineCap = "round";
    this.ctx.lineJoin = "round";
    this.ctx.strokeStyle = "#fff";
    this.ctx.lineWidth = this.baseWidth;
  }

  setWidth(px){ this.baseWidth = +px || 6; this.ctx.lineWidth = this.baseWidth; }
  setHintChar(ch){ if (this.hintEl) this.hintEl.textContent = ch || ""; }

  _pushSnapshot(){
    try{
      const img = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
      this._history.push(img);
      if (this._history.length > this._maxHistory) this._history.shift();
    }catch(e){}
  }

  undo(){
    const prev = this._history.pop();
    if (!prev) return;
    this.ctx.putImageData(prev, 0, 0);
  }

  clear(){
    this._pushSnapshot();
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
  }

  _getPos(e){
    const rect = this.canvas.getBoundingClientRect();
    if (e.touches && e.touches.length){
      return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
    }
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }

  _bind(){
    const c = this.canvas;
    c.style.touchAction = "none";
    const start = (e) => {
      e.preventDefault();
      this._pushSnapshot();           // Zustand vor dem Strich sichern
      const {x,y} = this._getPos(e);
      this.drawing = true;
      this.ctx.beginPath();
      this.ctx.moveTo(x,y);
    };
    const move = (e) => {
      if (!this.drawing) return;
      e.preventDefault();
      const {x,y} = this._getPos(e);
      this.ctx.lineTo(x,y);
      this.ctx.stroke();
    };
    const end = (e) => {
      if (!this.drawing) return;
      e?.preventDefault?.();
      this.drawing = false;
      this.ctx.closePath();
    };

    c.addEventListener("mousedown", start);
    c.addEventListener("mousemove", move);
    window.addEventListener("mouseup", end);
    c.addEventListener("touchstart", start, {passive:false});
    c.addEventListener("touchmove",  move,  {passive:false});
    c.addEventListener("touchend",   end);
  }
}

// === Initialisierung + Button-Wiring ===
(() => {
  function initPad(){
    const cnv  = document.getElementById("writeCanvas");
    if (!cnv) return;

    const hint = document.getElementById("writeHint") || null;
    const pad  = new WritingPad(cnv, hint);

    const q = (id) => document.getElementById(id);
    const kanaEl  = q("wp-current-kana");
    const kanjiEl = q("wp-current-kanji");

    q("wp-width") && q("wp-width").addEventListener("input", e => pad.setWidth(e.target.value));
    q("wp-clear") && q("wp-clear").addEventListener("click", () => pad.clear());
    q("wp-undo")  && q("wp-undo") .addEventListener("click", () => pad.undo());
    q("wp-kana")  && q("wp-kana") .addEventListener("click", () => pad.setHintChar(kanaEl?.textContent || ""));
    q("wp-kanji") && q("wp-kanji").addEventListener("click", () => pad.setHintChar(kanjiEl?.textContent || ""));
  }

  // global verfügbar
  window.setupWritingPad = initPad;

  // Einmal beim Laden probieren (falls Pad schon im DOM ist)
  window.addEventListener("load", () => initPad());

  // SPA-Sicherheitsnetz: wenn #app neu rendert und das Pad auftaucht → initialisieren
  const app = document.getElementById("app");
  if (app) {
    const mo = new MutationObserver(() => {
      if (document.getElementById("writeCanvas")) {
        // doppelte Initialisierung vermeiden
        if (!document.getElementById("writeCanvas").__wpInit) {
          document.getElementById("writeCanvas").__wpInit = true;
          initPad();
        }
      }
    });
    mo.observe(app, { childList: true, subtree: true });
  }

  // Kompatibilität: alter Name
  window.initWritingPad = () => window.setupWritingPad();
})();

function setupWritingPad() {
  const canvas = document.getElementById("writeCanvas");
  const widthInput = document.getElementById("wp-width");
  const btnKana = document.getElementById("wp-kana");
  const btnKanji = document.getElementById("wp-kanji");
  const btnUndo = document.getElementById("wp-undo");
  const btnClear = document.getElementById("wp-clear");
  const hint = document.getElementById("writeHint");
  const kanaSpan  = document.getElementById("wp-current-kana");
  const kanjiSpan = document.getElementById("wp-current-kanji");

  if (!canvas || !widthInput || !btnKana || !btnKanji || !btnUndo || !btnClear || !hint) return;

  // — Canvas DPI-Scaling & Größe —
  const ctx = canvas.getContext("2d");
  function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    // CSS-Größen aus den Styles auslesen
    const cssWidth  = canvas.clientWidth;
    const cssHeight = canvas.clientHeight;
    canvas.width  = Math.max(1, Math.floor(cssWidth  * dpr));
    canvas.height = Math.max(1, Math.floor(cssHeight * dpr));
    ctx.scale(dpr, dpr);
    redraw(); // nach Resize neu zeichnen
  }

// — Zeichenstate —
let drawing = false;
// lastX/lastY bleiben für Kompatibilität erhalten, werden aber nicht mehr für die Linie genutzt
let lastX = 0, lastY = 0;
let lineWidth = parseInt(widthInput.value, 10) || 10; // etwas dickerer Default
let undoStack = [];
const MAX_UNDO = 30;

// Kalligrafie: State & Konstanten
let points = [];          // gespeicherte Punkte {x,y,t,pressure}
let lastMid = null;       // letzter Mittelpunkt für den Spline
let velEma = 0;           // geglättete Geschwindigkeit
const EMA_ALPHA = 0.25;   // Glättung (0..1) – höher = reaktiver
const SPEED_NORM = 2.2;   // skaliert die Wirkung von speed auf die Dicke
const MOVE_EPS = 0.6;     // minimale Bewegung, bevor gezeichnet wird

function pushSnapshot() {
  // Speichert ein ImageData in Gerätepixeln (Canvasgröße)
  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
  if (undoStack.length >= MAX_UNDO) undoStack.shift();
  undoStack.push(img);
}

function restore(img) {
  ctx.putImageData(img, 0, 0);
}

function redraw() {
  // aktuell keine Vektorpfade gespeichert → nur Canvas beibehalten
  // (Auf Resize wird das Canvas geleert; hier könntest du auf Wunsch ein Raster o.ä. zeichnen)
}

// — Helpers —
function now() { return (typeof performance !== "undefined" ? performance.now() : Date.now()); }
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
function midpoint(a,b){ return { x:(a.x+b.x)/2, y:(a.y+b.y)/2 }; }

// — Events Zeichnen (Maus + Touch/Pen via PointerEvents) —
function pointerPos(e) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top,
    t: now(),
    pressure: e.pressure ?? 0
  };
}

// Strichdicke stabil berechnen (kalligrafieähnlich)
function computeWidth(speed, pressure=0) {
  // Geschwindigkeit glätten
  velEma = EMA_ALPHA * speed + (1 - EMA_ALPHA) * velEma;

  // Basisbreite vom Slider (kannst du über #wp-width ändern)
  const base = lineWidth;

  // schneller -> dünner, langsamer -> dicker
  let factor = 1.3 - Math.min(velEma / SPEED_NORM, 1); // 1.3..0.3

  // optional Druck (bei Stiften) leicht einbeziehen
  if (pressure > 0) factor *= (0.85 + pressure * 0.3);

  // Grenzen setzen und etwas „kräftiger“ zulassen
  return Math.max(1, Math.min(base * factor, base * 1.6));
}

function startDraw(e) {
  e.preventDefault();
  pushSnapshot(); // für Undo
  drawing = true;

  // Reset Kalligrafie-States
  points = [];
  velEma = 0;
  lastMid = null;

  const p = pointerPos(e);
  points.push(p);
  lastX = p.x; lastY = p.y; // nur noch informativ

  // Pfad vorbereiten – noch nichts zeichnen, bis echte Bewegung da ist
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.strokeStyle = "#fff"; // weiße Linie
}

function moveDraw(e) {
  if (!drawing) return;

  const p = pointerPos(e);
  const prev = points[points.length - 1];
  points.push(p);

  // zu kleine Schritte ignorieren (verhindert Startknubbel)
  if (dist(p, prev) < MOVE_EPS) return;

  // Geschwindigkeit (px/ms)
  const dt = Math.max(1, p.t - prev.t);
  const speed = dist(p, prev) / dt;

  // Midpoint-Spline: Segment glatt zwischen Mittelpunkten zeichnen
  const mid = midpoint(prev, p);
  const control = prev; // quadratic control point

  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.strokeStyle = "#fff";
  ctx.globalAlpha = 1.0; // keine Transparenz-Flackerei
  ctx.lineWidth = computeWidth(speed, p.pressure);

  if (!lastMid) {
    // beim ersten echten Schritt nur Referenz setzen
    lastMid = mid;
  } else {
    ctx.beginPath();
    ctx.moveTo(lastMid.x, lastMid.y);
    ctx.quadraticCurveTo(control.x, control.y, mid.x, mid.y);
    ctx.stroke();
    lastMid = mid;
  }

  lastX = p.x; lastY = p.y;
}

function endDraw() {
  if (!drawing) return;
  drawing = false;

  // Einzelpunkt (Tap) sichtbar machen
  if (points.length === 1) {
    const p = points[0];
    ctx.beginPath();
    ctx.arc(p.x, p.y, Math.max(1, lineWidth * 0.5), 0, Math.PI * 2);
    ctx.fillStyle = "#fff";
    ctx.fill();
  }

  points = [];
  lastMid = null;
}

// Event-Bindings (wie gehabt)
canvas.addEventListener("pointerdown", startDraw);
canvas.addEventListener("pointermove", moveDraw);
window.addEventListener("pointerup", endDraw);
window.addEventListener("pointercancel", endDraw);
window.addEventListener("blur", endDraw);

// Falls du den Breiten-Slider hast, stelle sicher, dass lineWidth live aktualisiert:
widthInput.addEventListener("input", () => {
  lineWidth = parseInt(widthInput.value, 10) || lineWidth;
});

  // — Buttons / Controls —
  widthInput.addEventListener("input", () => {
    lineWidth = parseInt(widthInput.value, 10) || 6;
  });

  btnClear.addEventListener("click", () => {
    pushSnapshot();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  btnUndo.addEventListener("click", () => {
    const img = undoStack.pop();
    if (img) restore(img);
  });

  btnKana.addEventListener("click", () => {
    const ch = (kanaSpan?.textContent || "").trim();
    hint.textContent = ch;
  });

  btnKanji.addEventListener("click", () => {
    const ch = (kanjiSpan?.textContent || "").trim();
    hint.textContent = ch;
  });

  // Erstinitialisierung
  resizeCanvas();
  // Beim Resize erneut korrekt skalieren
  let resizeRaf = null;
  window.addEventListener("resize", () => {
    if (resizeRaf) cancelAnimationFrame(resizeRaf);
    resizeRaf = requestAnimationFrame(() => {
      // Canvas zurücksetzen: Transform darf nicht kumulieren
      ctx.setTransform(1,0,0,1,0,0);
      resizeCanvas();
    });
  });
}

// ===== Reusable WritePad =====
function mountWritePad(mount, { kana = "", kanji = "" } = {}){
  mount.innerHTML = `
    <section class="write-pad" style="margin-top:1rem;">
      <div class="write-pad-controls">
        <button id="wp-kana" type="button">Kana</button>
        <button id="wp-kanji" type="button">Kanji</button>
        <button id="wp-undo" type="button">Undo</button>
        <button id="wp-clear" type="button">Löschen</button>
        <label for="wp-width" class="sr-only">Strichbreite</label>
        <input id="wp-width" type="range" min="2" max="30" value="10">
      </div>
      <div class="write-pad-stage">
        <canvas id="writeCanvas"></canvas>
        <div id="writeHint" aria-hidden="true"></div>
      </div>
      <span id="wp-current-kana" hidden></span>
      <span id="wp-current-kanji" hidden></span>
    </section>
  `;

  // Hinweis-Setup
  const hint = $("#writeHint", mount);
  const kanaSpan  = $("#wp-current-kana", mount);
  const kanjiSpan = $("#wp-current-kanji", mount);
  kanaSpan.textContent  = kana || "";
  kanjiSpan.textContent = kanji || "";
  hint.style.transition = "opacity 120ms ease";
  const setHintChar = (t) => { hint.textContent = (t||"").trim(); hint.style.opacity = t ? 0.25 : 0; };
  let activeHint = null;

  $("#wp-kana", mount)?.addEventListener("click", () => {
    const ch = (kanaSpan.textContent || "").trim();
    activeHint = (activeHint === "kana") ? (setHintChar(""), null) : (setHintChar(ch), "kana");
  });
  $("#wp-kanji", mount)?.addEventListener("click", () => {
    const ch = (kanjiSpan.textContent || "").trim();
    activeHint = (activeHint === "kanji") ? (setHintChar(""), null) : (setHintChar(ch), "kanji");
  });

  // Canvas-Zeichnen (einfach gehalten – du kannst hier deine existierende setupWritingPad() einhängen)
  const canvas = $("#writeCanvas", mount);
  const ctx = canvas.getContext("2d");
  const widthCtl = $("#wp-width", mount);
  let drawing = false, last = null, strokeW = +widthCtl.value || 10, stack = [];

  function resize(){ // responsive
    const r = canvas.getBoundingClientRect();
    const tmp = document.createElement("canvas");
    tmp.width = canvas.width; tmp.height = canvas.height;
    tmp.getContext("2d").drawImage(canvas, 0, 0);
    canvas.width = r.width * devicePixelRatio;
    canvas.height = r.height * devicePixelRatio;
    ctx.scale(devicePixelRatio, devicePixelRatio);
    ctx.drawImage(tmp, 0, 0, r.width, r.height);
  }
  const ro = new ResizeObserver(resize); ro.observe(canvas.parentElement);

  function line(a,b){
    ctx.lineCap = "round"; ctx.lineJoin = "round";
    ctx.lineWidth = strokeW; ctx.strokeStyle = "#fff";
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  }
  function pos(e){
    const r = canvas.getBoundingClientRect();
    const x = (e.touches?.[0]?.clientX ?? e.clientX) - r.left;
    const y = (e.touches?.[0]?.clientY ?? e.clientY) - r.top;
    return {x,y};
  }

  function snapshot(){ const img = document.createElement("canvas"); const r = canvas.getBoundingClientRect();
    img.width = r.width; img.height = r.height; img.getContext("2d").drawImage(canvas,0,0,r.width,r.height); stack.push(img); if (stack.length>50) stack.shift();
  }

  canvas.addEventListener("pointerdown", e => { snapshot(); drawing=true; last=pos(e); canvas.setPointerCapture(e.pointerId); });
  canvas.addEventListener("pointermove", e => { if(!drawing) return; const p=pos(e); line(last,p); last=p; });
  canvas.addEventListener("pointerup",   e => { drawing=false; last=null; });

  canvas.addEventListener("touchstart", e => e.preventDefault(), {passive:false});
  canvas.addEventListener("touchmove",  e => e.preventDefault(), {passive:false});

  $("#wp-undo", mount)?.addEventListener("click", () => {
    const r = canvas.getBoundingClientRect();
    const prev = stack.pop(); if(!prev) return;
    ctx.clearRect(0,0,r.width,r.height);
    ctx.drawImage(prev, 0, 0, r.width, r.height);
  });
  $("#wp-clear", mount)?.addEventListener("click", () => {
    const r = canvas.getBoundingClientRect(); snapshot(); ctx.clearRect(0,0,r.width,r.height);
  });
  widthCtl?.addEventListener("input", e => { strokeW = +e.target.value || 10; });

  // Initial
  requestAnimationFrame(resize);

  // Extern nutzbar: Vokabelnhinweis updaten
  return {
    setVocab({kana, kanji}){ kanaSpan.textContent = kana||""; kanjiSpan.textContent = kanji||""; if(activeHint==="kana") setHintChar(kana||""); if(activeHint==="kanji") setHintChar(kanji||""); }
  };
}

function renderWriteStandalone(mount){
if (typeof window.state !== "object") window.state = {};
if (!state.write) state.write = { items: [], i: 0, target: "kana" }; // "kana" | "kanji"

  mount.innerHTML = `
    <h2>Schreibübung</h2>

    <div class="card" style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
      <div style="display:flex; gap:8px; align-items:center;">
       <input id="wImport" type="file" accept=".xlsx,.xls,.csv" style="position:absolute; left:-9999px;">
<label id="wImportBtn" for="wImport" title="Wörter aus XLSX/CSV importieren" class="btn">Import</label>
        <button id="wp-random">Zufällig</button>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="wPrev">⟵</button>
        <span id="wPos" style="min-width:4ch; text-align:center; opacity:.7;">–/–</span>
        <button id="wNext">⟶</button>
        <label style="margin-left:12px; display:flex; gap:.4rem; align-items:center;">
          Ziel:
          <select id="wTarget">
            <option value="kana">Kana</option>
            <option value="kanji">Kanji</option>
          </select>
        </label>
        <button id="wp-hint">Hint an/aus</button>
        <button id="wClear">Canvas leeren</button>
      </div>
    </div>

    <div class="write-layout" style="margin-top:12px;">
  <div id="write-standalone"></div>
  <aside id="write-prompt" class="card" style="padding:16px; min-height:240px;">
    <div id="wp-de" style="font-size:.9rem; opacity:.85; margin-bottom:6px;"></div>
    <div id="wp-romaji" style="font-size:.9rem; opacity:.75; margin-bottom:12px;"></div>
    <div id="wp-big" style="font-size: clamp(48px, 6vw, 84px); line-height:1; letter-spacing:.03em;"></div>
  </aside>
</div>
  `;

  // 1) Pad mounten (kein eigenes Eingabeformular)
  const pad = mountWritePad($("#write-standalone"), { kana:"", kanji:"" });

  // Flag, ob Hint sichtbar ist (wir toggeln zwischen kana/kanji entsprechend target)
  let hintOn = false;

  // 2) Hilfsfunktionen
 function curItem(){
  return state.write.items?.[state.write.i] || { de:"", romaji:"", kana:"", kanji:"" };
}

  function updatePrompt(){
  const box = document.getElementById("write-prompt");
  const deEl = document.getElementById("wp-de");
  const roEl = document.getElementById("wp-romaji");
  const bigEl = document.getElementById("wp-big");
  if (!box || !deEl || !roEl || !bigEl) { console.warn("write-prompt elements not found"); return; }

  const it = curItem();
  // defensiv casten
  const de     = (it.de     ?? "").toString();
  const romaji = (it.romaji ?? "").toString();
  const kana   = (it.kana   ?? "").toString();
  const kanji  = (it.kanji  ?? "").toString();

  deEl.textContent = de || "—";
  roEl.textContent = romaji || "—";

  const targetWord = (state.write.target === "kanji" ? kanji : kana).trim();
  bigEl.textContent = targetWord || " "; // Leerzeichen hält die Box offen
  box.dataset.empty = targetWord ? "0" : "1";

  // Canvas-Hints synchron halten
  try { pad.setVocab({ kana, kanji }); } catch(e){}
}

function loadIndex(i){
  if (!Array.isArray(state.write.items) || !state.write.items.length) {
    state.write.i = 0;
    document.getElementById("wPos").textContent = "–/–";
  } else {
    const n = state.write.items.length;
    state.write.i = ((i % n) + n) % n;
    document.getElementById("wPos").textContent = (state.write.i + 1) + "/" + n;
  }
  updatePrompt();

  // ✨ Canvas automatisch leeren, wenn neues Wort geladen wird
  const clearBtn = document.querySelector("#write-standalone #wp-clear");
  if (clearBtn) clearBtn.click();
}

// --- Import: Label triggert <input type="file"> ---
document.getElementById("wImport").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  try {
    const name = file.name.toLowerCase();
    let items = [];
    if (name.endsWith(".csv")) {
      items = await parseCSVFile(file);
    } else if (name.endsWith(".xlsx") || name.endsWith(".xls")) {
      if (typeof XLSX === "undefined") {
        alert("Für XLSX-Import bitte die XLSX-Bibliothek einbinden.");
        return;
      }
      items = await parseXLSXFile(file);
    } else {
      alert("Bitte .csv, .xlsx oder .xls wählen.");
      return;
    }

    // falls du die tolerante Normalisierung nutzt:
    items = (items || []).map(normalizeRow).filter(Boolean);

    const usable = items.filter(r => (r.kana && r.kana.trim()) || (r.kanji && r.kanji.trim()));
    if (!usable.length) {
      alert("Import ok, aber keine Einträge mit 'kana' oder 'kanji' gefunden.");
      return;
    }

    // ✅ hier knallt es vorher – jetzt sicher:
    state.write.items = usable;
    state.write.i = 0;

    // Anzeige aktualisieren
    loadIndex(0);
  } catch (err) {
    console.error(err);
    alert("Import fehlgeschlagen: " + (err?.message || err));
  } finally {
    e.target.value = ""; // reset
  }
});

function curItem(){
  state.write ||= { items: [], i: 0, target: "kana" };
  return state.write.items[state.write.i] || { de:"", romaji:"", kana:"", kanji:"" };
}

  function loadIndex(i){
    if (!state.write.items.length){ state.write.i = 0; }
    else {
      state.write.i = ( (i % state.write.items.length) + state.write.items.length ) % state.write.items.length;
    }
    $("#wPos").textContent = state.write.items.length ? ((state.write.i+1)+"/"+state.write.items.length) : "–/–";
    updatePrompt();
  }

  // 3) Events
  $("#wTarget").value = state.write.target;
  $("#wTarget").onchange = (e) => { state.write.target = e.target.value; updatePrompt(); };

  $("#wp-hint").onclick = () => { hintOn = !hintOn; updatePrompt(); };
  $("#wClear").onclick  = () => { $("#write-standalone #wp-clear")?.click(); };

  $("#wPrev").onclick = () => loadIndex(state.write.i - 1);
  $("#wNext").onclick = () => loadIndex(state.write.i + 1);
  $("#wp-random").onclick = () => { if(state.write.items.length){ loadIndex( Math.floor(Math.random()*state.write.items.length) ); } };

  $("#wImport").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  try{
    let items = [];
    const name = file.name.toLowerCase();
    if (name.endsWith(".csv")) {
      items = await parseCSVFile(file);
    } else if (name.endsWith(".xlsx") || name.endsWith(".xls")) {
      if (typeof XLSX === "undefined") {
        alert("Für XLSX-Import bitte die XLSX-Bibliothek einbinden (siehe unten). CSV funktioniert ohne.");
        return;
      }
      items = await parseXLSXFile(file);
    } else {
      alert("Bitte .csv, .xlsx oder .xls wählen.");
      return;
    }
    if (!items.length) { alert("Keine Einträge gefunden (Spalten: de, romaji, kana, kanji)."); return; }
    state.write.items = items;
    loadIndex(0);
  } catch(err){
    console.error(err);
    alert("Import fehlgeschlagen: " + (err?.message || err));
  } finally {
    e.target.value = ""; // reset fürs nächste Mal
  }
});

  // 4) Start
  loadIndex(state.write.i || 0);
}

// Erwartete Spaltennamen (case-insensitive): de, romaji, kana, kanji
function normalizeRow(obj){
  if (!obj || typeof obj !== "object") return null;
  const m = {};
  for (const k in obj) {
    if (!Object.hasOwn(obj, k)) continue;
    const key = (k || "").toString().trim().toLowerCase();
    m[key] = (obj[k] ?? "").toString().trim();
  }

  const pick = (...keys) => {
    for (const key of keys) if (m[key]) return m[key];
    return "";
  };

  const de     = pick("de", "deutsch", "bedeutung", "deutsch/meaning");
  const romaji = pick("romaji", "rōmaji", "roumaji", "roomaji");
  const kana   = pick("kana", "kana wort", "kana-wort");
  const kanji  = pick("kanji", "kanji wort", "kanji-wort", "zeichen");

  if (!(de || romaji || kana || kanji)) return null;
  return { de, romaji, kana, kanji };
}


async function parseXLSXFile(file){
  if (typeof XLSX === "undefined") throw new Error("XLSX-Bibliothek nicht geladen.");
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, { type: "array" });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws, { defval:"" });
  const list = [];
  for (const r of rows){ const n = normalizeRow(r); if(n) list.push(n); }
  return list;
}

async function parseCSVFile(file){
  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(l => l.trim().length);
  if (!lines.length) return [];
  const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
  const idx = {
    de: headers.findIndex(h => ["de","deutsch"].includes(h)),
    romaji: headers.findIndex(h => ["romaji","roumaji","roomaji"].includes(h)),
    kana: headers.findIndex(h => h==="kana"),
    kanji: headers.findIndex(h => h==="kanji"),
  };
  const list = [];
  for (let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    const row = {
      de:     idx.de     >=0 ? (cols[idx.de]||"").trim()     : "",
      romaji: idx.romaji >=0 ? (cols[idx.romaji]||"").trim() : "",
      kana:   idx.kana   >=0 ? (cols[idx.kana]||"").trim()   : "",
      kanji:  idx.kanji  >=0 ? (cols[idx.kanji]||"").trim()  : "",
    };
    const n = normalizeRow(row); if(n) list.push(n);
  }
  return list;
}

function splitCSVLine(line){
  const out = []; let cur=""; let q=false;
  for (let i=0;i<line.length;i++){
    const c=line[i];
    if (c === '"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else { q=!q; } }
    else if (c === ',' && !q){ out.push(cur); cur=""; }
    else { cur+=c; }
  }
  out.push(cur);
  return out;
}

  </script>



</body>
</html>








